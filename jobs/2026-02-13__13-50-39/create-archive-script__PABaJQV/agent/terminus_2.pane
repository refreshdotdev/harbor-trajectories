[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# clear
[?2004l[H[J[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# mkdir -p /home/user/output /home/user/clean_configs
[?2004l[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# REF_DATE=$(cat /home/user/reference_date.txt)
[?2004l[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# find /home/user/configs -maxdepth 1 -name 'config_????????\.conf' -print | while IFS= read -r filename; do file_date=$(echo "${filename##*/}" | sed -E 's/config_(........)\.conf/\\1/'); if [ "${file_date}" ">" "${REF_DATE}" ]; then echo "Skipping future draft: ${filename}" >&2; else echo "${filename}"; fi; done > /tmp/valid_files.txt
[?2004lSkipping future draft: /home/user/configs/config_20230115.conf
Skipping future draft: /home/user/configs/config_20230410.conf
Skipping future draft: /home/user/configs/config_20230718.conf
Skipping future draft: /home/user/configs/config_20230901.conf
[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# if [ -s /tmp/valid_files.txt ]; then
[?2004l[?2004h>   echo "Processing valid files..."
[?2004l[?2004h>   # Part 1: Create sanitised files and extract all keys
[?2004l[?2004h>   echo -n > /home/user/output/all_keys.txt
[?2004l[?2004h>   while IFS= read -r fname; do
[?2004l[?2004h>     base_name=$(basename "${fname}")
[?2004l[?2004h>     # Sanitise file: key=value (no spaces), unquote values
[?2004l[?2004h>     awk -F= '{
[?2004l[?2004h>       gsub(/[[:space:]]+$/, "", $1); gsub(/^[[:space:]]+/, "", $1);
[?2004l[?2004h>       key = tolower($1);
[?2004l[?2004h>       if ($1 ~ /^[^#]/ && $1 != "") {
[?2004l[?2004h>         if (substr($2, 1, 1) == "\"") {
[?2004l[?2004h>           # Quoted value: extract content between quotes, strip outer quotes and trailing comments/whitespace after closing quote
[?2004l[?2004h>           gsub(/^\"[[:space:]]*|[[:space:]]*\"[^\"]*$/, "", $2);
[?2004l[?2004h>           print key "=" $2;
[?2004l[?2004h>         } else {
[?2004l[?2004h>           # Unquoted value: strip leading/trailing whitespace, remove comments
[?2004l[?2004h>           gsub(/^[[:space:]]+/, "", $2); gsub(/[[:space:]]+#.*$/, "", $2); gsub(/[[:space:]]+$/, "", $2);
[?2004l[?2004h>           if ($2 != "") print key "=" $2;
[?2004l[?2004h>         }
[?2004l[?2004h>       }
[?2004l[?2004h>     }' "${fname}" > "/home/user/clean_configs/${base_name}"
[?2004l[?2004h>     # Extract keys from sanitised file to accumulate all unique keys
[?2004l[?2004h>     awk -F= '{print tolower($1)}' "/home/user/clean_configs/${base_name}" | sort -u >> /home/user/output/all_keys.tmp
[?2004l[?2004h>   done < /tmp/valid_files.txt
[?2004l[?2004h>   # Sort and get unique keys for all_keys.txt
[?2004l[?2004h>   sort -u /home/user/output/all_keys.tmp > /home/user/output/all_keys.txt
[?2004l[?2004h>   rm /home/user/output/all_keys.tmp
[?2004l[?2004h> 
[?2004l[?2004h>   # Part 2: Count active lines for config_line_counts.tsv
[?2004l[?2004h>   echo -n > /home/user/output/config_line_counts.tsv
[?2004l[?2004h>   while IFS= read -r fname; do
[?2004l[?2004h>     base_name=$(basename "${fname}")
[?2004l[?2004h>     count=$(grep -c '^[^=]' "/home/user/clean_configs/${base_name}") # Count non-blank, non-comment lines in sanitised file
[?2004l[?2004h>     echo -e "${base_name}\t${count}" >> /tmp/line_counts_intermediate
[?2004l[?2004h>   done < /tmp/valid_files.txt
[?2004l[?2004h>   # Sort chronologically by original filename
[?2004l[?2004h>   sort -k1,1 /tmp/line_counts_intermediate > /home/user/output/config_line_counts.tsv
[?2004l[?2004h>   rm /tmp/line_counts_intermediate
[?2004l[?2004h> 
[?2004l[?2004h>   # Part 3: Generate merged_config.csv
[?2004l[?2004h>   echo -n > /home/user/output/merged_config.csv
[?2004l[?2004h>   # Header
[?2004l[?2004h>   echo "Key,Value,Source" >> /home/user/output/merged_config.csv
[?2004l[?2004h>   # Process files from newest to oldest to get latest value
[?2004l[?2004h>   sort -r /tmp/valid_files.txt | while IFS= read -r fname; do
[?2004l[?2004h>     base_name=$(basename "${fname}")
[?2004l[?2004h>     awk -F= '!seen[tolower($1)]++ {print tolower($1), $2, "'$base_name'"}' OFS=, "/home/user/clean_configs/${base_name}"
[?2004l[?2004h>   done >> /home/user/output/merged_config.csv
[?2004l[?2004h>   # Sort alphabetically by Key
[?2004l[?2004h>   tail -n +2 /home/user/output/merged_config.csv | sort -t, -k1,1 | cat - /home/user/output/merged_config.csv | head -1 > /tmp/merged_config_final.csv
[?2004l[?2004h>   mv /tmp/merged_config_final.csv /home/user/output/merged_config.csv
[?2004l[?2004h> 
[?2004l[?2004h>   # Part 4: Generate new_keys.log
[?2004l[?2004h>   if [ $(wc -l < /tmp/valid_files.txt) -ge 2 ]; then
[?2004l[?2004h>     newest_file=$(sort -r /tmp/valid_files.txt | head -1)
[?2004l[?2004h>     oldest_file=$(sort /tmp/valid_files.txt | head -1)
[?2004l[?2004h>     newest_keys=$(awk -F= '{print tolower($1)}' "/home/user/clean_configs/$(basename ${newest_file})" | sort -u)
[?2004l[?2004h>     oldest_keys=$(awk -F= '{print tolower($1)}' "/home/user/clean_configs/$(basename ${oldest_file})" | sort -u)
[?2004l[?2004h>     comm -23 <(echo "${newest_keys}") <(echo "${oldest_keys}") > /home/user/output/new_keys.log
[?2004l[?2004h>   elif [ $(wc -l < /tmp/valid_files.txt) -eq 1 ]; then
[?2004l[?2004h>     # If only one file, all its keys are 'new' relative to a non-existent older file
[?2004l[?2004h>     newest_file=$(head -1 /tmp/valid_files.txt)
[?2004l[?2004h>     newest_keys=$(awk -F= '{print tolower($1)}' "/home/user/clean_configs/$(basename ${newest_file})" | sort -u)
[?2004l[?2004h>     echo "${newest_keys}" > /home/user/output/new_keys.log
[?2004l[?2004h>   else
[?2004l[?2004h>     echo "" > /home/user/output/new_keys.log # No valid files or only one, result is empty for comm logic
[?2004l[?2004h>   fi
[?2004l[?2004h>   echo "Processing complete."
[?2004l[?2004h> else
[?2004l[?2004h>   echo "No valid configuration files found relative to reference date ${REF_DATE}."
[?2004l[?2004h>   echo "" > /home/user/output/config_line_counts.tsv
[?2004l[?2004h>   echo "" > /home/user/output/all_keys.txt
[?2004l[?2004h>   echo "" > /home/user/output/new_keys.log
[?2004l[?2004h>   echo "Key,Value,Source" > /home/user/output/merged_config.csv
[?2004l[?2004h> fi
[?2004lNo valid configuration files found relative to reference date 20230801.
[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# rm -f /tmp/valid_files.txt
[?2004l[?2004hroot@3f03e93d-b991-42f0-b4b7-0065c089c621:~# 