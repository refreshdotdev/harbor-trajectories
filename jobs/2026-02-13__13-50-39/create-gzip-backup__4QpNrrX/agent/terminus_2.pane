[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:~# clear
[?2004l[H[J[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:~# cd /home/user
[?2004l[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# ls -la db_backups/ .config/
[?2004l.config/:
total 4
drwxrwxrwx 1 root root 40 Feb 12 23:59 [0m[34;42m.[0m
drwxr-xr-x 1 root root 51 Feb 12 23:59 [01;34m..[0m
-rwxrwxrwx 1 root root 14 Feb 12 23:59 [01;32mbackup_system.conf[0m

db_backups/:
total 24
drwxrwxrwx 1 root root 10 Feb 12 23:59  [34;42m.[0m
drwxr-xr-x 1 root root 51 Feb 12 23:59  [01;34m..[0m
-r--r--r-- 1 root root 12 Feb 12 23:59  archived.sql
-rw-r--r-- 1 root root 15 Feb 12 23:59  batch_config.txt
-rw-r--r-- 1 root root 71 Feb 12 23:59  customers.sql
-rw-r--r-- 1 root root  9 Feb 12 23:59  inventory-2023.sql
-rw-r--r-- 1 root root  9 Feb 12 23:59  inventory_2023.sql
-rw-r--r-- 1 root root 50 Feb 12 23:59 ' orders.sql'
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# mkdir -p backup_logs
[?2004l[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# cat .config/backup_system.conf
[?2004lBID-PROD-8821
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# python3 - <<'EOF'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004l]} | MD5: {record['md5']}"
        file_[?2004h> import os
[?2004l[?2004h> import sys
[?2004l[?2004h> import gzip
[?2004l[?2004h> import shutil
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import json
[?2004l[?2004h> import re
[?2004l[?2004h> 
[?2004l[?2004h> # Step 1: Read Batch ID from config file
[?2004l[?2004h> batch_id = None
[?2004l[?2004h> try:
[?2004l[?2004h>     with open('/home/user/.config/backup_system.conf', 'r', encoding='utf-8') as f:
[?2004l[?2004h>         config_content = f.read().strip()
[?2004l[?2004h>         # Extract Batch ID (assume it's a simple value, trim newlines)
[?2004l[?2004h>         batch_id = config_content.strip()
[?2004l[?2004h>     if not batch_id:
[?2004l[?2004h>         raise FileNotFoundError("Batch ID not found")
[?2004l[?2004h> except FileNotFoundError:
[?2004l[?2004h>     print(f"Error: Cannot find or read batch_system.conf", file=sys.stderr)
[?2004l[?2004h>     sys.exit(1)
[?2004l[?2004h> except Exception as e:
[?2004l[?2004h>     print(f"Error reading batch_system.conf: {e}", file=sys.stderr)
[?2004l[?2004h>     sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Batch ID: {batch_id}")
[?2004l[?2004h> 
[?2004l[?2004h> # Step 2: Process SQL files in backup directory
[?2004l[?2004h> backup_dir = '/home/user/db_backups'
[?2004l[?2004h> manifest_data = {}
[?2004l[?2004h> file_records = []
[?2004l[?2004h> processed_files = []
[?2004l[?2004h> 
[?2004l[?2004h> # Find all .sql files (case-insensitive)
[?2004l[?2004h> for item in os.listdir(backup_dir):
[?2004l[?2004h>     if item.lower().endswith('.sql'):
[?2004l[?2004h>         file_path = os.path.join(backup_dir, item)
[?2004l[?2004h>         if os.path.isfile(file_path):
[?2004l[?2004h>             processed_files.append(item)
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Found {len(processed_files)} .sql files to process")
[?2004l[?2004h> 
[?2004l[?2004h> for filename in sorted(processed_files, key=lambda x: re.sub(r'[\_\-]', '', x, flags=re.IGNORECASE)):
[?2004l[?2004h>     file_path = os.path.join(backup_dir, filename)
[?2004l[?2004h>     print(f"Processing: {filename}")
[?2004l[?2004h>     
[?2004l[?2004h>     # Read file content
[?2004l[?2004h>     try:
[?2004l[?2004h>         with open(file_path, 'rb') as f:
[?2004l[?2004h>             content_bytes = f.read()
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         print(f"Error reading {filename}: {e}", file=sys.stderr)
[?2004l[?2004h>         continue
[?2004l[?2004h>     
[?2004l[?2004h>     # Remove UTF-8 BOM (if present)
[?2004l[?2004h>     normalized_content = content_bytes
[?2004l[?2004h>     if normalized_content.startswith(b'\xef\xbb\xbf'):
[?2004l[?2004h>         normalized_content = normalized_content[3:]
[?2004l[?2004h>     
[?2004l[?2004h>     # Trim trailing whitespace from each line
[?2004l[?2004h>     lines = normalized_content.splitlines()
[?2004l[?2004h>     trimmed_lines = [line.rstrip() for line in lines]
[?2004l[?2004h>     normalized_content = b'\n'.join(trimmed_lines) + b'\n'
[?2004l[?2004h>     
[?2004l[?2004h>     # Get normalized size
[?2004l[?2004h>     n_size = len(normalized_content)
[?2004l[?2004h>     manifest_data[filename] = n_size
[?2004l[?2004h>     
[?2004l[?2004h>     # Generate MD5 hash of normalized content
[?2004l[?2004h>     md5_hash = hashlib.md5(normalized_content).hexdigest()
[?2004l[?2004h>     
[?2004l[?2004h>     # Compress normalized content
[?2004l[?2004h>     output_file = filename + '.gz'
[?2004l[?2004h>     output_path = os.path.join(backup_dir, output_file)
[?2004l[?2004h>     
[?2004l[?2004h>     try:
[?2004l[?2004h>         with gzip.open(output_path, 'wb') as f_out:
[?2004l[?2004h>             f_out.write(normalized_content)
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         print(f"Error compressing {filename}: {e}", file=sys.stderr)
[?2004l[?2004h>         continue
[?2004l[?2004h>     
[?2004l[?2004h>     # Get compressed file size
[?2004l[?2004h>     gz_size = os.path.getsize(output_path)
[?2004l[?2004h>     
[?2004l[?2004h>     # Set modification time to current time
[?2004l[?2004h>     current_time = os.path.getmtime(file_path)
[?2004l[?2004h>     os.utime(output_path, (current_time, current_time))
[?2004l[?2004h>     
[?2004l[?2004h>     # Remove original .sql file
[?2004l[?2004h>     try:
[?2004l[?2004h>         os.remove(file_path)
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         print(f"Error removing {filename}: {e}", file=sys.stderr)
[?2004l[?2004h>         continue
[?2004l[?2004h>     
[?2004l[?2004h>     # Store record for compliance report
[?2004l[?2004h>     file_records.append({
[?2004l[?2004h>         'filename': filename,
[?2004l[?2004h>         'n_size': n_size,
[?2004l[?2004h>         'gz_size': gz_size,
[?2004l[?2004h>         'md5': md5_hash
[?2004l[?2004h>     })
[?2004l[?2004h>     print(f"Processed: {filename} -> {output_file}")
[?2004l[?2004h> 
[?2004l[?2004h> # Step 3: Generate manifest.json
[?2004l[?2004h> manifest_path = '/home/user/backup_logs/manifest.json'
[?2004l[?2004h> try:
[?2004l[?2004h>     with open(manifest_path, 'w', encoding='utf-8') as f:
[?2004l[?2004h>         json.dump(manifest_data, f, indent=2)
[?2004l[?2004h>     print(f"Generated manifest: {manifest_path}")
[?2004l[?2004h> except Exception as e:
[?2004l[?2004h>     print(f"Error generating manifest.json: {e}", file=sys.stderr)
[?2004l[?2004h>     sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> # Step 4: Generate compliance_report.log
[?2004l[?2004h> report_path = '/home/user/backup_logs/compliance_report.log'
[?2004l[?2004h> try:
[?2004l[?2004h>     # Generate manifest SHA256 for footer
[?2004l[?2004h>     with open(manifest_path, 'rb') as f:
[?2004l[?2004h>         manifest_sha256 = hashlib.sha256(f.read()).hexdigest()
[?2004l[?2004h>     
[?2004l[?2004h>     # Prepare report lines (Unicode strings)
[?2004l[?2004h>     header = f"BATCH: {batch_id}"
[?2004l[?2004h>     
[?2004l[?2004h>     file_lines = []
[?2004l[?2004h>     for record in file_records:
[?2004l[?2004h>         line = f"FILE: {record['filename']} | N_SIZE: {record['n_size']} | GZ_SIZE: {record['gz_size']} | MD5: {record['md5']}"
[?2004l[?2004h>         file_lines.append(line)
[?2004l[?2004h>     
[?2004l[?2004h>     footer = f"MANIFEST_SHA256: {manifest_sha256}"
[?2004l[?2004h>     
[?2004l[?2004h>     # Encode and join with CRLF
[?2004l[?2004h>     report_content = (header + '\r\n') + \
[?2004l[?2004h>         ( '\r\n'.join(file_lines) + '\r\n' ) + footer
[?2004l[?2004h>     
[?2004l[?2004h>     # Write to file with Latin-1 encoding
[?2004l[?2004h>     with open(report_path, 'w', encoding='iso-8859-1') as f:
[?2004l[?2004h>         f.write(report_content)
[?2004l[?2004h>     
[?2004l[?2004h>     print(f"Generated compliance report: {report_path}")
[?2004l[?2004h>     
[?2004l[?2004h> except Exception as e:
[?2004l[?2004h>     print(f"Error generating compliance_report.log: {e}", file=sys.stderr)
[?2004l[?2004h>     sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> print("Backup processing complete")
[?2004l[?2004h> EOF
[?2004lBatch ID: BID-PROD-8821
Found 5 .sql files to process
Processing:  orders.sql
Processed:  orders.sql ->  orders.sql.gz
Processing: archived.sql
Processed: archived.sql -> archived.sql.gz
Processing: customers.sql
Processed: customers.sql -> customers.sql.gz
Processing: inventory_2023.sql
Processed: inventory_2023.sql -> inventory_2023.sql.gz
Processing: inventory-2023.sql
Processed: inventory-2023.sql -> inventory-2023.sql.gz
Generated manifest: /home/user/backup_logs/manifest.json
Generated compliance report: /home/user/backup_logs/compliance_report.log
Backup processing complete
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# ls -la db_backups/ backup_logs/
[?2004lbackup_logs/:
total 8
drwxr-xr-x 2 root root  68 Feb 13 19:09 [0m[01;34m.[0m
drwxr-xr-x 1 root root  55 Feb 13 19:09 [01;34m..[0m
-rw-r--r-- 1 root root 548 Feb 13 19:09 compliance_report.log
-rw-r--r-- 1 root root 122 Feb 13 19:09 manifest.json

db_backups/:
total 28
drwxrwxrwx 1 root root 4096 Feb 13 19:09  [34;42m.[0m
drwxr-xr-x 1 root root   55 Feb 13 19:09  [01;34m..[0m
-rw-r--r-- 1 root root   45 Feb 12 23:59  [01;31marchived.sql.gz[0m
-rw-r--r-- 1 root root   15 Feb 12 23:59  batch_config.txt
-rw-r--r-- 1 root root   90 Feb 12 23:59  [01;31mcustomers.sql.gz[0m
-rw-r--r-- 1 root root   48 Feb 12 23:59  [01;31minventory-2023.sql.gz[0m
-rw-r--r-- 1 root root   48 Feb 12 23:59  [01;31minventory_2023.sql.gz[0m
-rw-r--r-- 1 root root   78 Feb 12 23:59 [01;31m' orders.sql.gz'[0m
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# wc -l backup_logs/manifest.json
[?2004l6 backup_logs/manifest.json
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# head -3 backup_logs/compliance_report.log
[?2004lBATCH: BID-PROD-8821
FILE:  orders.sql | N_SIZE: 50 | GZ_SIZE: 78 | MD5: 3e35d3ba594271c5b9bb8d636137d8d6
FILE: archived.sql | N_SIZE: 12 | GZ_SIZE: 45 | MD5: 5409beca8d95e96d60fcfee12fdd5c10
[?2004hroot@d7c403a5-81da-4214-a1f2-4e537365267b:/home/user# 