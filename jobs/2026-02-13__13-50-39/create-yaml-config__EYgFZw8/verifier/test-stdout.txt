============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /tests
collecting ... collected 6 items

../../tests/test_final_state.py::test_destination_files_are_correct PASSED [ 16%]
../../tests/test_final_state.py::test_config_yaml_interpolation_and_permissions PASSED [ 33%]
../../tests/test_final_state.py::test_python_script_permissions PASSED   [ 50%]
../../tests/test_final_state.py::test_manifest_correctness FAILED        [ 66%]
../../tests/test_final_state.py::test_version_file_content FAILED        [ 83%]
../../tests/test_final_state.py::test_deployment_log PASSED              [100%]

=================================== FAILURES ===================================
__________________________ test_manifest_correctness ___________________________

    def test_manifest_correctness():
        """
        manifest.txt must contain sorted SHA256 hashes of other files.
        """
        manifest_path = DST_ROOT / "manifest.txt"
        assert manifest_path.exists()
    
        lines = manifest_path.read_text().strip().splitlines()
        # Files that should be in manifest (everything except manifest itself)
        target_files = sorted(
            [p for p in DST_ROOT.iterdir() if p.is_file() and p.name != "manifest.txt"],
            key=lambda x: x.name
        )
    
        assert len(lines) == len(target_files), "Manifest line count does not match file count."
    
        for line, fpath in zip(lines, target_files):
            parts = line.split("  ")
            assert len(parts) == 2, f"Manifest line malformed: {line}"
            chk, name = parts
>           assert name == fpath.name, f"Manifest order mismatch: expected {fpath.name}, got {name}"
E           AssertionError: Manifest order mismatch: expected config.yaml, got version.txt
E           assert 'version.txt' == 'config.yaml'
E             
E             - config.yaml
E             + version.txt

/tests/test_final_state.py:91: AssertionError
__________________________ test_version_file_content ___________________________

    def test_version_file_content():
        """
        version.txt must match source exactly.
        """
>       _assert_file_contents(DST_ROOT / "version.txt", "1.1.0\n")

/tests/test_final_state.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

path = PosixPath('/home/user/iot_device/edge_app/version.txt')
expected = '1.1.0\n'

    def _assert_file_contents(path: Path, expected: str) -> None:
        assert path.exists(), f"Expected file {path} to exist."
        actual = path.read_text()
>       assert actual == expected, f"File contents mismatch for {path}."
E       AssertionError: File contents mismatch for /home/user/iot_device/edge_app/version.txt.
E       assert '1.0.0\n' == '1.1.0\n'
E         
E         - 1.1.0
E         + 1.0.0

/tests/test_final_state.py:25: AssertionError
=========================== short test summary info ============================
FAILED ../../tests/test_final_state.py::test_manifest_correctness - Assertion...
FAILED ../../tests/test_final_state.py::test_version_file_content - Assertion...
========================= 2 failed, 4 passed in 0.03s ==========================
