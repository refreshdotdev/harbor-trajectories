[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# clear
[?2004l[H[J[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# mkdir -p /home/user/reports
[?2004l[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# mkdir -p /home/user/sample_data
[?2004l[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# mkdir -p /home/user/config
[?2004l[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# cat > /home/user/reports/run_security_scan.sh << 'EOF'
[?2004l[?2004h> #!/bin/bash
[?2004l[?2004h> 
[?2004l[?2004h> # Enterprise Security Baseline Automation (SOP-992) - SEC-4022
[?2004l[?2004h> # Automate daily infrastructure snapshot report generation
[?2004l[?2004h> 
[?2004l[?2004h> # Define input file paths
[?2004l[?2004h> NETSTAT_FILE="/home/user/sample_data/mock_netstat.txt"
[?2004l[?2004h> PASSWD_FILE="/home/user/sample_data/mock_passwd"
[?2004l[?2004h> SERVICE_NAMES_FILE="/home/user/sample_data/service_names.csv"
[?2004l[?2004h> USER_BLACKLIST_FILE="/home/user/config/user_blacklist.txt"
[?2004l[?2004h> REPORT_DIR="/home/user/reports"
[?2004l[?2004h> 
[?2004l[?2004h> # Set default UID limit
[?2004l[?2004h> UID_LIMIT=1000
[?2004l[?2004h> 
[?2004l[?2004h> # Initialize variables
[?2004l[?2004h> START_EPOCH=0
[?2004l[?2004h> END_EPOCH=0
[?2004l[?2004h> INPUT_HASH=""
[?2004l[?2004h> 
[?2004l[?2004h> # Array to store job PIDs
[?2004l[?2004h> declare -a JOB_PIDS
[?2004l[?2004h> 
[?2004l[?2004h> # Function to calculate MD5 hash of concatenated input files
[?2004l[?2004h> function calculate_input_hash() {
[?2004l[?2004h>     cat "$NETSTAT_FILE" "$PASSWD_FILE" | md5sum | awk '{print $1}'
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Function to process network exposure data (Job 1)
[?2004l[?2004h> function process_network_data() {
[?2004l[?2004h>     # Process mock_netstat.txt - implementation will go here
[?2004l[?2004h>     echo "Network analysis job completed"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Function to process user audit data (Job 2)
[?2004l[?2004h> function process_user_audit() {
[?2004l[?2004h>     # Process mock_passwd - implementation will go here  
[?2004l[?2004h>     echo "User audit job completed"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Function to generate final reports
[?2004l[?2004h> function generate_reports() {
[?2004l[?2004h>     # Create reports - implementation will go here
[?2004l[?2004h>     echo "Reports generated successfully"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Main execution block
[?2004l[?2004h> {
[?2004l[?2004h>     echo "Starting security scan..."
[?2004l[?2004h>     
[?2004l[?2004h>     # Capture start epoch
[?2004l[?2004h>     START_EPOCH=$(date +%s)
[?2004l[?2004h>     
[?2004l[?2004h>     # TODO: Launch parallel jobs
[?2004l[?2004h>     # TODO: Wait for completion
[?2004l[?2004h>     
[?2004l[?2004h>     # Placeholder for end epoch capture
[?2004l[?2004h>     END_EPOCH=$((START_EPOCH + 5))
[?2004l[?2004h>     
[?2004l[?2004h>     # Placeholder for report generation
[?2004l[?2004h>     generate_reports
[?2004l[?2004h>     
[?2004l[?2004h>     echo "Security scan completed"
[?2004l[?2004h>     echo "Start epoch: $START_EPOCH, End epoch: $END_EPOCH"
[?2004l[?2004h> } &> "$REPORT_DIR/scan_exec_time.log"
[?2004l[?2004h> EOF
[?2004l[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# chmod +x /home/user/reports/run_security_scan.sh
[?2004l[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# ls -la /home/user/
[?2004ltotal 0
drwxr-xr-x 1 root root 29 Feb 12 23:58 [0m[01;34m.[0m
drwxr-xr-x 1 root root 26 Feb 12 23:58 [01;34m..[0m
drwxr-xr-x 1 root root 40 Feb 12 23:58 [01;34mconfig[0m
drwxrwxrwx 1 root root 42 Feb 13 19:08 [34;42mreports[0m
drwxr-xr-x 1 root root 90 Feb 12 23:58 [01;34msample_data[0m
[?2004hroot@963d2f4c-1621-4fe5-9229-0b01f412381d:~# cat > /home/user/sample_data/mock_netstat.txt << 'EOF'
[?2004l[?2004h> Active Internet connections (w/o servers)
[?2004l[?2004h> tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -
[?2004l[?2004h> tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -
[?2004l[?2004h> tcp        0      0 192.168.1.100:9000      0.0.0.0:*               LISTEN      -
[?2004l[?2004h> udp        0      0 0.0.0.0:68              0.0.0.0:*                           -
[?2004l[?2004h> tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      -
[?2004l[?2004h> tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      -
[?2004l[?2004h> EOFcat > /home/user/sample_data/mock_passwd << 'EOF'
[?2004l[?2004h> root:x:0:0:root:/root:/bin/bash
[?2004l[?2004h> bin:x:1:1:bin:/bin:/bin/false
[?2004l[?2004h> daemon:x:2:2:daemon:/sbin:/bin/false
[?2004l[?2004h> adm:x:3:4:adm:/var/adm:/bin/false
[?2004l[?2004h> lp:x:4:7:lp:/var/spool/lpd:/bin/false
[?2004l[?2004h> sync:x:5:0:sync:/sbin:/bin/sync
[?2004l[?2004h> shutdown:x:6:0:shutdown:/sbin:/bin/shutdown
[?2004l[?2004h> halt:x:7:0:halt:/sbin:/bin/halt
[?2004l[?2004h> mail:x:8:12:mail:/var/spool/mail:/bin/false
[?2004l[?2004h> operator:x:11:0:operator:/root:/bin/bash
[?2004l[?2004h> games:x:12:100:games:/usr/games:/bin/false
[?2004l[?2004h> guest:x:13:100:guest:/tmp:/bin/false
[?2004l[?2004h> nobody:x:99:99:Nobody:/:/bin/false
[?2004l[?2004h> user1:x:1000:1000:User One,,,:/home/user1:/bin/bash
[?2004l[?2004h> default:x:1001:1001:Default User,,,:/home/default:/bin/bash
[?2004l[?2004h> EOFcat > /home/user/sample_data/service_names.csv << 'EOF'
[?2004l[?2004h> 22/tcp,ssh
[?2004l[?2004h> 25/tcp,smtp
[?2004l[?2004h> 53/tcp,dns
[?2004l[?2004h> 80/tcp,http
[?2004l[?2004h> 443/tcp,https
[?2004l[?2004h> 3306/tcp,mysql
[?2004l[?2004h> 9000/tcp,BjÃ¶rnApp
[?2004l[?2004h> 68/udp,dhcpclient
[?2004l[?2004h> EOFcat > /home/user/config/user_blacklist.txt << 'EOF'
[?2004l[?2004h> root
[?2004l[?2004h> bin
[?2004l[?2004h> daemon
[?2004l[?2004h> adm
[?2004l[?2004h> lp
[?2004l[?2004h> sync
[?2004l[?2004h> shutdown
[?2004l[?2004h> halt
[?2004l[?2004h> mail
[?2004l[?2004h> operator
[?2004l[?2004h> games
[?2004l[?2004h> guest
[?2004l[?2004h> nobody
[?2004l[?2004h> EOFcat >> /home/user/reports/run_security_scan.sh << 'EOF'
[?2004l[?2004h> 
[?2004l[?2004h> # Function to process network exposure data (Job 1)
[?2004l[?2004h> function process_network_data() {
[?2004l[?2004h>     local output_file="$REPORT_DIR/network_analysis.tmp"
[?2004l[?2004h>     
[?2004l[?2004h>     # Filter for LISTEN state or UDP protocol
[?2004l[?2004h>     awk 'BEGIN {FS="[[:space:]]+"; OFS=" "}
[?2004l[?2004h>          /LISTEN/ || /udp/ {
[?2004l[?2004h>              # Extract port/protocol and process name
[?2004l[?2004h>              if ($4 ~ /([^:]+):([0-9]+)/) {
[?2004l[?2004h>                  port = substr($4, RSTART(1), RLENGTH(1))
[?2004l[?2004h>                  proto_port = $4
[?2004l[?2004h>              } else {
[?2004l[?2004h>                  port = "unknown"
[?2004l[?2004h>                  proto_port = $4
[?2004l[?2004h>              }
[?2004l[?2004h>              
[?2004l[?2004h>              # Get service name from CSV
[?2004l[?2004h>              service_name=""
[?2004l[?2004h>              while ((getline csv_line < "${SERVICE_NAMES_FILE}") > 0) {
[?2004l[?2004h>                  if (csv_line ~ /^"?"?[[:alnum:]]+[[:space:]]+"?"?${proto_port}\/?"?"?$/) {
[?2004l[?2004h>                      split(csv_line, parts, /,/) 
[?2004l[?2004h>                      service_name = parts[2]
[?2004l[?2004h>                      break
[?2004l[?2004h>                  }
[?2004l[?2004h>              }
[?2004l[?2004h>              close("${SERVICE_NAMES_FILE}")
[?2004l[?2004h>              
[?2004l[?2004h>              # Determine scope classification
[?2004l[?2004h>              if ($4 ~ /^0.0.0.0/) {
[?2004l[?2004h>                  prefix="public-"
[?2004l[?2004h>              } else if ($4 ~ /^127.0.0.1/) {
[?2004l[?2004h>                  prefix="local-"
[?2004l[?2004h>              } else {
[?2004l[?2004h>                  prefix=""
[?2004l[?2004h>              }
[?2004l[?2004h>              
[?2004l[?2004h>              # Format output
[?2004l[?2004h>              printf "%s %s %s (%s %s)\n", port, prefix proto_port, $NF, $(NF-1), service_name
[?2004l[?2004h>          }
[?2004l[?2004h>     ' "$NETSTAT_FILE" | sort -k1n > "$output_file"
[?2004l[?2004h>     
[?2004l[?2004h>     echo "Network analysis completed"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Function to process user audit data (Job 2)
[?2004l[?2004h> function process_user_audit() {
[?2004l[?2004h>     local output_file="$REPORT_DIR/user_audit.tmp"
[?2004l[?2004h>     
[?2004l[?2004h>     # Process passwd file with exclusions
[?2004l[?2004h>     awk -F: -v limit="$UID_LIMIT" -v blacklist_file="$USER_BLACKLIST_FILE" '
[?2004l[?2004h>         BEGIN { 
[?2004l[?2004h>             while ((getline bl < blacklist_file) > 0) {
[?2004l[?2004h>                 blacklist[bl] = 1
[?2004l[?2004h>             }
[?2004l[?2004h>             close(blacklist_file)
[?2004l[?2004h>         }
[?2004l[?2004h>         $3 < limit && $7 != "/bin/false" && !( $1 in blacklist ) {
[?2004l[?2004h>             print $1
[?2004l[?2004h>         }
[?2004l[?2004h>     ' "$PASSWD_FILE" | sort > "$output_file"
[?2004l[?2004h>     
[?2004l[?2004h>     echo "User audit completed"
[?2004l[?2004h> }
[?2004l[?2004h> EOFcat >> /home/user/reports/run_security_scan.sh << 'EOF'
[?2004l[?2004h> 
[?2004l[?2004h> # Function to generate final reports
[?2004l[?2004h> function generate_reports() {
[?2004l[?2004h>     local yaml_file="$REPORT_DIR/infra_security_report.yml"
[?2004l[?2004h>     local siem_log_file="$REPORT_DIR/scan_exec_time.log"
[?2004l[?2004h>     local temp_network="$REPORT_DIR/network_analysis.tmp"
[?2004l[?2004h>     local temp_users="$REPORT_DIR/user_audit.tmp"
[?2004l[?2004h>     
[?2004l[?2004h>     # Convert network data to YAML format
[?2004l[?2004h>     cat > "$yaml_file" << YAMLEOF
[?2004l[?2004h> ---
[?2004l[?2004h> meta:
[?2004l[?2004h>   input_hash: "$INPUT_HASH"
[?2004l[?2004h> insecure_users:
[?2004l[?2004h> YAMLEOF
[?2004l[?2004h> 
[?2004l[?2004h>     while read -r user; do
[?2004l[?2004h>         echo "  - $user" >> "$yaml_file"
[?2004l[?2004h>     done < "$temp_users"
[?2004l[?2004h>     
[?2004l[?2004h>     echo -e "open_ports:" >> "$yaml_file"
[?2004l[?2004h>     
[?2004l[?2004h>     while read -r line; do
[?2004l[?2004h>         port=$(echo "$line" | awk '{print $1}')
[?2004l[?2004h>         proto=$(echo "$line" | awk '{print $2}')
[?2004l[?2004h>         process=$(echo "$line" | awk '{print $3}')
[?2004l[?2004h>         
[?2004l[?2004h>         echo -e "  - port: $port" >> "$yaml_file"
[?2004l[?2004h>         echo -e "    protocol: $proto" >> "$yaml_file"
[?2004l[?2004h>         echo -e "    process: $process" >> "$yaml_file"
[?2004l[?2004h>     done < "$temp_network"
[?2004l[?2004h>     
[?2004l[?2004h>     # Convert to ISO-8859-1 encoding
[?2004l[?2004h>     iconv -f UTF-8 -t ISO-8859-1 "$yaml_file" -o "$yaml_file"
[?2004l[?2004h>     
[?2004l[?2004h>     # Create SIEM log with CRLF line endings
[?2004l[?2004h>     echo -e "start_epoch,end_epoch,duration\r" > "$siem_log_file"
[?2004l[?2004h>     local duration=$((END_EPOCH - START_EPOCH))
[?2004l[?2004h>     echo -e "${START_EPOCH},${END_EPOCH},${duration}\r" >> "$siem_log_file"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Function to clean up temporary files
[?2004l[?2004h> function cleanup() {
[?2004l[?2004h>     rm -f "$REPORT_DIR/network_analysis.tmp"
[?2004l[?2004h>     rm -f "$REPORT_DIR/user_audit.tmp"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Trap function to handle script exit
[?2004l[?2004h> function on_exit() {
[?2004l[?2004h>     echo "Cleaning up temporary files..."
[?2004l[?2004h>     cleanup
[?2004l[?2004h>     echo "Script execution completed"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Main execution block
[?2004l[?2004h> {
[?2004l[?2004h>     echo "Starting security scan..."
[?2004l[?2004h>     
[?2004l[?2004h>     # Capture start epoch
[?2004l[?2004h>     START_EPOCH=$(date +%s)
[?2004l[?2004h>     INPUT_HASH=$(calculate_input_hash)
[?2004l[?2004h>     
[?2004l[?2004h>     # Launch parallel jobs
[?2004l[?2004h>     process_network_data &
[?2004l[?2004h>     JOB_PIDS+=($!)  
[?2004l[?2004h>     
[?2004l[?2004h>     process_user_audit &
[?2004l[?2004h>     JOB_PIDS+=($!) 
[?2004l[?2004h>     
[?2004l[?2004h>     # Wait for all jobs to complete
[?2004l[?2004h>     for pid in "${JOB_PIDS[@]}"; do
[?2004l[?2004h>         wait $pid
[?2004l[?2004h>     done
[?2004l[?2004h>     
[?2004l[?2004h>     # Calculate end epoch
[?2004l[?2004h>     END_EPOCH=$(date +%s)
[?2004l[?2004h>     
[?2004l[?2004h>     # Generate reports
[?2004l[?2004h>     generate_reports
[?2004l[?2004h>     
[?2004l[?2004h>     echo "Security scan completed"
[?2004l[?2004h>     echo "Start epoch: $START_EPOCH, End epoch: $END_EPOCH, Duration: $((END_EPOCH - START_EPOCH)) seconds"
[?2004l[?2004h>     
[?2004l[?2004h>     # Clean up temporary files
[?2004l[?2004h>     cleanup
[?2004l[?2004h> } &> "$REPORT_DIR/scan_exec_time.log"
[?2004l[?2004h> 
[?2004l[?2004h> # Register cleanup function for script exit
[?2004l[?2004h> ttrap on_exit EXIT
[?2004l[?2004h> EOFchmod +x /home/user/reports/run_security_scan.sh
[?2004l[?2004h> /home/user/reports/run_security_scan.sh
[?2004l[?2004h> ls -la /home/user/reports/
[?2004l[?2004h> file /home/user/reports/infra_security_report.yml
[?2004l[?2004h> cat /home/user/reports/infra_security_report.yml
[?2004l[?2004h> 