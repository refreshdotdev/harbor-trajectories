```json
{
  "analysis": "I have been assigned ticket SEC-4022 to automate the generation of a daily infrastructure snapshot report. The environment contains sample data files and configuration, but the Bash script at /home/user/reports/run_security_scan.sh does not yet exist. I need to create this script to perform parallel processing of network exposure and user audit data, then generate two output artifacts with strict encoding and formatting requirements.",
  "plan": "I will create the directory structure and write the Bash script at /home/user/reports/run_security_scan.sh. The script will implement parallel processing using background jobs and wait, capture start/end timestamps, process mock_netstat.txt and mock_passwd files according to the specifications, and generate the required YAML and CSV output files with proper encoding and line endings.",
  "commands": [
    {
      "keystrokes": "mkdir -p /home/user/reports\n",
      "duration": 0.1
    },
    {
      "keystrokes": "cat > /home/user/reports/run_security_scan.sh << 'EOF'\n#!/bin/bash\n\n# Enterprise Security Baseline Automation (SOP-992) - Ticket SEC-4022\n# Automate daily infrastructure snapshot report generation\n\nset -eo pipefail\n\n# Configuration\nUID_LIMIT=1000\nSCRIPT_DIR=\"/home/user/reports\"\nINPUT_DIR=\"/home/user/sample_data\"\nCONFIG_DIR=\"/home/user/config\"\nTMP_DIR=\"/tmp/$(basename \"$0\")-$$\"\n\ndebug() {\n    echo \"[DEBUG $(date '+%Y-%m-%d %H:%M:%S')] $*\" >> \"${SCRIPT_DIR}/scan_exec_time.log\"\n}\n\n# Cleanup temporary files on exit\ncleanup() {\n    rm -rf \"${TMP_DIR}\"\n}\n\n# Register cleanup function\ntrap cleanup EXIT INT TERM\n\n# Create temporary working directory\nmkdir -p \"${TMP_DIR}\"\n\n# 1. Capture start time (Unix epoch)\nSTART_EPOCH=$(date '+%s')\n\necho \"Script started at: $(date)\"  # Optional: for human-readable log\n\n# 2. Calculate input hash for integrity check\nINPUT_HASH=$(cat \"${INPUT_DIR}/mock_netstat.txt\" \"${INPUT_DIR}/mock_passwd\" | md5sum - | cut -d' ' -f1)\n\n# 3. Process service_names.csv - strip BOM and create lookup database\necho \"Processing service names...\"\niconv -f UTF-8 -t UTF-8 \"${INPUT_DIR}/service_names.csv\" | sed '1s/^\\xef\\xbb\\xbf//' > \"${TMP_DIR}/service_names_clean.csv\"\n\n# Create awk-friendly service name lookup database\nawk -F, '{print $1 \"\\\"\" $2 \"\\\"\"}' \"${TMP_DIR}/service_names_clean.csv\" > \"${TMP_DIR}/service_names.db\"\n\necho \"Service names processed successfully.\"\n\n# 4. Job 1: Network Exposure Analysis (parallel)\necho \"Starting network exposure analysis...\"\n\n# Define netstat processing function\nprocess_netstat() {\n    awk -v service_db=\"${TMP_DIR}/service_names.db\" -v OFS=',' -F\" \" 'BEGIN {\n        while (getline < service_db > 0) {\n            split($0, parts, /\\\"\\\"/);\n            service_map[parts[1]] = parts[2];\n        }\n    }\n    $NF ~ /LISTEN|udp$/ {\n        split($4, addr_port, \":\");\n        port = addr_port[length(addr_port)];\n        proto_key = ($5 \"/\" $6);\n        service_name = (proto_key in service_map) ? \",\" service_map[proto_key] : \"\";\n        \n        # Scope classification\n        if ($4 ~ /^0\\.0\\.0\\.0/) {\n            proto = \"public-\" $6;\n        } else if ($4 ~ /^127\\.0\\.0\\.1/) {\n            proto = \"local-\" $6;\n        } else {\n            proto = $6;\n        }\n        \n        # Enrichment and output\n        gsub(/[()]/, \"\", $0);  # Clean parentheses from original process name\n        print port, proto, $NF \",\" $0 service_name;\n    }' \"${INPUT_DIR}/mock_netstat.txt\" | sort -n > \"${TMP_DIR}/open_ports.csv\"\n}\n\n# 5. Job 2: User Audit (parallel)\necho \"Starting user audit...\"\n\n# Define user audit function\nprocess_users() {\n    awk -v uid_limit=${UID_LIMIT} -v blacklist_file=\"${CONFIG_DIR}/user_blacklist.txt\" -v OFS=',' 'BEGIN {\n        while (getline < blacklist_file > 0) {\n            blacklist[$0] = 1;\n        }\n    }\n    $3 < uid_limit && $7 != \"/bin/false\" && !($1 in blacklist) {\n        print $1;\n    }' \"${INPUT_DIR}/mock_passwd\" | sort > \"${TMP_DIR}/insecure_users.csv\"\n}\n\n# Launch both jobs in parallel\nprocess_netstat &\nPID_NETSTAT=$!\nprocess_users &\nPID_USERS=$!\n\n# Wait for both jobs to complete\necho \"Waiting for background jobs to complete...\"\nwait ${PID_NETSTAT} ${PID_USERS}\n\necho \"Background jobs completed successfully.\"\n\n# 6. Generate Artifact A: Mainframe Report (infra_security_report.yml)\necho \"Generating mainframe security report...\"\n\n# Create YAML content with proper encoding\n{\n    echo \"---\"\n    echo \"meta:\"  \n    echo \"  input_hash: ${INPUT_HASH}\"\n    echo \"insecure_users:\"  \n    while IFS= read -r user; do\n        echo \"  - ${user}\"\n    done < \"${TMP_DIR}/insecure_users.csv\"\n    echo \"open_ports:\"  \n    while IFS=, read -r port protocol process rest; do\n        echo \"  - port: ${port}\"\n        echo \"    protocol: ${protocol}\"\n        echo \"    process: ${process}\"\n    done < \"${TMP_DIR}/open_ports.csv\"\n} | iconv -f UTF-8 -t ISO-8859-1 > \"${SCRIPT_DIR}/infra_security_report.yml\"\n\necho \"Mainframe security report generated successfully.\"\n\n# 7. Generate Artifact B: SIEM Log (scan_exec_time.log)\necho \"Generating SIEM log...\"\n\n# Calculate duration and create CSV with CRLF line endings\nEND_EPOCH=$(date '+%s')\nDURATION=$((END_EPOCH - START_EPOCH))\n\n# Create CSV with CRLF line endings\n{\n    echo -n \"start_epoch,end_epoch,duration\\r\"\n    echo -n \"${START_EPOCH},${END_EPOCH},${DURATION}\\r\"\n} > \"${SCRIPT_DIR}/scan_exec_time.log\"\n\necho \"SIEM log generated successfully.\"\n\n# 8. Final status\nEND_EPOCH=$(date '+%s')\nDURATION=$((END_EPOCH - START_EPOCH))\necho \"Script execution completed in ${DURATION} seconds.\"\necho \"Final artifacts generated at: $(date '+%Y-%m-%d %H:%M:%S')\"\n\n# 9. Make script executable\nchmod +x \"${SCRIPT_DIR}/run_security_scan.sh\"\nEOF",
      "duration": 0.5
    },
    {
      "keystrokes": "chmod +x /home/user/reports/run_security_scan.sh\n",
      "duration": 0.1
    },
    {
      "keystrokes": "ls -la /home/user/reports/\n",
      "duration": 0.1
    }
  ],
  "task_complete": true
}
```