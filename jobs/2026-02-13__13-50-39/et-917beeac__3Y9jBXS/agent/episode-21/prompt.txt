Previous response had warnings:
WARNINGS: - Command 1 should end with newline when followed by another command. Otherwise the two commands will be concatenated together on the same line.

New Terminal Output:

root@a0eea0e5-02a2-44b8-82aa-a589fdbe2c7a:/home/user# cat > solve_v2.sh << 'EOF'
> #!/bin/bash
> set -x
>
> # Legacy Data Ingestion Script v2
> REGION_CODE="DEFAULT"
> TODAY=$(date +%%Y%%m%%d)
> ARCHIVE_DIR="/home/user/etl/archive"
> QUARANTINE_DIR="/home/user/etl/quarantine"
> RAW_BACKUP_DIR="/home/user/etl/raw_backup"
> STAGING_DIR="/home/user/etl/staging"
> LOG_DIR="/home/user/etl/logs"
> INCOMING_DIR="/home/user/incoming"
>
> echo "Starting ETL process v2..."
>
> # Create directories
> mkdir -p "\$ARCHIVE_DIR" "\$QUARANTINE_DIR" "\$RAW_BACKUP_DIR" "\$STAGING_DIR" "\$LOG_DIR"
>
> echo "Directories created"
>
> total_records=0
> processed_files=()
>
> echo "Processing files in \$INCOMING_DIR..."
> for csv_file in "\$INCOMING_DIR"/*.csv; do
>     if [ ! -f "\$csv_file" ]; then
>         echo "No CSV files found"
>         continue
>     fi
>     filename=$(basename -- "\$csv_file")
>     echo "Processing \$filename"
>
>     # BOM check
>     if file "\$csv_file" | grep -q "BOM"; then
>         echo "BOM detected in \$filename"
>         mv "\$csv_file" "\$QUARANTINE_DIR/"
>     else
>         echo "File is clean: \$filename"
>         processed_files+=("\$filename")
>         mv "\$csv_file" "\$RAW_BACKUP_DIR/"
>     fi
>
>     # Count data rows
>     csv_path="\$RAW_BACKUP_DIR/\$filename"
>     row_count=$(tail -n +2 "\$csv_path" | wc -l)
>     total_records=$((total_records + row_count))
>     echo "Added \$row_count rows from \$filename, total: \$total_records"
> done
>
> echo "Processing complete. Total records: \$total_records"
> echo "Processed files: \${#processed_files[@]}"
>
> # Archival
> if [ \$total_records -gt 0 ]; then
>     echo "Creating archive..."
>     cd "\$RAW_BACKUP_DIR"
>
>     # Convert CSV to TSV
>     tsv_files=()
>     for csv in *.csv; do
>         tsv="\${csv%.csv}.tsv"
>         # Simple CSV to TSV conversion
>         sed 's/,/\t/g' "\$csv" > "\$tsv"
>         tsv_files+=("\$tsv")
>     done
>
>     # Create tarball
>     archive_name="data_\$REGION_CODE_\$TODAY_\$total_records.tar.gz"
>     tar -czf "\$ARCHIVE_DIR/\$archive_name" "\${tsv_files[@]}" 2>/dev/null
>
>     if [ \$? -eq 0 ]; then
>         echo "Archive created: \$archive_name"
>         # Clean up TSV files
>         rm -f "\${tsv_files[@]}"
>     else
>         echo "Failed to create archive"
>     fi
> else
>     echo "No files to archive"
> fi
>
> echo "ETL process completed"
> EOFchmod +x solve_v2.sh
> ./solve_v2.sh
>
