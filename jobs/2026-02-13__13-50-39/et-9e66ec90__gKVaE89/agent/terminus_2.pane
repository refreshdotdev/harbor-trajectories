[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~# clear
[?2004l[H[J[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~# cd /home/user/k8s
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# ls -la
[?2004ltotal 0
drwxr-xr-x 1 root root 102 Feb 13 18:50 .
drwxr-xr-x 1 root root  37 Feb 13 18:50 ..
drwxr-xr-x 1 root root  10 Feb 13 18:50 audit
drwxr-xr-x 1 root root  77 Feb 13 18:50 config
drwxr-xr-x 1 root root  10 Feb 13 18:50 logs
drwxr-xr-x 1 root root  10 Feb 13 18:50 rendered
drwxr-xr-x 1 root root  41 Feb 13 18:50 templates
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# source config/base.env
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# export $(cat config/overlay.env | tr -d '\r' | sed -e 's/^[\t ]*//' -e 's/[\t ]*$//' -e 's/=[\t ]*/=/' -e 's/#.*$//' -e '/^$/d' | xargs)
[?2004lbash: export: `๏ปฟAPP_NAME=titan_omega': not a valid identifier
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat -A config/overlay.env
[?2004lM-oM-;M-?APP_NAME=titan_omega$
ENVIRONMENT=prod_M-BM-'1$
API_KEY=secret_agent_99$
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# grep -E '^(API_KEY|ENVIRONMENT)=' config/overlay.env | tr -d '\r'
[?2004lENVIRONMENT=prod_ยง1
API_KEY=secret_agent_99
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# export APP_NAME="$(grep '^APP_NAME=' config/overlay.env | tr -d '\r' | sed 's/^APP_NAME=//')"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# export ENVIRONMENT="$(grep '^ENVIRONMENT=' config/overlay.env | tr -d '\r' | sed 's/^ENVIRONMENT=//')"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# export API_KEY="$(grep '^API_KEY=' config/overlay.env | tr -d '\r' | sed 's/^API_KEY=//')"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "APP_NAME: $APP_NAME, ENVIRONMENT: $ENVIRONMENT, API_KEY: $API_KEY"
[?2004lAPP_NAME: , ENVIRONMENT: prod_ยง1, API_KEY: secret_agent_99
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "Processing API_KEY: $API_KEY"
[?2004lProcessing API_KEY: secret_agent_99
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# API_KEY_REVERSED="$(echo "$API_KEY" | rev)"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# API_KEY_TRANSFORMED="$(echo "$API_KEY_REVERSED" | base64 -w 0)"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "Reversed: $API_KEY_REVERSED, Base64: $API_KEY_TRANSFORMED"
[?2004lReversed: 99_tnega_terces, Base64: OTlfdG5lZ2FfdGVyY2VzCg==
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# TEMPLATE_HASH="$(sha256sum templates/deployment.yaml.tpl | cut -c1-8)"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "Template hash: $TEMPLATE_HASH"
[?2004lTemplate hash: e3b0c442
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# PREFLIGHT_JSON="{\"app_name\":\"$APP_NAME\",\"environment\":\"$ENVIRONMENT\",\"api_key_processed\":\"$API_KEY_TRANSFORMED\",\"template_hash\":\"$TEMPLATE_HASH\"}" 
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "$PREFLIGHT_JSON" > audit/preflight.json
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat audit/preflight.json
[?2004l{"app_name":"","environment":"prod_ยง1","api_key_processed":"OTlfdG5lZ2FfdGVyY2VzCg==","template_hash":"e3b0c442"}
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# envsubst < templates/deployment.yaml.tpl > rendered/deployment.yaml
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# unix2dos rendered/deployment.yaml
[?2004lbash: unix2dos: command not found
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat -A rendered/deployment.yaml
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# file rendered/deployment.yaml
[?2004lbash: file: command not found
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# sed -i 's/$/\r/' rendered/deployment.yaml
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat -A rendered/deployment.yaml
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat templates/deployment.yaml.tpl
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# which envsubst
[?2004l/usr/bin/envsubst
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat > templates/deployment.yaml.tpl << 'EOF'
[?2004l[?2004h> apiVersion: apps/v1
[?2004l[?2004h> kind: Deployment
[?2004l[?2004h> metadata:
[?2004l[?2004h>   name: ${APP_NAME:-titan}
[?2004l[?2004h>   labels:
[?2004l[?2004h>     app: ${APP_NAME:-titan}
[?2004l[?2004h>     environment: ${ENVIRONMENT}
[?2004l[?2004h> spec:
[?2004l[?2004h>   replicas: 1
[?2004l[?2004h>   selector:
[?2004l[?2004h>     matchLabels:
[?2004l[?2004h>       app: ${APP_NAME:-titan}
[?2004l[?2004h>   template:
[?2004l[?2004h>     metadata:
[?2004l[?2004h>       labels:
[?2004l[?2004h>         app: ${APP_NAME:-titan}
[?2004l[?2004h>     spec:
[?2004l[?2004h>       containers:
[?2004l[?2004h>       - name: ${APP_NAME:-titan}
[?2004l[?2004h>         image: nginx:1.20
[?2004l[?2004h>         env:
[?2004l[?2004h>         - name: API_KEY
[?2004l[?2004h>           value: "${API_KEY_SPECIAL}"
[?2004l[?2004h>         - name: ENVIRONMENT
[?2004l[?2004h>           value: "${ENVIRONMENT}"
[?2004l[?2004h> EOF
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# envsubst < templates/deployment.yaml.tpl > rendered/deployment.yaml
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# sed -i 's/$/\r/' rendered/deployment.yaml
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat -A rendered/deployment.yaml
[?2004lapiVersion: apps/v1^M$
kind: Deployment^M$
metadata:^M$
  name: ${APP_NAME:-titan}^M$
  labels:^M$
    app: ${APP_NAME:-titan}^M$
    environment: prod_M-BM-'1^M$
spec:^M$
  replicas: 1^M$
  selector:^M$
    matchLabels:^M$
      app: ${APP_NAME:-titan}^M$
  template:^M$
    metadata:^M$
      labels:^M$
        app: ${APP_NAME:-titan}^M$
    spec:^M$
      containers:^M$
      - name: ${APP_NAME:-titan}^M$
        image: nginx:1.20^M$
        env:^M$
        - name: API_KEY^M$
          value: ""^M$
        - name: ENVIRONMENT^M$
          value: "prod_M-BM-'1"^M$
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# LOG_CONTENT="APP_NAME=${APP_NAME}\nENVIRONMENT=${ENVIRONMENT}\nPREFLIGHT_HASH=$(md5sum audit/preflight.json | cut -d' ' -f1)\nMANIFEST_HASH=$(sha256sum rendered/deployment.yaml | cut -d' ' -f1)"
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "$LOG_CONTENT" > logs/render.log
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat logs/render.log
[?2004lAPP_NAME=\nENVIRONMENT=prod_ยง1\nPREFLIGHT_HASH=39fe1a50d07695703dc15764ef0ecdaa\nMANIFEST_HASH=0c5c242e4e5f1327d304ff2a7e2e90f269789ff27505c9656be99bbac0abf475
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# iconv -f UTF-8 -t ISO-8859-1 logs/render.log > logs/render.log.tmp && mv logs/render.log.tmp logs/render.log
[?2004l[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat logs/render.log
[?2004lAPP_NAME=\nENVIRONMENT=prod_ง1\nPREFLIGHT_HASH=39fe1a50d07695703dc15764ef0ecdaa\nMANIFEST_HASH=0c5c242e4e5f1327d304ff2a7e2e90f269789ff27505c9656be99bbac0abf475
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "APP_NAME: $APP_NAME, ENVIRONMENT: $ENVIRONMENT, API_KEY_TRANSFORMED: $API_KEY_TRANSFORMED, TEMPLATE_HASH: $TEMPLATE_HASH"
[?2004lAPP_NAME: , ENVIRONMENT: prod_ยง1, API_KEY_TRANSFORMED: OTlfdG5lZ2FfdGVyY2VzCg==, TEMPLATE_HASH: e3b0c442
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "=== Verification ==="
[?2004l=== Verification ===
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "1. preflight.json:"
[?2004l1. preflight.json:
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat audit/preflight.json
[?2004l{"app_name":"","environment":"prod_ยง1","api_key_processed":"OTlfdG5lZ2FfdGVyY2VzCg==","template_hash":"e3b0c442"}
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "2. deployment.yaml (first few lines):"
[?2004l2. deployment.yaml (first few lines):
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# head -5 rendered/deployment.yaml
[?2004lapiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME:-titan}
  labels:
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# echo "3. render.log:"
[?2004l3. render.log:
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# cat logs/render.log
[?2004lAPP_NAME=\nENVIRONMENT=prod_ง1\nPREFLIGHT_HASH=39fe1a50d07695703dc15764ef0ecdaa\nMANIFEST_HASH=0c5c242e4e5f1327d304ff2a7e2e90f269789ff27505c9656be99bbac0abf475
[?2004hroot@3b5edb01-7ffc-46e3-8d7b-29e03176bad3:~/k8s# 