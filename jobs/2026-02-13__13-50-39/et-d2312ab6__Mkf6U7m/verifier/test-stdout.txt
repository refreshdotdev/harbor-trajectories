============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /tests
collecting ... collected 3 items

../../../tests/test_final_state.py::test_database_content FAILED         [ 33%]
../../../tests/test_final_state.py::test_legacy_sync_file FAILED         [ 66%]
../../../tests/test_final_state.py::test_manifest_file FAILED            [100%]

=================================== FAILURES ===================================
____________________________ test_database_content _____________________________

    def test_database_content():
        assert DB_PATH.is_file(), "Database file missing."
        exp_ver, exp_time, exp_sig = _get_expected_data()
    
        with sqlite3.connect(DB_PATH) as conn:
            cursor = conn.cursor()
            cursor.execute(
                "SELECT iso_version, deploy_time, integrity_hash, status FROM deployment_log WHERE iso_version=?",
                (exp_ver,)
            )
            rows = cursor.fetchall()
    
>           assert len(rows) == 1, f"Expected 1 DB row for version {exp_ver}, found {len(rows)}."
E           AssertionError: Expected 1 DB row for version v2.4.1-beta, found 0.
E           assert 0 == 1
E            +  where 0 = len([])

/tests/test_final_state.py:79: AssertionError
____________________________ test_legacy_sync_file _____________________________

    def test_legacy_sync_file():
        assert LEGACY_LOG.is_file(), "Legacy sync file missing."
        exp_ver, exp_time, exp_sig = _get_expected_data()
    
        # Expected format: VERSION|TIMESTAMP|SIGNATURE
        # Encoding: ISO-8859-1
        # Line Ending: CRLF
    
        expected_str = f"{exp_ver}|{exp_time}|{exp_sig}\r\n"
        expected_bytes = expected_str.encode("iso-8859-1")
    
        with open(LEGACY_LOG, "rb") as f:
            content = f.read()
    
        # Check exact bytes to verify encoding and line endings
>       assert content == expected_bytes, (
            f"Legacy file content mismatch.\n"
            f"Expected bytes (ISO-8859-1 + CRLF): {expected_bytes!r}\n"
            f"Found bytes:                        {content!r}"
        )
E       AssertionError: Legacy file content mismatch.
E         Expected bytes (ISO-8859-1 + CRLF): b'v2.4.1-beta|1698400800|50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3b4152078cd7\r\n'
E         Found bytes:                        b''
E       assert b'' == b'v2.4.1-beta...152078cd7\r\n'
E         
E         Full diff:
E         + b''
E         - (b'v2.4.1-beta|1698400800|50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3'
E         -  b'b4152078cd7\r\n')

/tests/test_final_state.py:105: AssertionError
______________________________ test_manifest_file ______________________________

    def test_manifest_file():
        assert MANIFEST.is_file(), "Manifest file missing."
        exp_ver, exp_time, exp_sig = _get_expected_data()
    
        # Check Permissions (0444)
        mode = stat.S_IMODE(os.stat(MANIFEST).st_mode)
        assert mode == 0o444, f"Manifest permissions must be 0444, got {oct(mode)}"
    
        # Calculate expected SHA256 of the Legacy File
        # This enforces the dependency order: DB -> Legacy File -> Manifest
        with open(LEGACY_LOG, "rb") as f:
            legacy_content = f.read()
        legacy_hash = hashlib.sha256(legacy_content).hexdigest()
    
        with open(MANIFEST, "r") as f:
            data = json.load(f)
    
>       assert data.get("version") == exp_ver
E       AssertionError: assert 'v1.0.0' == 'v2.4.1-beta'
E         
E         - v2.4.1-beta
E         + v1.0.0

/tests/test_final_state.py:131: AssertionError
=========================== short test summary info ============================
FAILED ../../../tests/test_final_state.py::test_database_content - AssertionE...
FAILED ../../../tests/test_final_state.py::test_legacy_sync_file - AssertionE...
FAILED ../../../tests/test_final_state.py::test_manifest_file - AssertionErro...
============================== 3 failed in 0.03s ===============================
