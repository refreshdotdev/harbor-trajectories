[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# clear
[?2004l[H[J[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# pwd
[?2004l/home/user/workspace
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# ls -la
[?2004ltotal 0
drwxrwxrwx 1 root root 50 Feb 13 19:03 [0m[34;42m.[0m
drwxr-xr-x 1 root root 31 Feb 13 19:03 [01;34m..[0m
drwxrwxrwx 1 root root 28 Feb 13 19:03 [34;42mincoming[0m
drwxrwxrwx 1 root root  6 Feb 13 19:03 [34;42moutgoing[0m
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# ls -la incoming/
[?2004ltotal 4
drwxrwxrwx 1 root root  28 Feb 13 19:03 [0m[34;42m.[0m
drwxrwxrwx 1 root root  50 Feb 13 19:03 [34;42m..[0m
-rwxrwxrwx 1 root root 118 Oct 27  2023 [01;32mbuild_meta.xml[0m
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# file incoming/build_meta.xml
[?2004lbash: file: command not found
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# ls -la /etc/opt/keys/
[?2004ltotal 12
drw-r--r-- 1 root root 103 Feb 13 19:03 [0m[01;34m.[0m
drwxr-xr-x 1 root root  26 Feb 13 19:03 [01;34m..[0m
-rw-r--r-- 1 root root  21 Feb 13 19:03 old_key.bak
-rw-r--r-- 1 root root  27 Feb 13 19:03 release_signing.key
-rw-r--r-- 1 root root  24 Feb 13 19:03 release_signing.key.example
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import sys
[?2004l[?2004h> with open('/etc/opt/keys/release_signing.key', 'r') as f:
[?2004l[?2004h>     key = f.read().strip()
[?2004l[?2004h> sys.stdout.write(key)
[?2004l[?2004h> "
[?2004lsuper-secret-key-value[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import xml.etree.ElementTree as ET
[?2004l[?2004h> import codecs
[?2004l[?2004h> 
[?2004l[?2004h> # Read file with UTF-16LE encoding and skip BOM
[?2004l[?2004h> with open('incoming/build_meta.xml', 'rb') as f:
[?2004l[?2004h>     raw_data = f.read()
[?2004l[?2004h>     # Remove BOM if present
[?2004l[?2004h>     if raw_data.startswith(codecs.BOM_UTF16_LE):
[?2004l[?2004h>         raw_data = raw_data[2:]
[?2004l[?2004h>     xml_string = raw_data.decode('utf-16le')
[?2004l[?2004h> 
[?2004l[?2004h> root = ET.fromstring(xml_string)
[?2004l[?2004h> version = root.find('./version').text
[?2004l[?2004h> print(f'Version: {version}')
[?2004l[?2004h> "
[?2004lTraceback (most recent call last):
  File "<string>", line 14, in <module>
AttributeError: 'NoneType' object has no attribute 'text'
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import codecs
[?2004l[?2004h> with open('incoming/build_meta.xml', 'rb') as f:
[?2004l[?2004h>     raw_data = f.read()
[?2004l[?2004h>     if raw_data.startswith(codecs.BOM_UTF16_LE):
[?2004l[?2004h>         raw_data = raw_data[2:]
[?2004l[?2004h>     xml_string = raw_data.decode('utf-16le', errors='replace')
[?2004l[?2004h>     print(xml_string[:200])  # Print first 200 characters
[?2004l[?2004h> "
[?2004l<Build><Meta><Version>v2.4.1-beta</Version></Meta></Build>
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import xml.etree.ElementTree as ET
[?2004l[?2004h> import codecs
[?2004l[?2004h> 
[?2004l[?2004h> with open('incoming/build_meta.xml', 'rb') as f:
[?2004l[?2004h>     raw_data = f.read()
[?2004l[?2004h>     if raw_data.startswith(codecs.BOM_UTF16_LE):
[?2004l[?2004h>         raw_data = raw_data[2:]
[?2004l[?2004h>     xml_string = raw_data.decode('utf-16le')
[?2004l[?2004h> 
[?2004l[?2004h> root = ET.fromstring(xml_string)
[?2004l[?2004h> version = root.find('.//Version').text
[?2004l[?2004h> print(f'Version: {version}')
[?2004l[?2004h> "
[?2004lVersion: v2.4.1-beta
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import os
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import hmac
[?2004l[?2004h> import codecs
[?2004l[?2004h> 
[?2004l[?2004h> key = 'super-secret-key-value'.encode()
[?2004l[?2004h> 
[?2004l[?2004h> # Get file modification time
[?2004l[?2004h> xml_path = 'incoming/build_meta.xml'
[?2004l[?2004h> timestamp = int(os.path.getmtime(xml_path))
[?2004l[?2004h> 
[?2004l[?2004h> # Construct payload
[?2004l[?2004h> version = 'v2.4.1-beta'
[?2004l[?2004h> payload = version + str(timestamp)
[?2004l[?2004h> 
[?2004l[?2004h> # Compute HMAC-SHA256
[?2004l[?2004h> signer = hmac.new(key, digestmod='sha256')
[?2004l[?2004h> signer.update(payload.encode('utf-8'))
[?2004l[?2004h> signature = signer.hexdigest()
[?2004l[?2004h> 
[?2004l[?2004h> print(f'Version: {version}')
[?2004l[?2004h> print(f'Timestamp: {timestamp}')
[?2004l[?2004h> print(f'Payload: {payload}')
[?2004l[?2004h> print(f'Signature: {signature}')
[?2004l[?2004h> "
[?2004lVersion: v2.4.1-beta
Timestamp: 1698400800
Payload: v2.4.1-beta1698400800
Signature: 50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3b4152078cd7
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# sqlite3 /var/lib/db/production.db "
[?2004l[?2004h> INSERT INTO deployment_log (iso_version, deploy_time, integrity_hash, status)
[?2004l[?2004h> VALUES ('v2.4.1-beta', 1698400800, '50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3b4152078cd7', 'pending_audit');
[?2004l[?2004h> "
[?2004l[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import codecs
[?2004l[?2004h> 
[?2004l[?2004h> content = 'v2.4.1-beta|1698400800|50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3b4152078cd7'
[?2004l[?2004h> 
[?2004l[?2004h> # Encode with ISO-8859-1 and add CRLF line endings
[?2004l[?2004h> bytes_content = (content + '\r\n').encode('iso-8859-1')
[?2004l[?2004h> 
[?2004l[?2004h> with open('outgoing/legacy_sync.dat', 'wb') as f:
[?2004l[?2004h>     f.write(bytes_content)
[?2004l[?2004h> 
[?2004l[?2004h> print('Legacy sync file created')
[?2004l[?2004h> "
[?2004lLegacy sync file created
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# python3 -c "
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import json
[?2004l[?2004h> 
[?2004l[?2004h> # Compute SHA-256 of legacy sync file
[?2004l[?2004h> with open('outgoing/legacy_sync.dat', 'rb') as f:
[?2004l[?2004h>     legacy_file_content = f.read()
[?2004l[?2004h>     legacy_sha256 = hashlib.sha256(legacy_file_content).hexdigest()
[?2004l[?2004h> 
[?2004l[?2004h> # Create manifest data
[?2004l[?2004h> manifest_data = {
[?2004l[?2004h>     'version': 'v2.4.1-beta',
[?2004l[?2004h>     'legacy_file_sha256': legacy_sha256,
[?2004l[?2004h>     'signature': '50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3b4152078cd7'
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Write manifest to file
[?2004l[?2004h> with open('outgoing/manifest.json', 'w') as f:
[?2004l[?2004h>     json.dump(manifest_data, f, indent=2)
[?2004l[?2004h> 
[?2004l[?2004h> print(f'Legacy file SHA256: {legacy_sha256}')
[?2004l[?2004h> print('Manifest created')
[?2004l[?2004h> "
[?2004lLegacy file SHA256: 40f4695f705ff1fb714b49bd64fcb9c86ba6c61b315f74aebeab845bc448cc27
Manifest created
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# chmod 0444 outgoing/manifest.json
[?2004l[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# ls -la outgoing/
[?2004ltotal 8
drwxrwxrwx 1 root root  62 Feb 13 19:08 [0m[34;42m.[0m
drwxrwxrwx 1 root root  30 Feb 13 19:03 [34;42m..[0m
-rw-r--r-- 1 root root  89 Feb 13 19:08 legacy_sync.dat
-r--r--r-- 1 root root 205 Feb 13 19:08 manifest.json
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# cat outgoing/legacy_sync.dat | od -c
[?2004l0000000   v   2   .   4   .   1   -   b   e   t   a   |   1   6   9   8
0000020   4   0   0   8   0   0   |   5   0   d   3   1   8   f   3   5
0000040   9   0   9   f   2   d   0   2   a   7   9   4   1   a   4   b
0000060   e   4   a   5   b   e   8   d   d   2   6   6   e   0   b   3
0000100   e   6   2   2   4   7   e   5   2   0   e   3   b   4   1   5
0000120   2   0   7   8   c   d   7  \r  \n
0000131
[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# cat outgoing/manifest.json
[?2004l{
  "version": "v2.4.1-beta",
  "legacy_file_sha256": "40f4695f705ff1fb714b49bd64fcb9c86ba6c61b315f74aebeab845bc448cc27",
  "signature": "50d318f35909f2d02a7941a4be4a5be8dd266e0b3e62247e520e3b4152078cd7"
}[?2004hroot@7de2718c-5782-4d57-8ea4-c0ae70333a1f:/home/user/workspace# 