[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:~# clear
[?2004l[H[J[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:~# cd /home/user/firewall
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# ls -la
[?2004ltotal 4
drwxr-xr-x 1 root root  54 Feb 12 22:36 [0m[01;34m.[0m
drwxr-xr-x 1 root root  30 Feb 12 22:36 [01;34m..[0m
-rwxr-xr-x 1 root root 335 Feb 12 22:36 [01;32mbase_rules.v4[0m
drwxr-xr-x 1 root root   6 Feb 12 22:36 [01;34mconfigs[0m
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# ls -la configs/
[?2004ltotal 0
drwxr-xr-x 1 root root  6 Feb 12 22:36 [0m[01;34m.[0m
drwxr-xr-x 1 root root 54 Feb 12 22:36 [01;34m..[0m
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# ls -la configs/
[?2004ltotal 0
drwxr-xr-x 1 root root  6 Feb 12 22:36 [0m[01;34m.[0m
drwxr-xr-x 1 root root 54 Feb 12 22:36 [01;34m..[0m
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# find configs/ -type f -name "*.json"
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# pwd
[?2004l/home/user/firewall
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat > configs/config1.json << 'EOF'
[?2004l[?2004h> {
[?2004l[?2004h>   "trusted_ip": "192.168.1.100",
[?2004l[?2004h>   "allow_ports": ["80", "443", "22", "3000-3005"],
[?2004l[?2004h>   "block_ports": ["23", "3306", "6379", "7000-7005"]
[?2004l[?2004h> }
[?2004l[?2004h> EOF
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat > configs/config2.json << 'EOF'
[?2004l[?2004h> {
[?2004l[?2004h>   "trusted_ip": "10.0.0.42\u200b",
[?2004l[?2004h>   "allow_ports": ["8080", "8443", "2020-2025"],
[?2004l[?2004h>   "block_ports": ["53", "11211", "27017-27019"]
[?2004l[?2004h> }
[?2004l[?2004h> EOF
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# sleep 2
[?2004lcat > configs/config3.json << 'EOF'
{
  "trusted_ip": "172.16.0.8\u200b\u200b",
  "allow_ports": ["80", "443", "9000-9010"],
  "block_ports": ["25", "143", "993", "8080-8090"]
}
EOF
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat > configs/config3.json << 'EOF'
[?2004l[?2004h> {
[?2004l[?2004h>   "trusted_ip": "172.16.0.8\u200b\u200b",
[?2004l[?2004h>   "allow_ports": ["80", "443", "9000-9010"],
[?2004l[?2004h>   "block_ports": ["25", "143", "993", "8080-8090"]
[?2004l[?2004h> }
[?2004l[?2004h> EOF
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# ls -la configs/
[?2004ltotal 12
drwxr-xr-x 1 root root  82 Feb 13 19:05 [0m[01;34m.[0m
drwxr-xr-x 1 root root  29 Feb 12 22:36 [01;34m..[0m
-rw-r--r-- 1 root root 141 Feb 13 19:05 config1.json
-rw-r--r-- 1 root root 135 Feb 13 19:05 config2.json
-rw-r--r-- 1 root root 142 Feb 13 19:05 config3.json
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# ls -latr configs/*.json
[?2004l-rw-r--r-- 1 root root 141 Feb 13 19:05 configs/config1.json
-rw-r--r-- 1 root root 135 Feb 13 19:05 configs/config2.json
-rw-r--r-- 1 root root 142 Feb 13 19:05 configs/config3.json
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# file configs/*.json
[?2004lbash: file: command not found
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat base_rules.v4
[?2004l*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp --dport 22 -j ACCEPT
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
-A INPUT -p tcp --dport 8080 -j ACCEPT
-A INPUT -p tcp --dport 3306 -j ACCEPT
COMMIT
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat > process_firewall.py << 'EOF'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> import json
[?2004l[?2004h> import os
[?2004l[?2004h> import re
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import csv
[?2004l[?2004h> import io
[?2004l[?2004h> import sys
[?2004l[?2004h> from datetime import datetime, timezone
[?2004l[?2004h> import glob
[?2004l[?2004h> 
[?2004l[?2004h> # Find most recent config file
[?2004l[?2004h> config_files = glob.glob("configs/*.json")
[?2004l[?2004h> config_files.sort(key=lambda x: os.path.getmtime(x))
[?2004l[?2004h> active_config = config_files[-1]
[?2004l[?2004h> print(f"Using config: {active_config}")
[?2004l[?2004h> 
[?2004l[?2004h> # Read and sanitize config
[?2004l[?2004h> with open(active_config, 'r') as f:
[?2004l[?2004h>     try:
[?2004l[?2004h>         config = json.load(f)
[?2004l[?2004h>     except json.JSONDecodeError:
[?2004l[?2004h>         print(f"Error: Invalid JSON in {active_config}")
[?2004l[?2004h>         sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> # Sanitize values by removing zero width spaces
[?2004l[?2004h> config['trusted_ip'] = re.sub(r'[\u200b\u200c]', '', config['trusted_ip'])
[?2004l[?2004h> config['trusted_ip'] = re.sub(r'\s+', '', config['trusted_ip'])
[?2004l[?2004h> 
[?2004l[?2004h> # Function to expand port ranges
[?2004l[?2004h> def expand_ports(ports):
[?2004l[?2004h>     expanded = []
[?2004l[?2004h>     for port in ports:
[?2004l[?2004h>         if '-' in port:
[?2004l[?2004h>             start, end = map(int, port.split('-'))
[?2004l[?2004h>             expanded.extend(str(p) for p in range(start, end + 1))
[?2004l[?2004h>         else:
[?2004l[?2004h>             expanded.append(port)
[?2004l[?2004h>     return expanded
[?2004l[?2004h> 
[?2004l[?2004h> allow_ports = expand_ports(config['allow_ports'])
[?2004l[?2004h> block_ports = expand_ports(config['block_ports'])
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Sanitized trusted_ip: {config['trusted_ip']}")
[?2004l[?2004h> print(f"Expanded allow_ports: {allow_ports}")
[?2004l[?2004h> print(f"Expanded block_ports: {block_ports}")
[?2004l[?2004h> 
[?2004l[?2004h> # Read base rules
[?2004l[?2004h> with open('base_rules.v4', 'r') as f:
[?2004l[?2004h>     base_rules = [line.strip() for line in f.readlines() if line.strip()]
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Base rules loaded: {len(base_rules)} lines")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate intermediate.json
[?2004l[?2004h> intermediate = []
[?2004l[?2004h> for port in allow_ports:
[?2004l[?2004h>     intermediate.append({
[?2004l[?2004h>         'type': 'allow',
[?2004l[?2004h>         'protocol': 'tcp',
[?2004l[?2004h>         'ip': config['trusted_ip'],
[?2004l[?2004h>         'port': port
[?2004l[?2004h>     })
[?2004l[?2004h> 
[?2004l[?2004h> for port in block_ports:
[?2004l[?2004h>     intermediate.append({
[?2004l[?2004h>         'type': 'block',
[?2004l[?2004h>         'protocol': 'tcp',
[?2004l[?2004h>         'ip': 'any',
[?2004l[?2004h>         'port': port
[?2004l[?2004h>     })
[?2004l[?2004h> 
[?2004l[?2004h> with open('intermediate.json', 'w') as f:
[?2004l[?2004h>     json.dump(intermediate, f, indent=2)
[?2004l[?2004h> 
[?2004l[?2004h> print("intermediate.json created")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate optimized_rules.v4
[?2004l[?2004h> rules = []
[?2004l[?2004h> 
[?2004l[?2004h> # Find and preserve state rule
[?2004l[?2004h> state_rule = None
[?2004l[?2004h> for i, line in enumerate(base_rules):
[?2004l[?2004h>     if "RELATED,ESTABLISHED" in line:
[?2004l[?2004h>         state_rule = line
[?2004l[?2004h>         del base_rules[i]
[?2004l[?2004h>         break
[?2004l[?2004h> 
[?2004l[?2004h> # Default policies
[?2004l[?2004h> rules.extend([
[?2004l[?2004h>     ":INPUT DROP [0:0]",
[?2004l[?2004h>     ":FORWARD DROP [0:0]",
[?2004l[?2004h>     ":OUTPUT ACCEPT [0:0]"
[?2004l[?2004h> ])
[?2004l[?2004h> 
[?2004l[?2004h> # Add state rule first
[?2004l[?2004h> if state_rule:
[?2004l[?2004h>     rules.append(state_rule)
[?2004l[?2004h> else:
[?2004l[?2004h>     rules.append("-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT")
[?2004l[?2004h> 
[?2004l[?2004h> # Create allow rules (ACCEPT from trusted_ip)
[?2004l[?2004h> allow_rules = []
[?2004l[?2004h> for port in sorted(allow_ports, key=int):
[?2004l[?2004h>     allow_rules.append(f"-A INPUT -p tcp --dport {port} -s {config['trusted_ip']} -j ACCEPT")
[?2004l[?2004h> 
[?2004l[?2004h> # Create block rules (DROP from any)
[?2004l[?2004h> block_rules = []
[?2004l[?2004h> for port in sorted(block_ports, key=int):
[?2004l[?2004h>     block_rules.append(f"-A INPUT -p tcp --dport {port} -j DROP")
[?2004l[?2004h> 
[?2004l[?2004h> # Combine and sort rules
[?2004l[?2004h> combined_rules = allow_rules + block_rules
[?2004l[?2004h> combined_rules.sort(key=lambda x: ("-A INPUT -p tcp --dport " in x, int(x.split('--dport ')[-1].split()[0])))
[?2004l[?2004h> 
[?2004l[?2004h> rules.extend(combined_rules)
[?2004l[?2004h> 
[?2004l[?2004h> # Add remaining base rules
[?2004l[?2004h> rules.extend(base_rules)
[?2004l[?2004h> 
[?2004l[?2004h> with open('optimized_rules.v4', 'w') as f:
[?2004l[?2004h>     f.write("*filter\n")
[?2004l[?2004h>     f.write("\n".join(rules))
[?2004l[?2004h>     f.write("\nCOMMIT\n")
[?2004l[?2004h> 
[?2004l[?2004h> print("optimized_rules.v4 created")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate audit_manifest.csv
[?2004l[?2004h> with open('audit_manifest.csv', 'wb') as f:
[?2004l[?2004h>     # Create CSV file with ISO-8859-1 encoding
[?2004l[?2004h>     writer = csv.writer(io.TextIOWrapper(f, encoding='iso-8859-1'), delimiter='|')
[?2004l[?2004h>     
[?2004l[?2004h>     # Header
[?2004l[?2004h>     writer.writerow(["timestamp", "action", "detail"])
[?2004l[?2004h>     
[?2004l[?2004h>     # Add entries
[?2004l[?2004h>     timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S")
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([
[?2004l[?2004h>         timestamp,
[?2004l[?2004h>         "changed",
[?2004l[?2004h>         "Â§INPUT policy set to DROP"
[?2004l[?2004h>     ])
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([
[?2004l[?2004h>         timestamp,
[?2004l[?2004h>         "changed",
[?2004l[?2004h>         "Â§FORWARD policy set to DROP"
[?2004l[?2004h>     ])
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([
[?2004l[?2004h>         timestamp,
[?2004l[?2004h>         "changed",
[?2004l[?2004h>         "Â§OUTPUT policy set to ACCEPT"
[?2004l[?2004h>     ])
[?2004l[?2004h>     
[?2004l[?2004h>     # Footer verification
[?2004l[?2004h>     with open('intermediate.json', 'rb') as json_file:
[?2004l[?2004h>         md5_hash = hashlib.md5(json_file.read()).hexdigest()
[?2004l[?2004h>     
[?2004l[?2004h>     with open('optimized_rules.v4', 'rb') as rules_file:
[?2004l[?2004h>         byte_count = len(rules_file.read())
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([f"Check: {md5_hash}"])
[?2004l[?2004h>     writer.writerow([f"Bytes: {byte_count}"])
[?2004l[?2004h> 
[?2004l[?2004h> print("audit_manifest.csv created")
[?2004l[?2004h> print("All tasks completed successfully!")
[?2004l[?2004h> EOF
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# chmod +x process_firewall.py
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# python3 process_firewall.py
[?2004lUsing config: configs/config3.json
Sanitized trusted_ip: 172.16.0.8
Expanded allow_ports: ['80', '443', '9000', '9001', '9002', '9003', '9004', '9005', '9006', '9007', '9008', '9009', '9010']
Expanded block_ports: ['25', '143', '993', '8080', '8081', '8082', '8083', '8084', '8085', '8086', '8087', '8088', '8089', '8090']
Base rules loaded: 11 lines
intermediate.json created
optimized_rules.v4 created
audit_manifest.csv created
All tasks completed successfully!
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# ls -la *.json *.v4 *.csv
[?2004l-rw-r--r-- 1 root root    0 Feb 13 19:06 audit_manifest.csv
-rwxr-xr-x 1 root root  335 Feb 12 22:36 [0m[01;32mbase_rules.v4[0m
-rw-r--r-- 1 root root 2489 Feb 13 19:06 intermediate.json
-rw-r--r-- 1 root root 1598 Feb 13 19:06 optimized_rules.v4
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat intermediate.json
[?2004l[
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "80"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "443"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9000"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9001"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9002"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9003"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9004"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9005"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9006"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9007"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9008"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9009"
  },
  {
    "type": "allow",
    "protocol": "tcp",
    "ip": "172.16.0.8",
    "port": "9010"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "25"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "143"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "993"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8080"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8081"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8082"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8083"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8084"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8085"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8086"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8087"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8088"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8089"
  },
  {
    "type": "block",
    "protocol": "tcp",
    "ip": "any",
    "port": "8090"
  }
][?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat optimized_rules.v4
[?2004l*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp --dport 25 -j DROP
-A INPUT -p tcp --dport 80 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 143 -j DROP
-A INPUT -p tcp --dport 443 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 993 -j DROP
-A INPUT -p tcp --dport 8080 -j DROP
-A INPUT -p tcp --dport 8081 -j DROP
-A INPUT -p tcp --dport 8082 -j DROP
-A INPUT -p tcp --dport 8083 -j DROP
-A INPUT -p tcp --dport 8084 -j DROP
-A INPUT -p tcp --dport 8085 -j DROP
-A INPUT -p tcp --dport 8086 -j DROP
-A INPUT -p tcp --dport 8087 -j DROP
-A INPUT -p tcp --dport 8088 -j DROP
-A INPUT -p tcp --dport 8089 -j DROP
-A INPUT -p tcp --dport 8090 -j DROP
-A INPUT -p tcp --dport 9000 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9001 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9002 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9003 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9004 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9005 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9006 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9007 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9008 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9009 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 9010 -s 172.16.0.8 -j ACCEPT
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -p tcp --dport 22 -j ACCEPT
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
-A INPUT -p tcp --dport 8080 -j ACCEPT
-A INPUT -p tcp --dport 3306 -j ACCEPT
COMMIT
COMMIT
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# file audit_manifest.csv
[?2004lbash: file: command not found
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# head -5 audit_manifest.csv
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# rm audit_manifest.csv optimized_rules.v4
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat > process_firewall.py << 'EOF'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> import json
[?2004l[?2004h> import os
[?2004l[?2004h> import re
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import csv
[?2004l[?2004h> import io
[?2004l[?2004h> import sys
[?2004l[?2004h> from datetime import datetime, timezone
[?2004l[?2004h> import glob
[?2004l[?2004h> 
[?2004l[?2004h> # Find most recent config file
[?2004l[?2004h> config_files = glob.glob("configs/*.json")
[?2004l[?2004h> config_files.sort(key=lambda x: os.path.getmtime(x))
[?2004l[?2004h> active_config = config_files[-1] if config_files else None
[?2004l[?2004h> 
[?2004l[?2004h> if not active_config:
[?2004l[?2004h>     print("Error: No config files found")
[?2004l[?2004h>     sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Using config: {active_config}")
[?2004l[?2004h> 
[?2004l[?2004h> # Read and sanitize config
[?2004l[?2004h> with open(active_config, 'r') as f:
[?2004l[?2004h>     try:
[?2004l[?2004h>         config = json.load(f)
[?2004l[?2004h>     except json.JSONDecodeError:
[?2004l[?2004h>         print(f"Error: Invalid JSON in {active_config}")
[?2004l[?2004h>         sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> # Sanitize values by removing zero width spaces and extra whitespace
[?2004l[?2004h> config['trusted_ip'] = re.sub(r'[\u200b\u200c]', '', config['trusted_ip'])
[?2004l[?2004h> config['trusted_ip'] = re.sub(r'\s+', '', config['trusted_ip'])
[?2004l[?2004h> 
[?2004l[?2004h> # Function to expand port ranges
[?2004l[?2004h> def expand_ports(ports):
[?2004l[?2004h>     expanded = []
[?2004l[?2004h>     for port in ports:
[?2004l[?2004h>         if '-' in port:
[?2004l[?2004h>             start, end = map(int, port.split('-'))
[?2004l[?2004h>             expanded.extend(str(p) for p in range(start, end + 1))
[?2004l[?2004h>         else:
[?2004l[?2004h>             expanded.append(port)
[?2004l[?2004h>     return [p for p in expanded if p.isdigit() and 0 <= int(p) <= 65535]
[?2004l[?2004h> 
[?2004l[?2004h> allow_ports = expand_ports(config.get('allow_ports', []))
[?2004l[?2004h> block_ports = expand_ports(config.get('block_ports', []))
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Sanitized trusted_ip: {config['trusted_ip']}")
[?2004l[?2004h> print(f"Expanded allow_ports: {allow_ports}")
[?2004l[?2004h> print(f"Expanded block_ports: {block_ports}")
[?2004l[?2004h> 
[?2004l[?2004h> # Read base rules
[?2004l[?2004h> try:
[?2004l[?2004h>     with open('base_rules.v4', 'r') as f:
[?2004l[?2004h>         base_rules = [line.strip() for line in f.readlines() if line.strip()]
[?2004l[?2004h> except FileNotFoundError:
[?2004l[?2004h>     base_rules = []
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Base rules loaded: {len(base_rules)} lines")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate intermediate.json
[?2004l[?2004h> intermediate = []
[?2004l[?2004h> for port in allow_ports:
[?2004l[?2004h>     intermediate.append({
[?2004l[?2004h>         'type': 'allow',
[?2004l[?2004h>         'protocol': 'tcp',
[?2004l[?2004h>         'ip': config['trusted_ip'],
[?2004l[?2004h>         'port': port
[?2004l[?2004h>     })
[?2004l[?2004h> 
[?2004l[?2004h> for port in block_ports:
[?2004l[?2004h>     intermediate.append({
[?2004l[?2004h>         'type': 'block',
[?2004l[?2004h>         'protocol': 'tcp',
[?2004l[?2004h>         'ip': 'any',
[?2004l[?2004h>         'port': port
[?2004l[?2004h>     })
[?2004l[?2004h> 
[?2004l[?2004h> with open('intermediate.json', 'w') as f:
[?2004l[?2004h>     json.dump(intermediate, f, indent=2)
[?2004l[?2004h> 
[?2004l[?2004h> print("intermediate.json created")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate optimized_rules.v4
[?2004l[?2004h> rules = []
[?2004l[?2004h> 
[?2004l[?2004h> # Find and preserve state rule
[?2004l[?2004h> state_rule = None
[?2004l[?2004h> for i, line in enumerate(base_rules):
[?2004l[?2004h>     if "RELATED,ESTABLISHED" in line:
[?2004l[?2004h>         state_rule = line
[?2004l[?2004h>         del base_rules[i]
[?2004l[?2004h>         break
[?2004l[?2004h> 
[?2004l[?2004h> # Default policies
[?2004l[?2004h> rules.extend([
[?2004l[?2004h>     ":INPUT DROP [0:0]",
[?2004l[?2004h>     ":FORWARD DROP [0:0]",
[?2004l[?2004h>     ":OUTPUT ACCEPT [0:0]"
[?2004l[?2004h> ])
[?2004l[?2004h> 
[?2004l[?2004h> # Add state rule first
[?2004l[?2004h> if state_rule:
[?2004l[?2004h>     rules.append(state_rule)
[?2004l[?2004h> else:
[?2004l[?2004h>     rules.append("-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT")
[?2004l[?2004h> 
[?2004l[?2004h> # Create allow rules (ACCEPT from trusted_ip)
[?2004l[?2004h> allow_rules = []
[?2004l[?2004h> for port in sorted(allow_ports, key=int):
[?2004l[?2004h>     allow_rules.append(f"-A INPUT -p tcp --dport {port} -s {config['trusted_ip']} -j ACCEPT")
[?2004l[?2004h> 
[?2004l[?2004h> # Create block rules (DROP from any)
[?2004l[?2004h> block_rules = []
[?2004l[?2004h> for port in sorted(block_ports, key=int):
[?2004l[?2004h>     block_rules.append(f"-A INPUT -p tcp --dport {port} -j DROP")
[?2004l[?2004h> 
[?2004l[?2004h> # Combine and sort rules
[?2004l[?2004h> combined_rules = allow_rules + block_rules
[?2004l[?2004h> combined_rules.sort(key=lambda x: ("-A INPUT -p tcp --dport " in x, int(x.split('--dport ')[-1].split()[0])))
[?2004l[?2004h> 
[?2004l[?2004h> rules.extend(combined_rules)
[?2004l[?2004h> 
[?2004l[?2004h> # Add remaining base rules
[?2004l[?2004h> rules.extend(base_rules)
[?2004l[?2004h> 
[?2004l[?2004h> with open('optimized_rules.v4', 'w') as f:
[?2004l[?2004h>     f.write("*filter\n")
[?2004l[?2004h>     f.write("\n".join(rules))
[?2004l[?2004h>     f.write("\nCOMMIT\n")
[?2004l[?2004h> 
[?2004l[?2004h> print("optimized_rules.v4 created")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate audit_manifest.csv
[?2004l[?2004h> with open('audit_manifest.csv', 'wb') as f:
[?2004l[?2004h>     # Create CSV file with ISO-8859-1 encoding
[?2004l[?2004h>     writer = csv.writer(io.TextIOWrapper(f, encoding='iso-8859-1'), delimiter='|')
[?2004l[?2004h>     
[?2004l[?2004h>     # Header
[?2004l[?2004h>     writer.writerow(["timestamp", "action", "detail"])
[?2004l[?2004h>     
[?2004l[?2004h>     # Add entries
[?2004l[?2004h>     timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S")
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([
[?2004l[?2004h>         timestamp,
[?2004l[?2004h>         "changed",
[?2004l[?2004h>         "Â§INPUT policy set to DROP"
[?2004l[?2004h>     ])
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([
[?2004l[?2004h>         timestamp,
[?2004l[?2004h>         "changed",
[?2004l[?2004h>         "Â§FORWARD policy set to DROP"
[?2004l[?2004h>     ])
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([
[?2004l[?2004h>         timestamp,
[?2004l[?2004h>         "changed",
[?2004l[?2004h>         "Â§OUTPUT policy set to ACCEPT"
[?2004l[?2004h>     ])
[?2004l[?2004h>     
[?2004l[?2004h>     # Footer verification
[?2004l[?2004h>     with open('intermediate.json', 'rb') as json_file:
[?2004l[?2004h>         md5_hash = hashlib.md5(json_file.read()).hexdigest()
[?2004l[?2004h>     
[?2004l[?2004h>     with open('optimized_rules.v4', 'rb') as rules_file:
[?2004l[?2004h>         byte_count = len(rules_file.read())
[?2004l[?2004h>     
[?2004l[?2004h>     writer.writerow([f"Check: {md5_hash}"])
[?2004l[?2004h>     writer.writerow([f"Bytes: {byte_count}"])
[?2004l[?2004h> 
[?2004l[?2004h> print("audit_manifest.csv created")
[?2004l[?2004h> print("All tasks completed successfully!")
[?2004l[?2004h> EOF
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# python3 process_firewall.py
[?2004lUsing config: configs/config3.json
Sanitized trusted_ip: 172.16.0.8
Expanded allow_ports: ['80', '443', '9000', '9001', '9002', '9003', '9004', '9005', '9006', '9007', '9008', '9009', '9010']
Expanded block_ports: ['25', '143', '993', '8080', '8081', '8082', '8083', '8084', '8085', '8086', '8087', '8088', '8089', '8090']
Base rules loaded: 11 lines
intermediate.json created
optimized_rules.v4 created
audit_manifest.csv created
All tasks completed successfully!
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# head -10 optimized_rules.v4
[?2004l*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp --dport 25 -j DROP
-A INPUT -p tcp --dport 80 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 143 -j DROP
-A INPUT -p tcp --dport 443 -s 172.16.0.8 -j ACCEPT
-A INPUT -p tcp --dport 993 -j DROP
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat audit_manifest.csv
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# wc -c audit_manifest.csv
[?2004l0 audit_manifest.csv
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# md5sum intermediate.json
[?2004l8c37d195ca16e19a9fff3d4b41a604d0  intermediate.json
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# rm audit_manifest.csv
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat > process_firewall.py << 'EOF'
[?2004l
with open('intermediate.json', 'r[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> import json
[?2004l[?2004h> import os
[?2004l[?2004h> import re
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import csv
[?2004l[?2004h> import io
[?2004l[?2004h> import sys
[?2004l[?2004h> from datetime import datetime, timezone
[?2004l[?2004h> import glob
[?2004l[?2004h> 
[?2004l[?2004h> # Find most recent config file
[?2004l[?2004h> config_files = glob.glob("configs/*.json")
[?2004l[?2004h> config_files.sort(key=lambda x: os.path.getmtime(x))
[?2004l[?2004h> active_config = config_files[-1] if config_files else None
[?2004l[?2004h> 
[?2004l[?2004h> if not active_config:
[?2004l[?2004h>     print("Error: No config files found")
[?2004l[?2004h>     sys.exit(1)
[?2004l[?2004h> 
[?2004ll[?2004h> print(f"Using config: {active_config}")
[?2004l[?2004h> 
[?2004l[?2004h> # Read and sanitize config
[?2004l[?2004h> with open(active_config, 'r') as f:
[?2004l[?2004h>     try:
[?2004l[?2004h>         config = json.load(f)
[?2004l[?2004h>     except json.JSONDecodeError:
[?2004l[?2004h>         print(f"Error: Invalid JSON in {active_config}")
[?2004l[?2004h>         sys.exit(1)
[?2004l[?2004h> 
[?2004l[?2004h> # Sanitize values by removing zero width spaces and extra whitespace
[?2004l[?2004h> config['trusted_ip'] = re.sub(r'[\u200b\u200c]', '', config['trusted_ip'])
[?2004l[?2004h> config['trusted_ip'] = re.sub(r'\s+', '', config['trusted_ip'])
[?2004l[?2004h> 
[?2004l[?2004h> # Function to expand port ranges
[?2004l[?2004h> def expand_ports(ports):
[?2004l[?2004h>     expanded = []
[?2004l[?2004h>     for port in ports:
[?2004l[?2004h>         if '-' in port:
[?2004l[?2004h>             start, end = map(int, port.split('-'))
[?2004l[?2004h>             expanded.extend(str(p) for p in range(start, end + 1))
[?2004l[?2004h>         else:
[?2004l[?2004h>             expanded.append(port)
[?2004l[?2004h>     return [p for p in expanded if p.isdigit() and 0 <= int(p) <= 65535]
[?2004l[?2004h> 
[?2004l[?2004h> allow_ports = expand_ports(config.get('allow_ports', []))
[?2004l[?2004h> block_ports = expand_ports(config.get('block_ports', []))
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Sanitized trusted_ip: {config['trusted_ip']}")
[?2004l[?2004h> print(f"Expanded allow_ports: {allow_ports}")
[?2004l[?2004h> print(f"Expanded block_ports: {block_ports}")
[?2004l[?2004h> 
[?2004l[?2004h> # Read base rules
[?2004l[?2004h> try:
[?2004l[?2004h>     with open('base_rules.v4', 'r') as f:
[?2004l[?2004h>         base_rules = [line.strip() for line in f.readlines() if line.strip()]
[?2004l[?2004h> except FileNotFoundError:
[?2004l[?2004h>     base_rules = []
[?2004l[?2004h> 
[?2004l[?2004h> print(f"Base rules loaded: {len(base_rules)} lines")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate intermediate.json
[?2004l[?2004h> intermediate = []
[?2004l[?2004h> for port in allow_ports:
[?2004l[?2004h>     intermediate.append({
[?2004l[?2004h>         'type': 'allow',
[?2004l[?2004h>         'protocol': 'tcp',
[?2004l[?2004h>         'ip': config['trusted_ip'],
[?2004l[?2004h>         'port': port
[?2004l[?2004h>     })
[?2004l[?2004h> 
[?2004l[?2004h> for port in block_ports:
[?2004l[?2004h>     intermediate.append({
[?2004l[?2004h>         'type': 'block',
[?2004l[?2004h>         'protocol': 'tcp',
[?2004l[?2004h>         'ip': 'any',
[?2004l[?2004h>         'port': port
[?2004l[?2004h>     })
[?2004l[?2004h> 
[?2004l[?2004h> with open('intermediate.json', 'w') as f:
[?2004l[?2004h>     json.dump(intermediate, f, indent=2)
[?2004l[?2004h> 
[?2004l[?2004h> print("intermediate.json created")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate optimized_rules.v4
[?2004l[?2004h> rules = []
[?2004l[?2004h> 
[?2004l[?2004h> # Find and preserve state rule
[?2004l[?2004h> state_rule = None
[?2004l[?2004h> for i, line in enumerate(base_rules):
[?2004l[?2004h>     if "RELATED,ESTABLISHED" in line:
[?2004l[?2004h>         state_rule = line
[?2004l[?2004h>         del base_rules[i]
[?2004l[?2004h>         break
[?2004l[?2004h> 
[?2004l[?2004h> # Default policies
[?2004l[?2004h> rules.extend([
[?2004l[?2004h>     ":INPUT DROP [0:0]",
[?2004l[?2004h>     ":FORWARD DROP [0:0]",
[?2004l[?2004h>     ":OUTPUT ACCEPT [0:0]"
[?2004l[?2004h> ])
[?2004l[?2004h> 
[?2004l[?2004h> # Add state rule first
[?2004l[?2004h> if state_rule:
[?2004l[?2004h>     rules.append(state_rule)
[?2004l[?2004h> else:
[?2004l[?2004h>     rules.append("-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT")
[?2004l[?2004h> 
[?2004l[?2004h> # Create allow rules (ACCEPT from trusted_ip)
[?2004l[?2004h> allow_rules = []
[?2004l[?2004h> for port in sorted(allow_ports, key=int):
[?2004l[?2004h>     allow_rules.append(f"-A INPUT -p tcp --dport {port} -s {config['trusted_ip']} -j ACCEPT")
[?2004l[?2004h> 
[?2004l[?2004h> # Create block rules (DROP from any)
[?2004l[?2004h> block_rules = []
[?2004l[?2004h> for port in sorted(block_ports, key=int):
[?2004l[?2004h>     block_rules.append(f"-A INPUT -p tcp --dport {port} -j DROP")
[?2004l[?2004h> 
[?2004l[?2004h> # Combine and sort rules
[?2004l[?2004h> combined_rules = allow_rules + block_rules
[?2004l[?2004h> combined_rules.sort(key=lambda x: ("-A INPUT -p tcp --dport " in x, int(x.split('--dport ')[-1].split()[0])))
[?2004l[?2004h> 
[?2004l[?2004h> rules.extend(combined_rules)
[?2004l[?2004h> 
[?2004l[?2004h> # Add remaining base rules
[?2004l[?2004h> rules.extend(base_rules)
[?2004l[?2004h> 
[?2004l[?2004h> with open('optimized_rules.v4', 'w') as f:
[?2004l[?2004h>     f.write("*filter\n")
[?2004l[?2004h>     f.write("\n".join(rules))
[?2004l[?2004h>     f.write("\nCOMMIT\n")
[?2004l[?2004h> 
[?2004l[?2004h> print("optimized_rules.v4 created")
[?2004l[?2004h> 
[?2004l[?2004h> # Generate audit_manifest.csv
[?2004l[?2004h> timestamp = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S")
[?2004l[?2004h> 
[?2004l[?2004h> data = [
[?2004l[?2004h>     [timestamp, "changed", "Â§INPUT policy set to DROP"],
[?2004l[?2004h>     [timestamp, "changed", "Â§FORWARD policy set to DROP"],
[?2004l[?2004h>     [timestamp, "changed", "Â§OUTPUT policy set to ACCEPT"]
[?2004l[?2004h> ]
[?2004l[?2004h> 
[?2004l[?2004h> # Create CSV content
[?2004l[?2004h> csv_output = io.StringIO()
[?2004l[?2004h> writer = csv.writer(csv_output, delimiter='|')
[?2004l[?2004h> writer.writerow(["timestamp", "action", "detail"])
[?2004l[?2004h> writer.writerows(data)
[?2004l[?2004h> 
[?2004l[?2004h> # Get CSV content
[?2004l[?2004h> csv_content = csv_output.getvalue()
[?2004l[?2004h> 
[?2004l[?2004h> # Add footer
[?2004l[?2004h> with open('intermediate.json', 'rb') as json_file:
[?2004l[?2004h>     md5_hash = hashlib.md5(json_file.read()).hexdigest()
[?2004l[?2004h> 
[?2004l[?2004h> with open('optimized_rules.v4', 'rb') as rules_file:
[?2004l[?2004h>     byte_count = len(rules_file.read())
[?2004l[?2004h> 
[?2004l[?2004h> footer = f"Check: {md5_hash}\nBytes: {byte_count}"
[?2004l[?2004h> csv_content += footer
[?2004l[?2004h> 
[?2004l[?2004h> # Write to file with ISO-8859-1 encoding
[?2004l[?2004h> with open('audit_manifest.csv', 'w', encoding='iso-8859-1') as f:
[?2004l[?2004h>     f.write(csv_content)
[?2004l[?2004h> 
[?2004l[?2004h> print("audit_manifest.csv created")
[?2004l[?2004h> print("All tasks completed successfully!")
[?2004l[?2004h> EOF
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# python3 process_firewall.py
[?2004lUsing config: configs/config3.json
Sanitized trusted_ip: 172.16.0.8
Expanded allow_ports: ['80', '443', '9000', '9001', '9002', '9003', '9004', '9005', '9006', '9007', '9008', '9009', '9010']
Expanded block_ports: ['25', '143', '993', '8080', '8081', '8082', '8083', '8084', '8085', '8086', '8087', '8088', '8089', '8090']
Base rules loaded: 11 lines
intermediate.json created
optimized_rules.v4 created
audit_manifest.csv created
All tasks completed successfully!
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# cat audit_manifest.csv
[?2004ltimestamp|action|detail
2026-02-13T19:08:41|changed|§INPUT policy set to DROP
2026-02-13T19:08:41|changed|§FORWARD policy set to DROP
2026-02-13T19:08:41|changed|§OUTPUT policy set to ACCEPT
Check: 8c37d195ca16e19a9fff3d4b41a604d0
Bytes: 1598[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# tail -5 optimized_rules.v4
[?2004l-A INPUT -p tcp --dport 443 -j ACCEPT
-A INPUT -p tcp --dport 8080 -j ACCEPT
-A INPUT -p tcp --dport 3306 -j ACCEPT
COMMIT
COMMIT
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# wc -l intermediate.json optimized_rules.v4 audit_manifest.csv
[?2004l 163 intermediate.json
  43 optimized_rules.v4
   5 audit_manifest.csv
 211 total
[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# grep 'section sign' audit_manifest.csv
[?2004l[?2004hroot@1420d0fc-ea92-4280-aba8-678707baa0a3:/home/user/firewall# 