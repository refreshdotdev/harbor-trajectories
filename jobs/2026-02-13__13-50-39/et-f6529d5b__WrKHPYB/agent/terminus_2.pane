[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# clear
[?2004l[H[J[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# ls -la /home/user/source_files/
[?2004ltotal 20
drwxr-xr-x 1 root root  159 Feb 12 23:59  [0m[01;34m.[0m
drwxr-xr-x 1 root root   34 Feb 12 23:59  [01;34m..[0m
-rw------- 1 root root    7 Feb 12 23:59  .secret
lrwxrwxrwx 1 root root   15 Feb 12 23:59  [40;31;01mbroken_link[0m -> [40;31;01m/does/not/exist[0m
-rw-r--r-- 1 root root   28 Feb 12 23:59  cafÃ©_notes.txt
-rw-r--r-- 1 root root 2048 Feb 12 23:59 'financials Q4.csv'
-rw-r--r-- 1 root root  500 Feb 12 23:59  ignored_binary.dat
lrwxrwxrwx 1 root root   17 Feb 12 23:59  [01;36mlink_to_financials.csv[0m -> 'financials Q4.csv'
-rw-r--r-- 1 root root   27 Feb 12 23:59  policy_doc.txt
drwxr-xr-x 1 root root   33 Feb 12 23:59  [01;34msubdir[0m
[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# mkdir -m 0700 /home/user/audit_2023Q4
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export AUDIT_START_TS=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "START       : 2023-Q4 checksum verification" > /home/user/audit_2023Q4/checksum_audit.log
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "START_TIME  : ${AUDIT_START_TS}" >> /home/user/audit_2023Q4/checksum_audit.log
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "FILE_RECORDS" >> /home/user/audit_2023Q4/checksum_audit.log
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export SECRET_KEY_CONTENT=$(cat /home/user/source_files/.secret | tr -d '[:space:]')
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export AUDIT_FILE_RECORDS=""
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export CURRENT_UTC_DATE=$(date -u +'%Y%m%d')
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export HMAC_KEY_FOR_JSON="${SECRET_KEY_CONTENT}${CURRENT_UTC_DATE}"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# unset CONFIG_FILE
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export CONFIG_FILE="/home/user/audit_2023Q4/checksum_audit.log"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export AUDIT_FILE_COUNT=0
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export TOTAL_BYTES=0
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# find /home/user/source_files/ -maxdepth 1 -type f -not -name '.*' -print0 | while IFS= read -r -d '' file_path; do
[?2004l[?2004h>   orig_filename=$(basename "$file_path")
[?2004l[?2004h>   file_size=$(stat -c%s "$file_path")
[?2004l[?2004h>   if [[ "${orig_filename##*.}" == "txt" || "${file_size}" -ge 1024 ]]; then
[?2004l[?2004h>     if [[ -L "$file_path" && ! -e "$file_path" ]]; then
[?2004l[?2004h>       continue
[?2004l[?2004h>     fi
[?2004l[?2004h>     sha256_hash=$(sha256sum "$file_path" | cut -d' ' -f1)
[?2004l[?2004h>     md5_hash=$(md5sum "$file_path" | cut -d' ' -f1)
[?2004l[?2004h>     AUDIT_FILE_RECORDS+="${orig_filename} SHA256=${sha256_hash}  MD5=${md5_hash}\n"
[?2004l[?2004h>     AUDIT_FILE_COUNT=$((AUDIT_FILE_COUNT + 1))
[?2004l[?2004h>     TOTAL_BYTES=$((TOTAL_BYTES + file_size))
[?2004l[?2004h>   fi
[?2004l[?2004h> done
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export SORTED_FILE_RECORDS=$(echo -n "$AUDIT_FILE_RECORDS" | LC_ALL=C sort)
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo -n "$SORTED_FILE_RECORDS" | iconv -t ISO-8859-1 >> "$CONFIG_FILE"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export LOG_CONTENT_BEFORE_END_TIME=$(cat "$CONFIG_FILE")
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export LOG_CHECKSUM=$(echo -n "$LOG_CONTENT_BEFORE_END_TIME" | sha256sum -b | cut -d' ' -f1)
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export LOG_SIG=$(echo -n "$LOG_CONTENT_BEFORE_END_TIME" | hmac_sha256 "${HMAC_KEY_FOR_JSON}")
[?2004lbash: hmac_sha256: command not found
[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export AUDIT_END_TS=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# cat > /home/user/audit_2023Q4/summary.json << EOF_JSON
[?2004l[?2004h> {
[?2004l[?2004h>   "period": "2023-Q4",
[?2004l[?2004h>   "file_count": ${AUDIT_FILE_COUNT},
[?2004l[?2004h>   "total_bytes": ${TOTAL_BYTES},
[?2004l[?2004h>   "start_time": "${AUDIT_START_TS}",
[?2004l[?2004h>   "end_time": "${AUDIT_END_TS}",
[?2004l[?2004h>   "status": "COMPLETED",
[?2004l[?2004h>   "log_checksum": "${LOG_CHECKSUM}",
[?2004l[?2004h>   "signature": "${LOG_SIG}"
[?2004l[?2004h> }
[?2004l[?2004h> EOF_JSON
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "END_TIME    : ${AUDIT_END_TS}" >> "$CONFIG_FILE"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "END         : 2023-Q4 checksum verification" >> "$CONFIG_FILE"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "VERIFICATION_PENDING" >> "$CONFIG_FILE"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# which hmac_sha256 || which openssl
[?2004l/usr/bin/openssl
[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export LOG_CONTENT_BEFORE_END_TIME_FINAL=$(cat "$CONFIG_FILE" | head -n -1)
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export LOG_CHECKSUM_FINAL=$(echo -n "$LOG_CONTENT_BEFORE_END_TIME_FINAL" | sha256sum -b | cut -d' ' -f1)
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export LOG_SIG_FINAL=""
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# if command -v openssl &> /dev/null; then
[?2004l[?2004h>   export LOG_SIG_FINAL=$(echo -n "$LOG_CONTENT_BEFORE_END_TIME_FINAL" | openssl dgst -sha256 -hmac "${HMAC_KEY_FOR_JSON}" | sed 's/^.* //')
[?2004l[?2004h> fi
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export VERIFICATION_STATUS="VERIFICATION_FAILED"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export ALL_HASHES_MATCH=true
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# export AUDIT_LOG_FILE_PATH="/home/user/audit_2023Q4/checksum_audit.log"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# # Read lines 3 to -2 from the log file (actual file records)
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# # Line 1: START, Line 2: START_TIME, Line 3: FILE_RECORDS
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# # Lines -2: END_TIME, -1: END (verification status is on new line after these in current state)
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# awk -v total_lines=$(wc -l < "$AUDIT_LOG_FILE_PATH") 'NR>=3 && NR<=(total_lines-2) {print $0}' "$AUDIT_LOG_FILE_PATH" | while IFS= read -r record_line; do
[?2004l[?2004h>   filename=$(echo "$record_line" | awk '{print $1}')
[?2004l[?2004h>   sha256_on_disk=$(sha256sum "${AUDIT_LOG_FILE_PATH%/*}/../source_files/${filename//\047\\\047/\\\047}" 2>/dev/null | cut -d' ' -f1)
[?2004l[?2004h>   if [ -z "$sha256_on_disk" ]; then
[?2004l[?2004h>     export ALL_HASHES_MATCH=false
[?2004l[?2004h>   elif [ "$sha256_on_disk" != "${filename#*=}" ]; then
[?2004l[?2004h>     export ALL_HASHES_MATCH=false
[?2004l[?2004h>   fi
[?2004l[?2004h> done
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# if [ "$ALL_HASHES_MATCH" = true ]; then
[?2004l[?2004h>   export VERIFICATION_STATUS="VERIFICATION_PASSED"
[?2004l[?2004h> else
[?2004l[?2004h>   export VERIFICATION_STATUS="VERIFICATION_FAILED"
[?2004l[?2004h> fi
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# sed -i '$ d' "$CONFIG_FILE" || sed -i '' '$ d' "$CONFIG_FILE"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# echo "${VERIFICATION_STATUS}" >> "$CONFIG_FILE"
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# cat > /home/user/audit_2023Q4/summary.json << EOF_JSON
[?2004l[?2004h> {
[?2004l[?2004h>   "period": "2023-Q4",
[?2004l[?2004h>   "file_count": ${AUDIT_FILE_COUNT},
[?2004l[?2004h>   "total_bytes": ${TOTAL_BYTES},
[?2004l[?2004h>   "start_time": "${AUDIT_START_TS}",
[?2004l[?2004h>   "end_time": "${AUDIT_END_TS}",
[?2004l[?2004h>   "status": "COMPLETED",
[?2004l[?2004h>   "log_checksum": "${LOG_CHECKSUM_FINAL}",
[?2004l[?2004h>   "signature": "${LOG_SIG_FINAL}"
[?2004l[?2004h> }
[?2004l[?2004h> EOF_JSON
[?2004l[?2004hroot@34f88313-0823-4ada-8ebe-7f4137319728:/home/user# 