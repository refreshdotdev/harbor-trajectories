Previous response had warnings:
WARNINGS: - Extra text detected before JSON object
- Extra text detected after JSON object

New Terminal Output:

root@ce985ef6-ff19-4a25-aec8-b2099227dc53:~# cd /home/user/storage
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# mkdir -p incoming archive
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# mkdir -p tmp
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# cat > maintenance_script.sh << 'EOF'
 MD5 hash
find archive/ -type f -print0 | while IFS= read -r -d '' file; do
    SIZE=$(stat -c%s "$file")
    MD5=$(md5sum "$file" | awk '{print $1}')
    # Escape filename for CSV (replace " with \", enclose in quotes if needed)
    SAFE_FILENAME=$(sed 's/"/\\"/g' <<< "${file#archive/}")
    if [[ "$SAFE_FILENAME" =~ ,[\\"] ]]; then
        SAFE_FILENAME="${SAFE_FILENAME//"/\\"}"
    fi
    echo "$SAFE_FILENAME,$SIZE,$MD5"
done | sort -t, -k3 | \
# Convert LF to CRLF
awk '{printf "%s\r\n", $0}' >> "archive/manifest.csv"

echo "Phase Three complete: manifest.csv generated with CRLF line endings"

# === Phase Four: Audit Report ===
# Create summary.xml in ISO-8859-1 encoding
MANIFEST_SHA1=$(sha1sum "archive/manifest.csv" | awk '{print $1}')

cat > "summary.xml" << EOF
<?xml version="1.0" encoding="ISO-8859-1"?>
<audit>
    <deleted_bytes>$DELETED_BYTES</deleted_bytes>
    <corrupt_files>$CORRUPT_COUNT</corrupt_files>
    <manifest_sha1>$MANIFEST_SHA1</manifest_sha1>
</audit>
EOF

# Convert XML to ISO-8859-1 encoding
iconv -f UTF-8 -t ISO-8859-1 > #!/bin/bash
>
> # Cleanup and maintenance script for legacy file storage server
> # This script implements all maintenance phases exactly as specified
>
> # === Configuration Phase ===
> CONFIG_FILE="params.conf"
>
> # Read configuration parameters, ignoring comments and empty lines
> if [[ ! -f "$CONFIG_FILE" ]]; then
>     echo "ERROR: Configuration file $CONFIG_FILE not found!"
>     exit 1
> fi
>
> # Extract parameters using awk to handle key=value format and ignore comments
> # This handles whitespace around = and ignores # comments
> CUTOFF_DAYS=$(awk -F= '/^[^#]/ {gsub(/\\s+/,",",$0); split($0, a, ","); if(a[1]=="cutoff_days") print a[2]}' "$CONFIG_FILE" 2>/dev/null || echo "0")
> MAX_BAK_KB=$(awk -F= '/^[^#]/ {gsub(/\\s+/,",",$0); split($0, a, ","); if(a[1]=="max_bak_kb") print a[2]}' "$CONFIG_FILE" 2>/dev/null || echo "0")
>
> # Convert max_bak_kb to bytes (1 KB = 1024 bytes)
> MAX_BAK_BYTES=$((MAX_BAK_KB * 1024))
>
> # Validate we got integers
> echo "Configuration loaded:"
> echo "  cutoff_days = $CUTOFF_DAYS"
> echo "  max_bak_kb = $MAX_BAK_KB ($((MAX_BAK_KB * 1024)) bytes)"
>
> # === Phase One: Pruning ===
> DELETED_BYTES=0
> find incoming/ -type f -name "*.bak" ! -name "_*.bak" ! -type l -print0 | while IFS= read -r -d '' file; do
>     # Skip system hold files (starting with _)
>     if [[ "${file##*/}" =~ ^_ ]]; then
>         echo "Skipping system hold file: ${file##*/}"
>         continue
>     fi
>
>     # Get file size in bytes
>     SIZE=$(stat -c%s "$file")
>
>     # Delete if strictly larger than max_bak_bytes
>     if [[ $SIZE -gt $MAX_BAK_BYTES ]]; then
>         echo "Deleting large .bak file: ${file##*/} (${SIZE} bytes)"
>         rm "$file"
>         DELETED_BYTES=$((DELETED_BYTES + SIZE))
>     fi
> done
>
> echo "Phase One complete: $DELETED_BYTES bytes deleted from .bak files"
>
> # === Phase Two: Archival ===
> CORRUPT_COUNT=0
> find incoming/ -type f -name "*.txt" ! -type l -print0 | while IFS= read -r -d '' file; do
>     # Skip directories, only process files
>     [[ ! -f "$file" ]] && continue
>
>     # Check file age in days
>     FILE_AGE_DAYS=$(($(date +%s) - $(stat -c%Y "$file")) / 86400)
>
>     # Only process if older than cutoff_days
>     if [[ $FILE_AGE_DAYS -gt $CUTOFF_DAYS ]]; then
>         echo "Processing old .txt file: ${file##*/} (${FILE_AGE_DAYS} days old)"
>
>         # Validate UTF-8 integrity
>         if iconv -f UTF-8 -t UTF-8 "$file" >/dev/null 2>&1; then
>             # Valid UTF-8: move to archive
>             DEST_FILE="archive/${file##*/}"
>             echo "Moving valid UTF-8 file to archive: ${file##*/}"
>             mv "$file" "$DEST_FILE"
>         else
>             # Corrupt: rename and leave in incoming
>             echo "Corrupt UTF-8 file: ${file##*/}"
>             mv "$file" "${file}.corrupt"
>             ((CORRUPT_COUNT++))
>         fi
>     fi
> done
>
> echo "Phase Two complete: $CORRUPT_COUNT corrupt files renamed"
>
> # === Phase Three: Manifest Generation ===
> # Create manifest.csv with CRLF line endings
> echo "Filename,Size,MD5" > "archive/manifest.csv"
>
> # Find all files in archive, compute MD5 and size, sort by MD5 hash
> find archive/ -type f -print0 | while IFS= read -r -d '' file; do
>     SIZE=$(stat -c%s "$file")
>     MD5=$(md5sum "$file" | awk '{print $1}')
>     # Escape filename for CSV (replace " with \", enclose in quotes if needed)
>     SAFE_FILENAME=$(sed 's/"/\\"/g' <<< "${file#archive/}")
>     if [[ "$SAFE_FILENAME" =~ ,[\\"] ]]; then
>         SAFE_FILENAME="${SAFE_FILENAME//"/\\"}"
>     fi
>     echo "$SAFE_FILENAME,$SIZE,$MD5"
> done | sort -t, -k3 | \
> # Convert LF to CRLF
> awk '{printf "%s\r\n", $0}' >> "archive/manifest.csv"
>
> echo "Phase Three complete: manifest.csv generated with CRLF line endings"
>
> # === Phase Four: Audit Report ===
> # Create summary.xml in ISO-8859-1 encoding
> MANIFEST_SHA1=$(sha1sum "archive/manifest.csv" | awk '{print $1}')
>
> cat > "summary.xml" << EOF
> <?xml version="1.0" encoding="ISO-8859-1"?>
> <audit>
>     <deleted_bytes>$DELETED_BYTES</deleted_bytes>
>     <corrupt_files>$CORRUPT_COUNT</corrupt_files>
>     <manifest_sha1>$MANIFEST_SHA1</manifest_sha1>
> </audit>
> EOF
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage#
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# # Convert XML to ISO-8859-1 encoding
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# iconv -f UTF-8 -t ISO-8859-1 "summary.xml" > "summary.xml.tmp"
iconv: cannot open input file `summary.xml': No such file or directory
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# mv "summary.xml.tmp" "summary.xml"
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage#
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# echo "Phase Four complete: summary.xml generated in ISO-8859-1 encoding"
Phase Four complete: summary.xml generated in ISO-8859-1 encoding
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage#
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# # === Final Cleanup ===
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# # Remove empty directories under incoming/
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# echo "Cleaning up empty directories..."
Cleaning up empty directories...
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# find incoming/ -type d -empty -delete
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage#
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# echo "Maintenance routine completed successfully!"
Maintenance routine completed successfully!
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# EOF
bash: EOF: command not found
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# chmod +x maintenance_script.sh
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage# echo "Script created successfully. Execute with: ./maintenance_script.sh"
Script created successfully. Execute with: ./maintenance_script.sh
root@ce985ef6-ff19-4a25-aec8-b2099227dc53:/home/user/storage#
