[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker# clear
[?2004l[H[J[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker# mkdir -p configs db logs reports
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker# cd configs
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# echo -e "Host 192.168.1.1\r\nUser admin\r\nPort 22\r\nIdentityFile \"/home/user/.ssh/id_rsa\"" > ssh.cfg
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# echo "# Copyright Â© 2023 Example Corp" > nginx.conf
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# echo -e "[app]\nname = myapp\nport = 8080\n\n# trailing whitespace test   " > app.ini
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# touch .hidden_file .gitkeep
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# echo "backup data" > old.config.bak
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# cd ..
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker# cd configs
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# sed -i 's/\r$//' ssh.cfg
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# iconv -f ISO-8859-1 -t UTF-8 nginx.conf > nginx.tmp && mv nginx.tmp nginx.conf
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# sed -i 's/[ \t]*$//' app.ini
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# ls -la
[?2004ltotal 16
drwxrwxrwx 1 root root 112 Feb 13 18:52 [0m[34;42m.[0m
drwxrwxrwx 1 root root  78 Feb 13 18:52 [34;42m..[0m
-rwxrwxrwx 1 root root  59 Feb 13 18:52 [01;32mapp.ini[0m
-rw-r--r-- 1 root root   0 Feb 13 18:52 .gitkeep
-rwxrwxrwx 1 root root   0 Feb 13 18:49 [01;32m.hidden[0m
-rw-r--r-- 1 root root   0 Feb 13 18:52 .hidden_file
-rw-r--r-- 1 root root  35 Feb 13 18:52 nginx.conf
-rw-r--r-- 1 root root  12 Feb 13 18:52 old.config.bak
-rwxrwxrwx 1 root root   0 Feb 13 18:49 [01;32mrestore.bak[0m
-rwxrwxrwx 1 root root  74 Feb 13 18:52 [01;32mssh.cfg[0m
[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# rm -f .hidden_file .gitkeep old.config.bak
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# ls -la
[?2004ltotal 12
drwxrwxrwx 1 root root 54 Feb 13 18:52 [0m[34;42m.[0m
drwxrwxrwx 1 root root 78 Feb 13 18:52 [34;42m..[0m
-rwxrwxrwx 1 root root 59 Feb 13 18:52 [01;32mapp.ini[0m
-rwxrwxrwx 1 root root  0 Feb 13 18:49 [01;32m.hidden[0m
-rw-r--r-- 1 root root 35 Feb 13 18:52 nginx.conf
-rwxrwxrwx 1 root root  0 Feb 13 18:49 [01;32mrestore.bak[0m
-rwxrwxrwx 1 root root 74 Feb 13 18:52 [01;32mssh.cfg[0m
[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# rm -f .hidden restore.bak
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# cat nginx.conf
[?2004l# Copyright Ã‚Â© 2023 Example Corp
[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker/configs# cd ..
[?2004l[?2004hroot@a1bcaa34-2d93-4e84-9324-2aed6c124b95:/home/user/cmtracker# cat > init_db.py << 'EOF'
[?2004l KEY AUTOINCREMENT,
            rel_path TEXT UNIQUE NOT NULL,
            file_hash TEXT NOT NULL,
            magic_hex TEXT NOT NULL,
            size_bytes INTEGER NOT NULL
        )''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS audit_events (
            event_id INTEGER PRIMARY KEY AUTOINCREMENT,
            file_id INTEGER NOT NULL,
            event_type TEXT NOT NULL CHECK(event_type IN ('INIT', 'MODIFY', 'PERM')),
            event_ts TEXT NOT NULL,
            FOREIGN KEY (file_id) REFERENCES tracked_files (id)
        )''')
    
    conn.commit()
    
    # Process files and insert into database
    files_processed = 0
    for filename in os.listdir(configs_dir):
        filepath = os.path.join(configs_dir, filename)
        if os.path.isfile(filepath):
            try:
                rel_path = filename
                file_hash = get_file_sha256(filepath)
                magic_hex = get_file_magic_hex(filepath)
                size_bytes = os.path.getsize(filepath)
                mtime_ts = datetime.datetime.fromtimestamp(os.path.getmtime(filepath)).strftime('%Y-%m-%d %H:%M:%S')
                
                cursor.execute('''
                    INSERT INTO tracked_files (rel_path, file_hash, magic_hex, size_bytes)
                    VALUES (?, ?, ?, ?)
                ''', (rel_path, file_hash, magic_hex, size_bytes))
                
                file_id = cursor.lastrowid
                
                cursor.execute('''
                    INSERT INTO audit_events (file_id, event_type, event_ts)
                    VALUES (?, 'INIT', ?)
                ''', (file_id, mtime_ts))
                
                files_processed += 1
                conn.commit()
                print(f"Processed: {filename}")
            except Exception as e:
                print(f"Error processing {filename}: {e}")
    
    print(f"{files_processed} files processed successfully")
    conn.close()

if __name__ == '__main__':
    main()
EOF[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> import sqlite3
[?2004l[?2004h> import os
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import datetime
[?2004l[?2004h> from pathlib import Path
[?2004l[?2004h> 
[?2004l[?2004h> def get_file_magic_hex(filepath):
[?2004l[?2004h>     """Get first 4 bytes of file as lowercase hex string."""
[?2004l[?2004h>     try:
[?2004l[?2004h>         with open(filepath, 'rb') as f:
[?2004l[?2004h>             magic_bytes = f.read(4)
[?2004l[?2004h>         return magic_bytes.hex().lower()
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         return ''
[?2004l[?2004h> 
[?2004l[?2004h> def get_file_sha256(filepath):
[?2004l[?2004h>     """Get SHA-256 hash of file content."""
[?2004l[?2004h>     try:
[?2004l[?2004h>         hash_sha256 = hashlib.sha256()
[?2004l[?2004h>         with open(filepath, 'rb') as f:
[?2004l[?2004h>             for chunk in iter(lambda: f.read(4096), b''):
[?2004l[?2004h>                 hash_sha256.update(chunk)
[?2004l[?2004h>         return hash_sha256.hexdigest()
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         return ''
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004l[?2004h>     db_path = 'db/audit.db'
[?2004l[?2004h>     configs_dir = 'configs'
[?2004l[?2004h>     
[?2004l[?2004h>     # Create database and tables
[?2004l[?2004h>     conn = sqlite3.connect(db_path)
[?2004l[?2004h>     cursor = conn.cursor()
[?2004l[?2004h>     
[?2004l[?2004h>     cursor.execute('''
[?2004l[?2004h>         CREATE TABLE IF NOT EXISTS tracked_files (
[?2004l[?2004h>             id INTEGER PRIMARY KEY AUTOINCREMENT,
[?2004l[?2004h>             rel_path TEXT UNIQUE NOT NULL,
[?2004l[?2004h>             file_hash TEXT NOT NULL,
[?2004l[?2004h>             magic_hex TEXT NOT NULL,
[?2004l[?2004h>             size_bytes INTEGER NOT NULL
[?2004l[?2004h>         )''')
[?2004l[?2004h>     
[?2004l[?2004h>     cursor.execute('''
[?2004l[?2004h>         CREATE TABLE IF NOT EXISTS audit_events (
[?2004l[?2004h>             event_id INTEGER PRIMARY KEY AUTOINCREMENT,
[?2004l[?2004h>             file_id INTEGER NOT NULL,
[?2004l[?2004h>             event_type TEXT NOT NULL CHECK(event_type IN ('INIT', 'MODIFY', 'PERM')),
[?2004l[?2004h>             event_ts TEXT NOT NULL,
[?2004l[?2004h>             FOREIGN KEY (file_id) REFERENCES tracked_files (id)
[?2004l[?2004h>         )''')
[?2004l[?2004h>     
[?2004l[?2004h>     conn.commit()
[?2004l[?2004h>     
[?2004l[?2004h>     # Process files and insert into database
[?2004l[?2004h>     files_processed = 0
[?2004l[?2004h>     for filename in os.listdir(configs_dir):
[?2004l[?2004h>         filepath = os.path.join(configs_dir, filename)
[?2004l[?2004h>         if os.path.isfile(filepath):
[?2004l[?2004h>             try:
[?2004l[?2004h>                 rel_path = filename
[?2004l[?2004h>                 file_hash = get_file_sha256(filepath)
[?2004l[?2004h>                 magic_hex = get_file_magic_hex(filepath)
[?2004l[?2004h>                 size_bytes = os.path.getsize(filepath)
[?2004l[?2004h>                 mtime_ts = datetime.datetime.fromtimestamp(os.path.getmtime(filepath)).strftime('%Y-%m-%d %H:%M:%S')
[?2004l[?2004h>                 
[?2004l[?2004h>                 cursor.execute('''
[?2004l[?2004h>                     INSERT INTO tracked_files (rel_path, file_hash, magic_hex, size_bytes)
[?2004l[?2004h>                     VALUES (?, ?, ?, ?)
[?2004l[?2004h>                 ''', (rel_path, file_hash, magic_hex, size_bytes))
[?2004l[?2004h>                 
[?2004l[?2004h>                 file_id = cursor.lastrowid
[?2004l[?2004h>                 
[?2004l[?2004h>                 cursor.execute('''
[?2004l[?2004h>                     INSERT INTO audit_events (file_id, event_type, event_ts)
[?2004l[?2004h>                     VALUES (?, 'INIT', ?)
[?2004l[?2004h>                 ''', (file_id, mtime_ts))
[?2004l[?2004h>                 
[?2004l[?2004h>                 files_processed += 1
[?2004l[?2004h>                 conn.commit()
[?2004l[?2004h>                 print(f"Processed: {filename}")
[?2004l[?2004h>             except Exception as e:
[?2004l[?2004h>                 print(f"Error processing {filename}: {e}")
[?2004l[?2004h>     
[?2004l[?2004h>     print(f"{files_processed} files processed successfully")
[?2004l[?2004h>     conn.close()
[?2004l[?2004h> 
[?2004l[?2004h> if __name__ == '__main__':
[?2004l[?2004h>     main()
[?2004l[?2004h> EOFchmod +x init_db.py
[?2004l[?2004h> python3 init_db.py
[?2004l[?2004h> cd configs
[?2004l[?2004h> sed -i '1s/^/# URGENT SECURITY PATCH\n/' ssh.cfg
[?2004l[?2004h> sleep 1
[?2004l[?2004h> chmod 400 nginx.conf
[?2004l[?2004h> cd ..
[?2004l[?2004h> cat > update_db.py << 'EOF'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> import sqlite3
[?2004l[?2004h> import os
[?2004l[?2004h> import hashlib
[?2004l[?2004h> import datetime
[?2004l[?2004h> 
[?2004l[?2004h> def get_file_magic_hex(filepath):
[?2004l[?2004h>     """Get first 4 bytes of file as lowercase hex string."""
[?2004l[?2004h>     try:
[?2004l[?2004h>         with open(filepath, 'rb') as f:
[?2004l[?2004h>             magic_bytes = f.read(4)
[?2004l[?2004h>         return magic_bytes.hex().lower()
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         return ''
[?2004l[?2004h> 
[?2004l[?2004h> def get_file_sha256(filepath):
[?2004l[?2004h>     """Get SHA-256 hash of file content."""
[?2004l[?2004h>     try:
[?2004l[?2004h>         hash_sha256 = hashlib.sha256()
[?2004l[?2004h>         with open(filepath, 'rb') as f:
[?2004l[?2004h>             for chunk in iter(lambda: f.read(4096), b''):
[?2004l[?2004h>                 hash_sha256.update(chunk)
[?2004l[?2004h>         return hash_sha256.hexdigest()
[?2004l[?2004h>     except Exception as e:
[?2004l[?2004h>         return ''
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004l[?2004h>     db_path = 'db/audit.db'
[?2004l[?2004h>     configs_dir = 'configs'
[?2004l[?2004h>     
[?2004l[?2004h>     conn = sqlite3.connect(db_path)
[?2004l[?2004h>     cursor = conn.cursor()
[?2004l[?2004h>     
[?2004l[?2004h>     # Update ssh.cfg record and add MODIFY event
[?2004l[?2004h>     ssh_cfg_path = os.path.join(configs_dir, 'ssh.cfg')
[?2004l[?2004h>     if os.path.exists(ssh_cfg_path):
[?2004l[?2004h>         try:
[?2004l[?2004h>             new_file_hash = get_file_sha256(ssh_cfg_path)
[?2004l[?2004h>             new_magic_hex = get_file_magic_hex(ssh_cfg_path)
[?2004l[?2004h>             new_size_bytes = os.path.getsize(ssh_cfg_path)
[?2004l[?2004h>             mtime_ts = datetime.datetime.fromtimestamp(os.path.getmtime(ssh_cfg_path)).strftime('%Y-%m-%d %H:%M:%S')
[?2004l[?2004h>             
[?2004l[?2004h>             # Get current file ID
[?2004l[?2004h>             cursor.execute('SELECT id FROM tracked_files WHERE rel_path = ?', ('ssh.cfg',))
[?2004l[?2004h>             file_id = cursor.fetchone()[0]
[?2004l[?2004h>             
[?2004l[?2004h>             # Update tracked_files record
[?2004l[?2004h>             cursor.execute('''
[?2004l[?2004h>                 UPDATE tracked_files 
[?2004l[?2004h>                 SET file_hash = ?, magic_hex = ?, size_bytes = ?
[?2004l[?2004h>                 WHERE id = ?
[?2004l[?2004h>             ''', (new_file_hash, new_magic_hex, new_size_bytes, file_id))
[?2004l[?2004h>             
[?2004l[?2004h>             # Add MODIFY event
[?2004l[?2004h>             cursor.execute('''
[?2004l[?2004h>                 INSERT INTO audit_events (file_id, event_type, event_ts)
[?2004l[?2004h>                 VALUES (?, 'MODIFY', ?)
[?2004l[?2004h>             ''', (file_id, mtime_ts))
[?2004l[?2004h>             
[?2004l[?2004h>             print("Updated ssh.cfg in database")
[?2004l[?2004h>         except Exception as e:
[?2004l[?2004h>             print(f"Error updating ssh.cfg: {e}")
[?2004l[?2004h>     
[?2004l[?2004h>     # Add PERM event for nginx.conf
[?2004l[?2004h>     nginx_cfg_path = os.path.join(configs_dir, 'nginx.conf')
[?2004l[?2004h>     if os.path.exists(nginx_cfg_path):
[?2004l[?2004h>         try:
[?2004l[?2004h>             cursor.execute('SELECT id FROM tracked_files WHERE rel_path = ?', ('nginx.conf',))
[?2004l[?2004h>             file_id = cursor.fetchone()[0]
[?2004l[?2004h>             current_time = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')
[?2004l[?2004h>             
[?2004l[?2004h>             cursor.execute('''
[?2004l[?2004h>                 INSERT INTO audit_events (file_id, event_type, event_ts)
[?2004l[?2004h>                 VALUES (?, 'PERM', ?)
[?2004l[?2004h>             ''', (file_id, current_time))
[?2004l[?2004h>             
[?2004l[?2004h>             print("Added PERM event for nginx.conf")
[?2004l[?2004h>         except Exception as e:
[?2004l[?2004h>             print(f"Error adding PERM event: {e}")
[?2004l[?2004h>     
[?2004l[?2004h>     conn.commit()
[?2004l[?2004h>     conn.close()
[?2004l[?2004h>     print("Database update complete")
[?2004l[?2004h> 
[?2004l[?2004h> if __name__ == '__main__':
[?2004l[?2004h>     main()
[?2004l[?2004h> EOFchmod +x update_db.py
[?2004l[?2004h> python3 update_db.py
[?2004l[?2004h> cat > version.txt << 'EOF'
[?2004l[?2004h> v1.2.3-RELEASE
[?2004l[?2004h> EOFcat > generate_report.py << 'EOF'
[?2004l[?2004h> #!/usr/bin/env python3
[?2004l[?2004h> import sqlite3
[?2004l[?2004h> import csv
[?2004l[?2004h> import datetime
[?2004l[?2004h> 
[?2004l[?2004h> def main():
[?2004l[?2004h>     db_path = 'db/audit.db'
[?2004l[?2004h>     report_path = 'reports/audit_summary.csv'
[?2004l[?2004h>     sql_log_path = 'logs/sql_history.log'
[?2004l[?2004h>     
[?2004l[?2004h>     # Create reports directory if needed
[?2004l[?2004h>     import os
[?2004l[?2004h>     os.makedirs('reports', exist_ok=True)
[?2004l[?2004h>     
[?2004l[?2004h>     # Read version from file
[?2004l[?2004h>     try:
[?2004l[?2004h>         with open('version.txt', 'r') as f:
[?2004l[?2004h>             version = f.read().strip()
[?2004l[?2004h>     except:
[?2004l[?2004h>         version = "UNKNOWN"
[?2004l[?2004h>     
[?2004l[?2004h>     # Connect to database and enable logging
[?2004l[?2004h>     conn = sqlite3.connect(db_path)
[?2004l[?2004h>     conn.set_trace_callback(lambda sql: open(sql_log_path, 'a').write(sql + '\n'))
[?2004l[?2004h>     
[?2004l[?2004h>     cursor = conn.cursor()
[?2004l[?2004h>     
[?2004l[?2004h>     # Get data for report
[?2004l[?2004h>     cursor.execute('''
[?2004l[?2004h>         SELECT 
[?2004l[?2004h>             tf.rel_path,
[?2004l[?2004h>             ae.event_type,
[?2004l[?2004h>             tf.file_hash,
[?2004l[?2004h>             MIN(ae.event_ts) as first_event_ts
[?2004l[?2004h>         FROM tracked_files tf
[?2004l[?2004h>         JOIN audit_events ae ON tf.id = ae.file_id
[?2004l[?2004h>         GROUP BY tf.rel_path, ae.event_type, tf.file_hash
[?2004l[?2004h>         ORDER BY ae.event_type, tf.rel_path
[?2004l[?2004h>     ''')
[?2004l[?2004h>     
[?2004l[?2004h>     # Generate report
[?2004l[?2004h>     with open(report_path, 'w') as csvfile:
[?2004l[?2004h>         writer = csv.writer(csvfile, delimiter=';', lineterminator='\n')
[?2004l[?2004h>         writer.writerow([f"PATH;EVENT;HASH;VERSION={version}"])
[?2004l[?2004h>         
[?2004l[?2004h>         for row in cursor.fetchall():
[?2004l[?2004h>             writer.writerow(row)
[?2004l[?2004h>     
[?2004l[?2004h>     print(f"Report generated at: {report_path}")
[?2004l[?2004h>     
[?2004l[?2004h>     # Calculate database checksum for integrity check
[?2004l[?2004h>     conn.close()
[?2004l[?2004h>     
[?2004l[?2004h>     import hashlib
[?2004l[?2004h>     sha256 = hashlib.sha256()
[?2004l[?2004h>     with open(db_path, 'rb') as f:
[?2004l[?2004h>         while True:
[?2004l[?2004h>             data = f.read(4096)
[?2004l[?2004h>             if not data:
[?2004l[?2004h>                 break
[?2004l[?2004h>             sha256.update(data)
[?2004l[?2004h>     db_checksum = sha256.hexdigest()
[?2004l[?2004h>     
[?2004l[?2004h>     # Append integrity checksum to SQL log
[?2004l[?2004h>     with open(sql_log_path, 'a') as f:
[?2004l[?2004h>         f.write(f"-- DB_CHECKSUM: {db_checksum}\n")
[?2004l[?2004h>     
[?2004l[?2004h>     print(f"Database checksum: {db_checksum}")
[?2004l[?2004h>     print("SQL log updated with integrity checksum")
[?2004l[?2004h> 
[?2004l[?2004h> if __name__ == '__main__':
[?2004l[?2004h>     main()
[?2004l[?2004h> EOFchmod +x generate_report.py
[?2004l[?2004h> python3 generate_report.py
[?2004l[?2004h> ls -la reports/
[?2004l[?2004h> head -5 reports/audit_summary.csv
[?2004l[?2004h> tail -5 logs/sql_history.log
[?2004l[?2004h> 