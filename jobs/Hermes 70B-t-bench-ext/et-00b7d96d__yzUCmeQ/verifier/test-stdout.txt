bash: solve.sh: No such file or directory
============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /tests
collecting ... collected 6 items

../tests/test_final_state.py::test_directory_cleanliness FAILED          [ 16%]
../tests/test_final_state.py::test_virtualenv_and_patch PASSED           [ 33%]
../tests/test_final_state.py::test_requirements_encoding_and_content FAILED [ 50%]
../tests/test_final_state.py::test_install_log_formatting_and_permissions FAILED [ 66%]
../tests/test_final_state.py::test_inventory_integrity FAILED            [ 83%]
../tests/test_final_state.py::test_packages_installed FAILED             [100%]

=================================== FAILURES ===================================
__________________________ test_directory_cleanliness __________________________

    def test_directory_cleanliness():
        """Verify api-test is a real directory, not the pre-existing symlink trap."""
>       _assert_exists(PROJECT_DIR, is_dir=True)

/tests/test_final_state.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

path = PosixPath('/home/user/api-test'), is_dir = True, is_file = False

    def _assert_exists(path: Path, is_dir: bool = False, is_file: bool = False):
        assert path.exists(), f"Expected '{path}' to exist, but it is missing."
        if is_dir:
            assert path.is_dir(), f"Expected '{path}' to be a directory. Check if it is a symlink or file."
>           assert not path.is_symlink(), f"'{path}' is a symlink, but should be a real directory."
E           AssertionError: '/home/user/api-test' is a symlink, but should be a real directory.
E           assert not True
E            +  where True = is_symlink()
E            +    where is_symlink = PosixPath('/home/user/api-test').is_symlink

/tests/test_final_state.py:31: AssertionError
____________________ test_requirements_encoding_and_content ____________________

    def test_requirements_encoding_and_content():
        """Verify requirements.txt is UTF-16LE with BOM."""
        _assert_exists(REQUIREMENTS_FILE, is_file=True)
    
        raw_bytes = REQUIREMENTS_FILE.read_bytes()
    
        # Check BOM for UTF-16LE (FF FE)
>       assert raw_bytes.startswith(b'\xff\xfe'), "requirements.txt does not have the correct UTF-16LE BOM."
E       AssertionError: requirements.txt does not have the correct UTF-16LE BOM.
E       assert False
E        +  where False = <built-in method startswith of bytes object at 0x79b496f07590>(b'\xff\xfe')
E        +    where <built-in method startswith of bytes object at 0x79b496f07590> = b'\xfe\xffh\x00t\x00t\x00p\x00x\x00=\x00=\x000\x00.\x002\x004\x00.\x001\x00\n\xfe\xff\x00r\x00e\x00q\x00u\x00e\x00s\x00t\x00s\x00=\x00=\x002\x00.\x003\x000\x00.\x000\x00\n'.startswith

/tests/test_final_state.py:62: AssertionError
_________________ test_install_log_formatting_and_permissions __________________

    def test_install_log_formatting_and_permissions():
        """Verify install.log is UTF-8, CRLF, and mode 0444."""
        _assert_exists(INSTALL_LOG, is_file=True)
    
        # Check permissions
        st = os.stat(INSTALL_LOG)
        mode = stat.S_IMODE(st.st_mode)
        assert mode == 0o444, f"Expected permissions 0444 (r--r--r--) for install.log, got {oct(mode)}"
    
        # Check content and line endings
        raw_bytes = INSTALL_LOG.read_bytes()
    
        # Should NOT have UTF-16 BOM
        assert not raw_bytes.startswith(b'\xff\xfe'), "install.log should be UTF-8, not UTF-16."
    
        content = raw_bytes.decode("utf-8")
        assert "\r\n" in content, "install.log must use CRLF line endings."
    
        expected_lines = sorted([
            f"httpx {EXPECTED_HTTPX}",
            f"requests {EXPECTED_REQUESTS}"
        ])
    
        # Split by CRLF to verify
        actual_lines = sorted([l for l in content.split("\r\n") if l.strip()])
>       assert actual_lines == expected_lines, f"install.log content mismatch.\nExpected: {expected_lines}\nGot: {actual_lines}"
E       AssertionError: install.log content mismatch.
E         Expected: ['httpx 0.25.1', 'requests 2.31.0']
E         Got: ['httpx 0.24.1', 'requests 2.30.0\n']
E       assert ['httpx 0.24....sts 2.30.0\n'] == ['httpx 0.25....uests 2.31.0']
E         
E         At index 0 diff: 'httpx 0.24.1' != 'httpx 0.25.1'
E         
E         Full diff:
E           [
E         -     'httpx 0.25.1',
E         ?               ^...
E         
E         ...Full output truncated (7 lines hidden), use '-vv' to show

/tests/test_final_state.py:105: AssertionError
___________________________ test_inventory_integrity ___________________________

    def test_inventory_integrity():
        """Verify inventory.json hashes, including the setup_hash."""
        _assert_exists(INVENTORY_FILE, is_file=True)
    
        data = json.loads(INVENTORY_FILE.read_text(encoding="utf-8"))
    
        # Verify package hashes
>       assert data["httpx"] == calculate_sha256(f"httpx=={EXPECTED_HTTPX}")
E       AssertionError: assert '460170443474...bb3ea6f90d78b' == '79376fc4dfaf...36bb9f34b24d9'
E         
E         - 79376fc4dfaf14f47ef6ab0e826ffbad527afc39f7a76a19efc36bb9f34b24d9
E         + 460170443474330d1d04461bc3f5650bd55c56b00f31d679fb0bb3ea6f90d78b

/tests/test_final_state.py:114: AssertionError
___________________________ test_packages_installed ____________________________

    def test_packages_installed():
        """Verify the correct versions are actually installed in the venv."""
        _assert_exists(PYTHON_BIN, is_file=True)
    
        inspection_code = "import httpx, requests, json; print(json.dumps({'httpx': httpx.__version__, 'requests': requests.__version__}))"
    
        result = subprocess.run(
            [str(PYTHON_BIN), "-c", inspection_code],
            capture_output=True,
            text=True,
            check=True
        )
        installed = json.loads(result.stdout)
    
>       assert installed["httpx"] == EXPECTED_HTTPX, f"Installed httpx version {installed['httpx']} != expected {EXPECTED_HTTPX}"
E       AssertionError: Installed httpx version 0.24.1 != expected 0.25.1
E       assert '0.24.1' == '0.25.1'
E         
E         - 0.25.1
E         ?    ^
E         + 0.24.1
E         ?    ^

/tests/test_final_state.py:141: AssertionError
=========================== short test summary info ============================
FAILED ../tests/test_final_state.py::test_directory_cleanliness - AssertionEr...
FAILED ../tests/test_final_state.py::test_requirements_encoding_and_content
FAILED ../tests/test_final_state.py::test_install_log_formatting_and_permissions
FAILED ../tests/test_final_state.py::test_inventory_integrity - AssertionErro...
FAILED ../tests/test_final_state.py::test_packages_installed - AssertionError...
========================= 5 failed, 1 passed in 0.16s ==========================
