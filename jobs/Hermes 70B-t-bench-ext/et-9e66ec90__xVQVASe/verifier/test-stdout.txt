============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-9.0.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
rootdir: /tests
collecting ... collected 4 items

../../tests/test_final_state.py::test_preflight_exists_and_valid FAILED  [ 25%]
../../tests/test_final_state.py::test_manifest_is_crlf_and_correct FAILED [ 50%]
../../tests/test_final_state.py::test_log_encoding_and_content FAILED    [ 75%]
../../tests/test_final_state.py::test_no_extra_files FAILED              [100%]

=================================== FAILURES ===================================
_______________________ test_preflight_exists_and_valid ________________________

    def test_preflight_exists_and_valid():
        """Verify preflight.json exists, is compact, and has correct values."""
        assert PREFLIGHT_FILE.exists(), "Preflight file missing"
        content = PREFLIGHT_FILE.read_text(encoding='utf-8')
>       assert content == EXPECTED_PREFLIGHT_STR, f"Preflight JSON mismatch.\nExpected: {EXPECTED_PREFLIGHT_STR}\nActual: {content}"
E       AssertionError: Preflight JSON mismatch.
E         Expected: {"app_name":"titan_omega","environment":"prod_\u00a71","api_key_processed":"OTlfdG5lZ2FfdGVyY2Vz","template_hash":"e3b0c442"}
E         Actual: {"app_name":"titan_omega","environment":"prod_ยง1","api_key_processed":"OTlfdG5lZ2FfdGVyY2VzCg==","template_hash":"e3b0c442"}
E       assert '{"app_name":...":"e3b0c442"}' == '{"app_name":...":"e3b0c442"}'
E         
E         - {"app_name":"titan_omega","environment":"prod_\u00a71","api_key_processed":"OTlfdG5lZ2FfdGVyY2Vz","template_hash":"e3b0c442"}
E         ?                                               ^^^^^^
E         + {"app_name":"titan_omega","environment":"prod_ยง1","api_key_processed":"OTlfdG5lZ2FfdGVyY2VzCg==","template_hash":"e3b0c442"}
E         ?                                               ^                                            ++++

/tests/test_final_state.py:100: AssertionError
______________________ test_manifest_is_crlf_and_correct _______________________

    def test_manifest_is_crlf_and_correct():
        """Verify manifest content and line endings."""
        assert RENDERED_FILE.exists(), "Rendered manifest missing"
        content_bytes = RENDERED_FILE.read_bytes()
    
        # Check for CRLF
        if b'\r\n' not in content_bytes:
>           pytest.fail("Manifest does not contain CRLF line endings.")
E           Failed: Manifest does not contain CRLF line endings.

/tests/test_final_state.py:109: Failed
________________________ test_log_encoding_and_content _________________________

    def test_log_encoding_and_content():
        """Verify log file exists, is ISO-8859-1, and matches format."""
        assert LOG_FILE.exists(), "Log file missing"
    
        # 1. Verify Encoding: It should contain the byte 0xA7 for the section sign
        raw_bytes = LOG_FILE.read_bytes()
    
        # If it was UTF-8, the section sign would be 0xC2 0xA7.
        # In ISO-8859-1, it is 0xA7.
        assert b'\xa7' in raw_bytes, "Log file does not appear to contain the section sign (ยง) or is not encoded correctly (expected byte 0xA7)."
        assert b'\xc2\xa7' not in raw_bytes, "Log file appears to be UTF-8 encoded (found 0xC2 0xA7), but ISO-8859-1 was required."
    
        # 2. Verify Content by decoding as Latin-1
        content = raw_bytes.decode('iso-8859-1').strip().split('\n')
    
        expected_lines = [
            f"APP_NAME={EXPECTED_CONFIG['APP_NAME']}",
            f"ENVIRONMENT={EXPECTED_CONFIG['ENVIRONMENT']}",
            f"PREFLIGHT_HASH={EXPECTED_PREFLIGHT_HASH}",
            f"MANIFEST_HASH={EXPECTED_MANIFEST_HASH}"
        ]
    
        assert len(content) == len(expected_lines), "Log line count mismatch"
        for actual, expected in zip(content, expected_lines):
>           assert actual == expected, f"Log mismatch. Expected: {expected}, Got: {actual}"
E           AssertionError: Log mismatch. Expected: PREFLIGHT_HASH=71c44d42adc0f058c7af684bad32abbc, Got: PREFLIGHT_HASH=43fbefa8a10810ff2ec72db5389343e1
E           assert 'PREFLIGHT_HA...72db5389343e1' == 'PREFLIGHT_HA...f684bad32abbc'
E             
E             - PREFLIGHT_HASH=71c44d42adc0f058c7af684bad32abbc
E             + PREFLIGHT_HASH=43fbefa8a10810ff2ec72db5389343e1

/tests/test_final_state.py:145: AssertionError
_____________________________ test_no_extra_files ______________________________

    def test_no_extra_files():
        """Ensure strict file hygiene."""
        allowed = {
            "templates", "templates/deployment.yaml.tpl",
            "config", "config/base.env", "config/overlay.env", "config/defaults.env",
            "audit", "audit/preflight.json",
            "rendered", "rendered/deployment.yaml",
            "logs", "logs/render.log"
        }
    
        actual_files = set()
        for root, dirs, files in os.walk(K8S_DIR):
            root_path = Path(root)
            for d in dirs:
                actual_files.add(str((root_path / d).relative_to(K8S_DIR)))
            for f in files:
                actual_files.add(str((root_path / f).relative_to(K8S_DIR)))
    
        unexpected = actual_files - allowed
>       assert not unexpected, f"Unexpected files found: {unexpected}"
E       AssertionError: Unexpected files found: {'config/overlay.env.cleaned'}
E       assert not {'config/overlay.env.cleaned'}

/tests/test_final_state.py:166: AssertionError
=========================== short test summary info ============================
FAILED ../../tests/test_final_state.py::test_preflight_exists_and_valid - Ass...
FAILED ../../tests/test_final_state.py::test_manifest_is_crlf_and_correct - F...
FAILED ../../tests/test_final_state.py::test_log_encoding_and_content - Asser...
FAILED ../../tests/test_final_state.py::test_no_extra_files - AssertionError:...
============================== 4 failed in 0.03s ===============================
