[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user# clear
[?2004l[H[J[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user# mkdir -p /home/user/cert_analysis
[?2004l[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user# cd /home/user/certs_incoming
[?2004l[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user/certs_incoming# ls -la
[?2004ltotal 0
drwxr-xr-x 1 1000 1000 109 Feb 12 23:59 [0m[01;34m.[0m
drwxr-xr-x 1 1000 1000  35 Feb 13 18:59 [01;34m..[0m
drwxr-xr-x 1 1000 1000  73 Feb 12 23:59 [01;34mbroken[0m
drwxr-xr-x 1 1000 1000  65 Feb 12 23:59 [01;34mdb[0m
drwxr-xr-x 1 1000 1000  45 Feb 12 23:59 [01;34mghost[0m
drwxr-xr-x 1 1000 1000  71 Feb 12 23:59 [01;34mlegacy[0m
drwxr-xr-x 1 1000 1000  61 Feb 12 23:59 [01;34mweb[0m
drwxr-xr-x 1 1000 1000  73 Feb 12 23:59 [01;34mweird[0m
[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user/certs_incoming# find . -name "*.meta" -print
[?2004l./broken/server_bad_hash.meta
./db/server_soon.meta
./ghost/server_missing_crt.meta
./legacy/server_expired.meta
./web/server_ok.meta
./weird/server_bad_date.meta
[?2004hroot@291289b1-48f3-4fe5-8785-032bb0293e75:/home/user/certs_incoming# cat > /tmp/process_certs.sh << 'EOF'
[?2004l[?2004h> #!/bin/bash
[?2004l[?2004h> 
[?2004l[?2004h> # Initialize output files
[?2004l[?2004h> CSV_HEADER="filename,subject,issuer,not_before,not_after,days_until_expiry,status"
[?2004l[?2004h> echo "$CSV_HEADER" > /home/user/cert_analysis/expiring_certs.csv
[?2004l[?2004h> touch /home/user/cert_analysis/analysis.log
[?2004l[?2004h> touch /home/user/cert_analysis/errors.json
[?2004l[?2004h> 
[?2004l[?2004h> # Function to validate date format (YYYY-MM-DD)
[?2004l[?2004h> validate_date() {
[?2004l[?2004h>     if [[ ! $1 =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
[?2004l[?2004h>         return 1
[?2004l[?2004h>     fi
[?2004l[?2004h>     return 0
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Get current date for calculating days until expiry
[?2004l[?2004h> today=$(date +%Y-%m-%d)
[?2004l[?2004h> 
[?2004l[?2004h> # Process each .meta file
[?2004l[?2004h> for meta_file in $(find . -name "*.meta"); do
[?2004l[?2004h>     # Extract base filename without extension
[?2004l[?2004h>     base_name=$(basename "$meta_file" .meta)
[?2004l[?2004h>     crt_file="${meta_file%.meta}.crt"
[?2004l[?2004h>     
[?2004l[?2004h>     # Check if corresponding .crt file exists
[?2004l[?2004h>     if [ ! -f "$crt_file" ]; then
[?2004l[?2004h>         echo "{\"filename\": \"$meta_file\", \"reason\": \"MISSING_CRT\"}" >> /home/user/cert_analysis/errors.json
[?2004l[?2004h>         # Ensure proper JSON array formatting by removing last comma later
[?2004l[?2004h>         continue
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # Read metadata from .meta file
[?2004l[?2004h>     if [ ! -f "$meta_file" ]; then
[?2004l[?2004h>         echo "{\"filename\": \"$meta_file\", \"reason\": \"MISSING_META_FILE\"}" >> /home/user/cert_analysis/errors.json
[?2004l[?2004h>         continue
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # Read and parse the metadata line
[?2004l[?2004h>     IFS='|' read -r subject issuer not_before not_after checksum < "$meta_file"
[?2004l[?2004h>     
[?2004l[?2004h>     # Validate date formats
[?2004l[?2004h>     if ! validate_date "$not_before" || ! validate_date "$not_after"; then
[?2004l[?2004h>         echo "{\"filename\": \"$meta_file\", \"reason\": \"INVALID_DATE\"}" >> /home/user/cert_analysis/errors.json
[?2004l[?2004h>         continue
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # Calculate checksum of .crt file and compare
[?2004l[?2004h>     crt_checksum=$(sha256sum "$crt_file" | awk '{print $1}')
[?2004l[?2004h>     if [ "$crt_checksum" != "$checksum" ]; then
[?2004l[?2004h>         echo "{\"filename\": \"$meta_file\", \"reason\": \"CHECKSUM_MISMATCH\"}" >> /home/user/cert_analysis/errors.json
[?2004l[?2004h>         continue
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # Calculate days until expiry
[?2004l[?2004h>     days_until_expiry=$(date -d "$not_after" +%s -d "$today" +%s | awk '{print ($1 - $2)/86400}')
[?2004l[?2004h>     
[?2004l[?2004h>     # Determine status based on days remaining
[?2004l[?2004h>     if [ "$days_until_expiry" -gt 30 ]; then
[?2004l[?2004h>         status="OK"
[?2004l[?2004h>     elif [ "$days_until_expiry" -ge 0 ]; then
[?2004l[?2004h>         status="EXPIRING_SOON"
[?2004l[?2004h>     else
[?2004l[?2004h>         status="EXPIRED"
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # Append valid certificate to CSV
[?2004l[?2004h>     echo "$base_name,$subject,$issuer,$not_before,$not_after,$days_until_expiry,$status" >> /home/user/cert_analysis/expiring_certs.csv
[?2004l[?2004h>     
[?2004l[?2004h>     # Log the processed certificate
[?2004l[?2004h>     timestamp=$(date +"%Y-%m-%d %H:%M:%S")
[?2004l[?2004h>     echo "$timestamp Processed $base_name - $status" >> /home/user/cert_analysis/analysis.log
[?2004l[?2004h> done
[?2004l[?2004h> 
[?2004l[?2004h> # Clean up JSON file by removing trailing comma and adding proper array formatting
[?2004l[?2004h> sed -i '1s/^/[/;$s/,$/]/' /home/user/cert_analysis/errors.json
[?2004l[?2004h> 
[?2004l[?2004h> # Sort CSV by days_until_expiry ascending
[?2004l[?2004h> sort -t, -k5n /home/user/cert_analysis/expiring_certs.csv -o /home/user/cert_analysis/expiring_certs.csv
[?2004l[?2004h> EOFchmod +x /tmp/process_certs.sh
[?2004l[?2004h> /tmp/process_certs.sh
[?2004l[?2004h> 