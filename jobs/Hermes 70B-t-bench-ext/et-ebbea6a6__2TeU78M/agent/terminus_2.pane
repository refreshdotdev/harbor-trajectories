[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# clear
[?2004l[H[J[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# export POLICY_TLS="true"
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# export POLICY_LOG="INFO"
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# mkdir -p /home/user/policy/configs
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# mkdir -p /home/user/policy/reports
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# mkdir -p /tmp/ini_remediation
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# cat > /tmp/ini_remediation/process_ini_file.sh << 'EOF'
[?2004l[?2004h> #!/bin/bash
[?2004l[?2004h> 
[?2004l[?2004h> # Exit on any error
[?2004l[?2004h> set -e
[?2004l[?2004h> 
[?2004l[?2004h> # Set environment variables if not already set
[?2004l[?2004h> : ${POLICY_TLS:="true"}
[?2004l[?2004h> : ${POLICY_LOG:="INFO"}
[?2004l[?2004h> 
[?2004l[?2004h> # Define the absolute path to the current INI file
[?2004l[?2004h> file_abspath="$1"
[?2004l[?2004h> 
[?2004l[?2004h> # Create backup file with correct permissions and ownership
[?2004l[?2004h> backup_file="${file_abspath}.bak"
[?2004l[?2004h> if [[ -f "${file_abspath}" ]]; then
[?2004l[?2004h>     cp -p -- "${file_abspath}" "${backup_file}"
[?2004l[?2004h>     chmod 0400 "${backup_file}"
[?2004l[?2004h> fi
[?2004l[?2004h> 
[?2004l[?2004h> # Calculate SHA256 hash of the original file content
[?2004l[?2004h> original_hash=$(sha256sum "${file_abspath}" | awk '{print $1}')
[?2004l[?2004h> 
[?2004l[?2004h> # Define the temporary file for processing
[?2004l[?2004h> temp_file="${file_abspath}.tmp"
[?2004l[?2004h> 
[?2004l[?2004h> # Initialize remediation status
[?2004l[?2004h> status="NO_ACTION_REQUIRED"
[?2004l[?2004h> 
[?2004l[?2004h> # Define the awk script for INI file processing
[?2004l[?2004h> awk_script='\
[?2004l[?2004h> BEGIN {\
[?2004l[?2004h>     FS="=| \\[|\\]"  # Custom field separator for INI format
[?2004l[?2004h>     OFS="="            # Output field separator
[?2004l[?2004h>     sec_security=0
[?2004l[?2004h>     sec_logging=0
[?2004l[?2004h>     sec_network=0
[?2004l[?2004h>     key_enforce_tls=0
[?2004l[?2004h>     key_level=0
[?2004l[?2004h>     key_trusted_hosts=0
[?2004l[?2004h>     enforce_tls_value="MISSING"
[?2004l[?2004h>     level_value="MISSING"
[?2004l[?2004h>     trusted_hosts_value="MISSING"
[?2004l[?2004h>     original_enforce_tls="MISSING"
[?2004l[?2004h>     original_level="MISSING"
[?2004l[?2004h>     original_trusted_hosts="MISSING"
[?2004l[?2004h>     new_enforce_tls="MISSING"
[?2004l[?2004h>     new_level="MISSING"
[?2004l[?2004h>     new_trusted_hosts="MISSING"
[?2004l[?2004h>     remediated=0
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Process section headers
[?2004l[?2004h> sec_security == 1 || $0 ~ /^\[security\]/ { sec_security=!sec_security; next }
[?2004l[?2004h> sec_logging == 1 || $0 ~ /^\[logging\]/ { sec_logging=!sec_logging; next }
[?2004l[?2004h> sec_network == 1 || $0 ~ /^\[network\]/ { sec_network=!sec_network; next }
[?2004l[?2004h> 
[?2004l[?2004h> # In security section, handle enforce_tls key
[?2004l[?2004h> sec_security && $1 ~ /^enforce_tls$/i {
[?2004l[?2004h>     key_enforce_tls=1
[?2004l[?2004h>     original_enforce_tls=$2
[?2004l[?2004h>     # Convert to lowercase for case-insensitive comparison
[?2004l[?2004h>     original_enforce_tls_lower=tolower($2)
[?2004l[?2004h>     # Use POLICY_TLS environment variable, default to "true"
[?2004l[?2004h>     new_enforce_tls=(original_enforce_tls_lower != ENVIRON["POLICY_TLS"]) ? ENVIRON["POLICY_TLS"] : original_enforce_tls
[?2004l[?2004h>     if (original_enforce_tls != new_enforce_tls) {
[?2004l[?2004h>         remediated=1
[?2004l[?2004h>     }
[?2004l[?2004h>     $2=new_enforce_tls
[?2004l[?2004h>     key_enforce_tls=0
[?2004l[?2004h>     next
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # In logging section, handle level key
[?2004l[?2004h> sec_logging && $1 ~ /^level$/i {
[?2004l[?2004h>     key_level=1
[?2004l[?2004h>     original_level=$2
[?2004l[?2004h>     original_level_lower=tolower($2)
[?2004l[?2004h>     new_level_lower=tolower(ENVIRON["POLICY_LOG"])
[?2004l[?2004h>     # Define allowed levels (more restrictive levels are acceptable)
[?2004l[?2004h>     allowed_levels= "WARN|ERROR|FATAL|" new_level_lower
[?2004l[?2004h>     if (!match(allowed_levels, new_level_lower)) {
[?2004l[?2004h>         new_level=ENVIRON["POLICY_LOG"]
[?2004l[?2004h>     } else {
[?2004l[?2004h>         new_level=$2
[?2004l[?2004h>     }
[?2004l[?2004h>     if (original_level != new_level) {
[?2004l[?2004h>         remediated=1
[?2004l[?2004h>     }
[?2004l[?2004h>     $2=new_level
[?2004l[?2004h>     key_level=0
[?2004l[?2004h>     next
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # In network section, handle trusted_hosts key
[?2004l[?2004h> sec_network && $1 ~ /^trusted_hosts$/i {
[?2004l[?2004h>     key_trusted_hosts=1
[?2004l[?2004h>     original_trusted_hosts=$2
[?2004l[?2004h>     # Split comma-separated list and filter non-compliant hostnames
[?2004l[?2004h>     if (original_trusted_hosts != "") {
[?2004l[?2004h>         split(original_trusted_hosts, hosts, /, */)
[?2004l[?2004h>         new_trusted_hosts=""
[?2004l[?2004h>         for (i in hosts) {
[?2004l[?2004h>             host=hosts[i]
[?2004l[?2004h>             gsub(/^\s+|\s+$/, "", host)  # Trim whitespace
[?2004l[?2004h>             if (host ~ /\.corp\.local$/ && host != "") {
[?2004l[?2004h>                 if (new_trusted_hosts != "") {
[?2004l[?2004h>                     new_trusted_hosts = new_trusted_hosts ", " host
[?2004l[?2004h>                 } else {
[?2004l[?2004h>                     new_trusted_hosts = host
[?2004l[?2004h>                 }
[?2004l[?2004h>             }
[?2004l[?2004h>         }
[?2004l[?2004h>         if (original_trusted_hosts != new_trusted_hosts) {
[?2004l[?2004h>             remediated=1
[?2004l[?2004h>         }
[?2004l[?2004h>     } else {
[?2004l[?2004h>         new_trusted_hosts=""
[?2004l[?2004h>     }
[?2004l[?2004h>     $2=new_trusted_hosts
[?2004l[?2004h>     key_trusted_hosts=0
[?2004l[?2004h>     next
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Save original values for logging purposes
[?2004l[?2004h> {\
[?2004l[?2004h>     if (sec_security && $1 ~ /^enforce_tls$/i) original_enforce_tls=$2
[?2004l[?2004h>     if (sec_logging && $1 ~ /^level$/i) original_level=$2
[?2004l[?2004h>     if (sec_network && $1 ~ /^trusted_hosts$/i) original_trusted_hosts=$2
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Save new values (for when keys are missing and need to be added)
[?2004l[?2004h> END {
[?2004l[?2004h>     # If enforce_tls is missing in security section, add it
[?2004l[?2004h>     if (original_enforce_tls == "MISSING" && sec_security) {
[?2004l[?2004h>         print "[security]"
[?2004l[?2004h>         print "enforce_tls=" ENVIRON["POLICY_TLS"]
[?2004l[?2004h>         remediated=1
[?2004l[?2004h>     }
[?2004l[?2004h>     if (original_level == "MISSING" && sec_logging) {
[?2004l[?2004h>         print "[logging]"
[?2004l[?2004h>         print "level=" ENVIRON["POLICY_LOG"]
[?2004l[?2004h>         remediated=1
[?2004l[?2004h>     }
[?2004l[?2004h>     # Do not add network section or trusted_hosts key if missing
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Print the modified line
[?2004l[?2004h> { print }'
[?2004l[?2004h> 
[?2004l[?2004h> # Process the INI file using awk
[?2004l[?2004h> awk -v POLICY_TLS="$POLICY_TLS" -v POLICY_LOG="$POLICY_LOG" \
[?2004l[?2004h>     -v ENFORCE_TLS="$POLICY_TLS" -v LOG_LEVEL="$POLICY_LOG" \
[?2004l[?2004h>     "${awk_script}" "${file_abspath}" > "${temp_file}"
[?2004l[?2004h> 
[?2004l[?2004h> # If remediation occurred, replace the original file with the temp file
[?2004l[?2004h> if [ $remediated -eq 1 ]; then
[?2004l[?2004h>     mv -f "${temp_file}" "${file_abspath}"
[?2004l[?2004h>     status="REMEDIATED"
[?2004l[?2004h> else
[?2004l[?2004h>     rm -f "${temp_file}"
[?2004l[?2004h>     # Remove backup file if no remediation occurred
[?2004l[?2004h>     rm -f "${backup_file}"
[?2004l[?2004h> fi
[?2004l[?2004h> 
[?2004l[?2004h> # Log the remediation result to a temporary log file
[?2004l[?2004h> log_file="/tmp/ini_remediation/$(basename "${file_abspath}")_log.txt"
[?2004l[?2004h> echo "FILE: ${file_abspath}" > "${log_file}"
[?2004l[?2004h> echo "ORIGINAL_HASH: ${original_hash}" >> "${log_file}"
[?2004l[?2004h> echo "SECURITY_ENFORCED: was=${original_enforce_tls} -> ${new_enforce_tls}" >> "${log_file}"
[?2004l[?2004h> echo "LOG_LEVEL:          was=${original_level} -> ${new_level}" >> "${log_file}"
[?2004l[?2004h> echo "NETWORK_HOSTS:      was=${original_trusted_hosts} -> ${new_trusted_hosts}" >> "${log_file}"
[?2004l[?2004h> echo "STATUS: ${status}" >> "${log_file}"
[?2004l[?2004h> echo "----" >> "${log_file}"
[?2004l[?2004h> EOF
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# chmod +x /tmp/ini_remediation/process_ini_file.sh
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# cat > /tmp/ini_remediation/run_scan.sh << 'EOF'
[?2004l[?2004h> #!/bin/bash
[?2004l[?2004h> 
[?2004l[?2004h> # Set environment variables
[?2004l[?2004h> export POLICY_TLS="${POLICY_TLS:-true}"
[?2004l[?2004h> export POLICY_LOG="${POLICY_LOG:-INFO}"
[?2004l[?2004h> 
[?2004l[?2004h> # Create a temporary directory for parallel processing
[?2004l[?2004h> work_dir="/tmp/ini_remediation"
[?2004l[?2004h> mkdir -p "${work_dir}"
[?2004l[?2004h> 
[?2004l[?2004h> # Find all INI files under /home/user/policy/configs
[?2004l[?2004h> find /home/user/policy/configs -type f -name '*.ini' > "${work_dir}/files.txt"
[?2004l[?2004h> 
[?2004l[?2004h> # Check if any INI files were found
[?2004l[?2004h> if [ ! -s "${work_dir}/files.txt" ]; then
[?2004l[?2004h>     echo "No INI files found under /home/user/policy/configs." >&2
[?2004l[?2004h>     exit 1
[?2004l[?2004h> fi
[?2004l[?2004h> 
[?2004l[?2004h> # Process files concurrently using GNU Parallel
[?2004l[?2004h> cat "${work_dir}/files.txt" | parallel -j +0 --no-notice \
[?2004l[?2004h>     "${work_dir}/process_ini_file.sh {}"
[?2004l[?2004h> 
[?2004l[?2004h> # Collect all individual log files
[?2004l[?2004h> log_files=($(ls -1 "${work_dir}"/*.txt 2>/dev/null))
[?2004l[?2004h> 
[?2004l[?2004h> # Create the final log file path
[?2004l[?2004h> final_log="/home/user/policy/reports/after_remediation.log"
[?2004l[?2004h> 
[?2004l[?2004h> # Write header to the final log file
[?2004l[?2004h> echo "" > "${final_log}"
[?2004l[?2004h> 
[?2004l[?2004h> # Concatenate log files in alphabetical order
[?2004l[?2004h> cat "${work_dir}"/*.txt | sort >> "${final_log}"
[?2004l[?2004h> 
[?2004l[?2004h> # Calculate summary statistics
[?2004l[?2004h> files_scanned=$(wc -l < "${work_dir}/files.txt")
[?2004l[?2004h> remediated=0
[?2004l[?2004h> compliant=0
[?2004l[?2004h> for log in "${log_files[@]}"; do
[?2004l[?2004h>     if grep -q "STATUS: REMEDIATED" "${log}"; then
[?2004l[?2004h>         ((remediated++))
[?2004l[?2004h>     else
[?2004l[?2004h>         ((compliant++))
[?2004l[?2004h>     fi
[?2004l[?2004h> done
[?2004l[?2004h> 
[?2004l[?2004h> # Append summary to the final log file
[?2004l[?2004h> echo "Summary:" >> "${final_log}"
[?2004l[?2004h> echo "FILES_SCANNED=${files_scanned}" >> "${final_log}"
[?2004l[?2004h> echo "REMEDIATED=${remediated}" >> "${final_log}"
[?2004l[?2004h> echo "COMPLIANT=${compliant}" >> "${final_log}"
[?2004l[?2004h> 
[?2004l[?2004h> # Clean up temporary files
[?2004l[?2004h> rm -rf "${work_dir}"
[?2004l[?2004h> EOF
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# chmod +x /tmp/ini_remediation/run_scan.sh
[?2004l[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# /tmp/ini_remediation/run_scan.sh
[?2004l/tmp/ini_remediation/run_scan.sh: line 21: parallel: command not found
cat: write error: Broken pipe
[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# cat /home/user/policy/reports/after_remediation.log
[?2004l
/home/user/policy/configs/app1.ini
/home/user/policy/configs/app2.ini
/home/user/policy/configs/app3.ini
Summary:
FILES_SCANNED=3
REMEDIATED=0
COMPLIANT=1
[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# apt-get update && apt-get install -y parallel
[?2004l0% [Working]            Hit:1 http://security.ubuntu.com/ubuntu jammy-security InRelease
0% [Waiting for headers]                        Hit:2 http://archive.ubuntu.com/ubuntu jammy InRelease
                        0% [Working]0% [Waiting for headers]                        Hit:3 http://archive.ubuntu.com/ubuntu jammy-updates InRelease
                        0% [Working]0% [Waiting for headers]                        Hit:4 http://archive.ubuntu.com/ubuntu jammy-backports InRelease
                        0% [Working]0% [Working]20% [Working]             Reading package lists... 0%Reading package lists... 0%Reading package lists... 0%Reading package lists... 3%Reading package lists... 3%Reading package lists... 4%Reading package lists... 4%Reading package lists... 38%Reading package lists... 38%Reading package lists... 39%Reading package lists... 39%Reading package lists... 49%Reading package lists... 49%Reading package lists... 66%Reading package lists... 66%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 79%Reading package lists... 79%Reading package lists... 96%Reading package lists... 96%Reading package lists... 99%Reading package lists... 99%Reading package lists... 99%Reading package lists... 99%Reading package lists... Done
Reading package lists... 0%Reading package lists... 0%Reading package lists... 0%Reading package lists... 3%Reading package lists... 3%Reading package lists... 4%Reading package lists... 4%Reading package lists... 38%Reading package lists... 38%Reading package lists... 39%Reading package lists... 39%Reading package lists... 49%Reading package lists... 49%Reading package lists... 66%Reading package lists... 66%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 70%Reading package lists... 79%Reading package lists... 79%Reading package lists... 96%Reading package lists... 96%Reading package lists... 99%Reading package lists... 99%Reading package lists... 99%Reading package lists... 99%Reading package lists... Done
Building dependency tree... 0%Building dependency tree... 0%Building dependency tree... 50%Building dependency tree... 50%Building dependency tree... 67%Building dependency tree... Done
Reading state information... 0% Reading state information... 4%Reading state information... Done
The following additional packages will be installed:
  dbus dmsetup gir1.2-glib-2.0 libapparmor1 libargon2-1 libcryptsetup12 libdbus-1-3 libdevmapper1.02.1 libgdbm-compat4 libgdbm6 libgirepository-1.0-1
  libglib2.0-0 libglib2.0-data libicu70 libip4tc2 libjson-c5 libkmod2 libperl5.34 libsensors-config libsensors5 libxml2 netbase networkd-dispatcher perl
  perl-modules-5.34 python3-dbus python3-gi shared-mime-info sysstat systemd systemd-timesyncd ucf xdg-user-dirs xz-utils
Suggested packages:
  default-dbus-session-bus | dbus-session-bus gdbm-l10n lm-sensors iw | wireless-tools ash csh fish ksh tcsh zsh perl-doc libterm-readline-gnu-perl
  | libterm-readline-perl-perl make libtap-harness-archive-perl python-dbus-doc isag systemd-container libfido2-1 libtss2-esys-3.0.2-0 libtss2-mu0 libtss2-rc0
  policykit-1
The following NEW packages will be installed:
  dbus dmsetup gir1.2-glib-2.0 libapparmor1 libargon2-1 libcryptsetup12 libdbus-1-3 libdevmapper1.02.1 libgdbm-compat4 libgdbm6 libgirepository-1.0-1
  libglib2.0-0 libglib2.0-data libicu70 libip4tc2 libjson-c5 libkmod2 libperl5.34 libsensors-config libsensors5 libxml2 netbase networkd-dispatcher parallel
  perl perl-modules-5.34 python3-dbus python3-gi shared-mime-info sysstat systemd systemd-timesyncd ucf xdg-user-dirs xz-utils
0 upgraded, 35 newly installed, 0 to remove and 4 not upgraded.
Need to get 30.1 MB of archives.
After this operation, 121 MB of additional disk space will be used.
0% [Working]            Get:1 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libapparmor1 amd64 3.0.4-2ubuntu2.5 [39.6 kB]
0% [1 libapparmor1 6950 B/39.6 kB 18%]                                      1% [Working]            Get:2 http://archive.ubuntu.com/ubuntu jammy/main amd64 libargon2-1 amd64 0~20171227-0.3 [19.5 kB]
1% [2 libargon2-1 2606 B/19.5 kB 13%]cat > /tmp/ini_remediation/process_ini_file.sh << 'EOF'
#!/bin/bash

# Exit on any error
set -e

# Set environment variables if not already set
: ${POLICY_TLS:="true"}
: ${POLICY_LOG:="INFO"}

# Define the absolute path to the current INI file
file_abspath="$1"

# Create backup file with correct permissions and ownership
backup_file="${file_abspath}.bak"
if [[ -f "${file_abspath}" ]]; then
    cp -p -- "${file_abspath}" "${backup_file}"
    chmod 0400 "${backup_file}"
fi

# Calculate SHA256 hash of the original file content
original_hash=$(sha256sum "${file_abspath}" | awk '{print $1}')

# Define the temporary file for processing
temp_file="${file_abspath}.tmp"

# Initialize remediation status
status="NO_ACTION_REQUIRED"

# Define the awk script for INI file processing
awk_script='\
BEGIN {\
    FS="=| \[|\]"  # Custom field separator for INI format
    OFS="="            # Output field separator
    sec_security=0
    sec_logging=0
    sec_network=0
    key_enforce_tls=0
    key_level=0
    key_trusted_hosts=0
    enforce_tls_value="MISSING"
    level_value="MISSING"
    trusted_hosts_value="MISSING"
    original_enforce_tls="MISSING"
    original_level="MISSING"
    original_trusted_hosts="MISSING"
    new_enforce_tls="MISSING"
    new_level="MISSING"
    new_trusted_hosts="MISSING"
    remediated=0
}

# Process section headers
sec_security == 1 || $0 ~ /^\[security\]/ { sec_security=!sec_security; next }
sec_logging == 1 || $0 ~ /^\[logging\]/ { sec_logging=!sec_logging; next }
sec_network == 1 || $0 ~ /^\[network\]/ { sec_network=!sec_network; next }

# In security section, handle enforce_tls key
sec_security && $1 ~ /^enforce_tls$/i {
    key_enforce_tls=1
    original_enforce_tls=$2
    # Convert to lowercase for case-insensitive comparison
    original_enforce_tls_lower=tolower($2)
    # Use POLICY_TLS environment variable, default to "true"
    new_enforce_tls=(original_enforce_tls_lower != ENVIRON["POLICY_TLS"]) ? ENVIRON["POLICY_TLS"] : original_enforce_tls
    if (original_enforce_tls != new_enforce_tls) {
        remediated=1
    }
    $2=new_enforce_tls
    key_enforce_tls=0
    next
}

# In logging section, handle level key
sec_logging && $1 ~ /^level$/i {
    key_level=1
    original_level=$2
    original_level_lower=tolower($2)
    new_level_lower=tolower(ENVIRON["POLICY_LOG"])
    # Define allowed levels (more restrictive levels are acceptable)
    allowed_levels= "WARN|ERROR|FATAL|" new_level_lower
    if (!match(allowed_levels, new_level_lower)) {
        new_level=ENVIRON["POLICY_LOG"]
    } else {
        new_level=$2
    }
    if (original_level != new_level) {
        remediated=1
    }
    $2=new_level
    key_level=0
    next
}

# In network section, handle trusted_hosts key
sec_network && $1 ~ /^trusted_hosts$/i {
    key_trusted_hosts=1
    original_trusted_hosts=$2
    # Split comma-separated list and filter non-compliant hostnames
    if (original_trusted_hosts != "") {
        split(original_trusted_hosts, hosts, /, */)
        new_trusted_hosts=""
        for (i in hosts) {
            host=hosts[i]
            gsub(/^\s+|\s+$/, "", host)  # Trim whitespace
            if (host ~ /\.corp\.local$/ && host != "") {
                if (new_trusted_hosts != "") {
                    new_trusted_hosts = new_trusted_hosts ", " host
                } else {
                    new_trusted_hosts = host
                }
            }
        }
        if (original_trusted_hosts != new_trusted_hosts) {
            remediated=1
        }
    } else {
        new_trusted_hosts=""
    }
    $2=new_trusted_hosts
    key_trusted_hosts=0
    next
}

# Save original values for logging purposes
{\
    if (sec_security && $1 ~ /^enforce_tls$/i) original_enforce_tls=$2
    if (sec_logging && $1 ~ /^level$/i) original_level=$2
    if (sec_network && $1 ~ /^trusted_hosts$/i) original_trusted_hosts=$2
}

# Save new values (for when keys are missing and need to be added)
END {
    # If enforce_tls is missing in security section, add it
    if (original_enforce_tls == "MISSING" && sec_security) {
        print "[                                     1% [Working]            Get:3 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libdevmapper1.02.1 amd64 2:1.02.175-2.1ubuntu5 [139 kB]
1% [3 libdevmapper1.02.1 212 B/139 kB 0%]                                         2% [Waiting for headers]                        Get:4 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libjson-c5 amd64 0.15-3~ubuntu1.22.04.2 [33.5 kB]
2% [4 libjson-c5 1342 B/33.5 kB 4%]                                   3% [Waiting for headers]                        Get:5 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libcryptsetup12 amd64 2:2.4.3-1ubuntu1.3 [211 kB]
3% [5 libcryptsetup12 2348 B/211 kB 1%]                                       4% [Waiting for headers]                        Get:6 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libip4tc2 amd64 1.8.7-1ubuntu5.2 [19.9 kB]
4% [6 libip4tc2 2896 B/19.9 kB 15%]                                   5% [Waiting for headers]                        Get:7 http://archive.ubuntu.com/ubuntu jammy/main amd64 libkmod2 amd64 29-1ubuntu1 [48.0 kB]
5% [7 libkmod2 110 B/48.0 kB 0%]                                5% [Waiting for headers]                        Get:8 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 systemd amd64 249.11-0ubuntu3.17 [4583 kB]
5% [8 systemd 2500 B/4583 kB 0%]                                18% [Waiting for headers]                         Get:9 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 perl-modules-5.34 all 5.34.0-3ubuntu1.5 [2977 kB]
18% [9 perl-modules-5.34 26.6 kB/2977 kB 1%]                                            27% [Waiting for headers]                         Get:10 http://archive.ubuntu.com/ubuntu jammy/main amd64 libgdbm6 amd64 1.23-1 [33.9 kB]
27% [10 libgdbm6 33.9 kB/33.9 kB 100%]                                      27% [Working]             Get:11 http://archive.ubuntu.com/ubuntu jammy/main amd64 libgdbm-compat4 amd64 1.23-1 [6606 B]
27% [11 libgdbm-compat4 6606 B/6606 B 100%]                                           28% [Working]             Get:12 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libperl5.34 amd64 5.34.0-3ubuntu1.5 [4797 kB]
28% [12 libperl5.34 12.5 kB/4797 kB 0%]                                       41% [Waiting for headers]                         Get:13 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 perl amd64 5.34.0-3ubuntu1.5 [232 kB]
41% [13 perl 45.1 kB/232 kB 19%]                                42% [Waiting for headers]                         Get:14 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libdbus-1-3 amd64 1.12.20-2ubuntu4.1 [189 kB]
42% [14 libdbus-1-3 4096 B/189 kB 2%]                                     43% [Waiting for headers]                         Get:15 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 dbus amd64 1.12.20-2ubuntu4.1 [158 kB]
43% [15 dbus 4096 B/158 kB 3%]                              44% [Working]             Get:16 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 dmsetup amd64 2:1.02.175-2.1ubuntu5 [81.7 kB]
44% [16 dmsetup 16.4 kB/81.7 kB 20%]                                    45% [Waiting for headers]                         Get:17 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libglib2.0-0 amd64 2.72.4-0ubuntu2.9 [1467 kB]
45% [17 libglib2.0-0 20.0 kB/1467 kB 1%]                                        50% [Waiting for headers]                         Get:18 http://archive.ubuntu.com/ubuntu jammy/main amd64 libgirepository-1.0-1 amd64 1.72.0-1 [55.6 kB]
50% [18 libgirepository-1.0-1 45.1 kB/55.6 kB 81%]                                                  50% [Waiting for headers]                         Get:19 http://archive.ubuntu.com/ubuntu jammy/main amd64 gir1.2-glib-2.0 amd64 1.72.0-1 [164 kB]
50% [19 gir1.2-glib-2.0 42.8 kB/164 kB 26%]                                           51% [Waiting for headers]                         Get:20 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libglib2.0-data all 2.72.4-0ubuntu2.9 [5088 B]
                         Get:21 http://archive.ubuntu.com/ubuntu jammy/main amd64 libicu70 amd64 70.1-2 [10.6 MB]
52% [21 libicu70 0 B/10.6 MB 0%]                                81% [Working]             Get:22 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 libxml2 amd64 2.9.13+dfsg-1ubuntu0.11 [765 kB]
81% [22 libxml2 0 B/765 kB 0%]                              83% [Waiting for headers]                         Get:23 http://archive.ubuntu.com/ubuntu jammy/main amd64 netbase all 6.3 [12.9 kB]
                         Get:24 http://archive.ubuntu.com/ubuntu jammy/main amd64 python3-dbus amd64 1.2.18-3build1 [99.5 kB]
84% [24 python3-dbus 38.7 kB/99.5 kB 39%]                                         85% [Waiting for headers]                         Get:25 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 python3-gi amd64 3.42.1-0ubuntu1 [229 kB]
85% [25 python3-gi 13.0 kB/229 kB 6%]                                     86% [Waiting for headers]                         Get:26 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 networkd-dispatcher all 2.1-2ubuntu0.22.04.2 [15.8 kB]
86% [26 networkd-dispatcher 15.8 kB/15.8 kB 100%]                                                 87% [Waiting for headers]                         Get:27 http://archive.ubuntu.com/ubuntu jammy/main amd64 shared-mime-info amd64 2.1-2 [454 kB]
87% [27 shared-mime-info 24.6 kB/454 kB 5%]                                           88% [Working]             Get:28 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 systemd-timesyncd amd64 249.11-0ubuntu3.17 [31.2 kB]
88% [28 systemd-timesyncd 4096 B/31.2 kB 13%]                                             89% [Working]             Get:29 http://archive.ubuntu.com/ubuntu jammy/main amd64 ucf all 3.0043 [56.1 kB]
89% [29 ucf 3553 B/56.1 kB 6%]                              90% [Working]             Get:30 http://archive.ubuntu.com/ubuntu jammy/main amd64 xdg-user-dirs amd64 0.17-2ubuntu4 [53.9 kB]
90% [30 xdg-user-dirs 12.7 kB/53.9 kB 24%]                                          90% [Working]             Get:31 http://archive.ubuntu.com/ubuntu jammy/main amd64 xz-utils amd64 5.2.5-2ubuntu1 [84.8 kB]
90% [31 xz-utils 6949 B/84.8 kB 8%]                                   91% [Waiting for headers]                         Get:32 http://archive.ubuntu.com/ubuntu jammy/main amd64 libsensors-config all 1:3.6.0-7ubuntu1 [5274 B]
91% [32 libsensors-config 4531 B/5274 B 86%]                                            92% [Working]             Get:33 http://archive.ubuntu.com/ubuntu jammy/main amd64 libsensors5 amd64 1:3.6.0-7ubuntu1 [26.3 kB]
92% [33 libsensors5 26.3 kB/26.3 kB 100%]                                         92% [Waiting for headers]                         Get:34 http://archive.ubuntu.com/ubuntu jammy-updates/main amd64 sysstat amd64 12.5.2-2ubuntu0.2 [487 kB]
92% [34 sysstat 24.3 kB/487 kB 5%]                                  94% [Working]             Get:35 http://archive.ubuntu.com/ubuntu jammy/universe amd64 parallel all 20210822+ds-2 [1947 kB]
94% [35 parallel 3266 B/1947 kB 0%]                                   100% [Working]              Fetched 30.1 MB in 2s (17.6 MB/s)
debconf: delaying package configuration, since apt-utils is not installed
security]"
        print "enforce_tls=" ENVIRON["POLICY_TLS"]
        remediated=1
    }
    if (original_level == "MISSING" && sec_logging) {
        print "[logging]"
        print "level=" ENVIRON["POLICY_LOG"]
        remediated=1
    }
    # Do not add network section or trusted_hosts key if missing
}

# Print the modified line
{ print }'

# Process the INI file using awk
awk -v POLICY_TLS="$POLICY_TLS" -v POLICY_LOG="$POLICY_LOG" \
    -v ENFORCE_TLS="$POLICY_TLS" -v LOG_LEVEL="$POLICY_LOG" \
    "${awk_script}" "${file_abspath}" > "${temp_file}"

# If remediation occurred, replace the original file with the temp file
if [ $remediated -eq 1 ]; then
    mv -f "${temp_file}" "${file_abspath}"
    status="REMEDIATED"
else
    rm -f "${temp_file}"
    # Remove backup file if no remediation occurred
    rm -f "${backup_file}"
fi

# Log the remediation result to a temporary log file
log_file="/tmp/ini_remediation/$(basename "${file_abspath}")_log.txt"
echo "FILE: ${file_abspath}" > "${log_file}"
echo "ORIGINAL_HASH: ${original_hash}" >> "${log_file}"
echo "SECURITY_ENFORCED: was=${original_enforce_tls} -> ${new_enforce_tls}" >> "${log_file}"
echo "LOG_LEVEL:          was=${original_level} -> ${new_level}" >> "${log_file}"
echo "NETWORK_HOSTS:      was=${original_trusted_hosts} -> ${new_trusted_hosts}" >> "${log_file}"
echo "STATUS: ${status}" >> "${log_file}"
echo "----" >> "${log_file}"
EOF
chmod +x /tmp/ini_remediation/process_ini_file.sh
cat > /tmp/ini_remediation/run_scan.sh << 'EOF'
#!/bin/bash

# Set environment variables
export POLICY_TLS="${POLICY_TLS:-true}"
export POLICY_LOG="${POLICY_LOG:-INFO}"

# Create a temporary directory for parallel processing
work_dir="/tmp/ini_remediation"
mkdir -p "${work_dir}"

# Find all INI files under /home/user/policy/configs
find /home/user/policy/configs -type f -name '*.ini' > "${work_dir}/files.txt"

# Check if any INI files were found
if [ ! -s "${work_dir}/files.txt" ]; then
    echo "No INI files found under /home/user/policy/configs." >&2
    exit 1
fi

# Process files concurrently using GNU Parallel
parallel -j +0 --no-notice -a "${work_dir}/files.txt" \
    "${work_dir}/process_ini_file.sh {}"

# Collect all individual log files
log_files=($(ls -1 "${work_dir}"/*.txt 2>/dev/null))

# Create the final log file path
final_log="/home/user/policy/reports/after_remediation.log"

# Write header to the final log file
echo "" > "${final_log}"

# Concatenate log files in alphabetical order
if [ ${#log_files[@]} -gt 0 ]; then
    cat "${log_files[@]}" | sort >> "${final_log}"
fi

# Calculate summary statistics
files_scanned=$(wc -l < "${work_dir}/files.txt")
remediated=0
compliant=0
for log in "${log_files[@]}"; do
    if grep -q "STATUS: REMEDIATED" "${log}"; then
        ((remediated++))
    else
        ((compliant++))
    fi
done

# Append summary to the final log file
echo "Summary:" >> "${final_log}"
echo "FILES_SCANNED=${files_scanned}" >> "${final_log}"
echo "REMEDIATED=${remediated}" >> "${final_log}"
echo "COMPLIANT=${compliant}" >> "${final_log}"

# Clean up temporary files
rm -rf "${work_dir}"
EOF
Selecting previously unselected package libapparmor1:amd64.
(Reading database ... (Reading database ... 5%(Reading database ... 10%(Reading database ... 15%(Reading database ... 20%(Reading database ... 25%(Reading database ... 30%(Reading database ... 35%(Reading database ... 40%(Reading database ... 45%(Reading database ... 50%(Reading database ... 55%(Reading database ... 60%(Reading database ... 65%(Reading database ... 70%(Reading database ... 75%(Reading database ... 80%(Reading database ... 85%(Reading database ... 90%(Reading database ... 95%(Reading database ... 100%(Reading database ... 6856 files and directories currently installed.)
Preparing to unpack .../00-libapparmor1_3.0.4-2ubuntu2.5_amd64.deb ...
Unpacking libapparmor1:amd64 (3.0.4-2ubuntu2.5) ...
Selecting previously unselected package libargon2-1:amd64.
Preparing to unpack .../01-libargon2-1_0~20171227-0.3_amd64.deb ...
Unpacking libargon2-1:amd64 (0~20171227-0.3) ...
Selecting previously unselected package libdevmapper1.02.1:amd64.
Preparing to unpack .../02-libdevmapper1.02.1_2%3a1.02.175-2.1ubuntu5_amd64.deb ...
Unpacking libdevmapper1.02.1:amd64 (2:1.02.175-2.1ubuntu5) ...
Selecting previously unselected package libjson-c5:amd64.
Preparing to unpack .../03-libjson-c5_0.15-3~ubuntu1.22.04.2_amd64.deb ...
Unpacking libjson-c5:amd64 (0.15-3~ubuntu1.22.04.2) ...
Selecting previously unselected package libcryptsetup12:amd64.
Preparing to unpack .../04-libcryptsetup12_2%3a2.4.3-1ubuntu1.3_amd64.deb ...
Unpacking libcryptsetup12:amd64 (2:2.4.3-1ubuntu1.3) ...
Selecting previously unselected package libip4tc2:amd64.
Preparing to unpack .../05-libip4tc2_1.8.7-1ubuntu5.2_amd64.deb ...
Unpacking libip4tc2:amd64 (1.8.7-1ubuntu5.2) ...
Selecting previously unselected package libkmod2:amd64.
Preparing to unpack .../06-libkmod2_29-1ubuntu1_amd64.deb ...
Unpacking libkmod2:amd64 (29-1ubuntu1) ...
Selecting previously unselected package systemd.
Preparing to unpack .../07-systemd_249.11-0ubuntu3.17_amd64.deb ...
Unpacking systemd (249.11-0ubuntu3.17) ...
Selecting previously unselected package perl-modules-5.34.
Preparing to unpack .../08-perl-modules-5.34_5.34.0-3ubuntu1.5_all.deb ...
Unpacking perl-modules-5.34 (5.34.0-3ubuntu1.5) ...
Selecting previously unselected package libgdbm6:amd64.
Preparing to unpack .../09-libgdbm6_1.23-1_amd64.deb ...
Unpacking libgdbm6:amd64 (1.23-1) ...
Selecting previously unselected package libgdbm-compat4:amd64.
Preparing to unpack .../10-libgdbm-compat4_1.23-1_amd64.deb ...
Unpacking libgdbm-compat4:amd64 (1.23-1) ...
Selecting previously unselected package libperl5.34:amd64.
Preparing to unpack .../11-libperl5.34_5.34.0-3ubuntu1.5_amd64.deb ...
Unpacking libperl5.34:amd64 (5.34.0-3ubuntu1.5) ...
chmod +x /tmp/ini_remediation/run_scan.sh
/tmp/ini_remediation/run_scan.sh
Selecting previously unselected package perl.
Preparing to unpack .../12-perl_5.34.0-3ubuntu1.5_amd64.deb ...
Unpacking perl (5.34.0-3ubuntu1.5) ...
Selecting previously unselected package libdbus-1-3:amd64.
Preparing to unpack .../13-libdbus-1-3_1.12.20-2ubuntu4.1_amd64.deb ...
Unpacking libdbus-1-3:amd64 (1.12.20-2ubuntu4.1) ...
Selecting previously unselected package dbus.
Preparing to unpack .../14-dbus_1.12.20-2ubuntu4.1_amd64.deb ...
Unpacking dbus (1.12.20-2ubuntu4.1) ...
Selecting previously unselected package dmsetup.
Preparing to unpack .../15-dmsetup_2%3a1.02.175-2.1ubuntu5_amd64.deb ...
Unpacking dmsetup (2:1.02.175-2.1ubuntu5) ...
Selecting previously unselected package libglib2.0-0:amd64.
Preparing to unpack .../16-libglib2.0-0_2.72.4-0ubuntu2.9_amd64.deb ...
Unpacking libglib2.0-0:amd64 (2.72.4-0ubuntu2.9) ...
Selecting previously unselected package libgirepository-1.0-1:amd64.
Preparing to unpack .../17-libgirepository-1.0-1_1.72.0-1_amd64.deb ...
Unpacking libgirepository-1.0-1:amd64 (1.72.0-1) ...
Selecting previously unselected package gir1.2-glib-2.0:amd64.
Preparing to unpack .../18-gir1.2-glib-2.0_1.72.0-1_amd64.deb ...
Unpacking gir1.2-glib-2.0:amd64 (1.72.0-1) ...
Selecting previously unselected package libglib2.0-data.
Preparing to unpack .../19-libglib2.0-data_2.72.4-0ubuntu2.9_all.deb ...
Unpacking libglib2.0-data (2.72.4-0ubuntu2.9) ...
Selecting previously unselected package libicu70:amd64.
Preparing to unpack .../20-libicu70_70.1-2_amd64.deb ...
Unpacking libicu70:amd64 (70.1-2) ...
Selecting previously unselected package libxml2:amd64.
Preparing to unpack .../21-libxml2_2.9.13+dfsg-1ubuntu0.11_amd64.deb ...
Unpacking libxml2:amd64 (2.9.13+dfsg-1ubuntu0.11) ...
Selecting previously unselected package netbase.
Preparing to unpack .../22-netbase_6.3_all.deb ...
Unpacking netbase (6.3) ...
Selecting previously unselected package python3-dbus.
Preparing to unpack .../23-python3-dbus_1.2.18-3build1_amd64.deb ...
Unpacking python3-dbus (1.2.18-3build1) ...
Selecting previously unselected package python3-gi.
Preparing to unpack .../24-python3-gi_3.42.1-0ubuntu1_amd64.deb ...
Unpacking python3-gi (3.42.1-0ubuntu1) ...
Selecting previously unselected package networkd-dispatcher.
Preparing to unpack .../25-networkd-dispatcher_2.1-2ubuntu0.22.04.2_all.deb ...
Unpacking networkd-dispatcher (2.1-2ubuntu0.22.04.2) ...
Selecting previously unselected package shared-mime-info.
Preparing to unpack .../26-shared-mime-info_2.1-2_amd64.deb ...
Unpacking shared-mime-info (2.1-2) ...
Selecting previously unselected package systemd-timesyncd.
Preparing to unpack .../27-systemd-timesyncd_249.11-0ubuntu3.17_amd64.deb ...
Unpacking systemd-timesyncd (249.11-0ubuntu3.17) ...
Selecting previously unselected package ucf.
Preparing to unpack .../28-ucf_3.0043_all.deb ...
Moving old data out of the way
Unpacking ucf (3.0043) ...
Selecting previously unselected package xdg-user-dirs.
Preparing to unpack .../29-xdg-user-dirs_0.17-2ubuntu4_amd64.deb ...
Unpacking xdg-user-dirs (0.17-2ubuntu4) ...
Selecting previously unselected package xz-utils.
Preparing to unpack .../30-xz-utils_5.2.5-2ubuntu1_amd64.deb ...
Unpacking xz-utils (5.2.5-2ubuntu1) ...
Selecting previously unselected package libsensors-config.
Preparing to unpack .../31-libsensors-config_1%3a3.6.0-7ubuntu1_all.deb ...
Unpacking libsensors-config (1:3.6.0-7ubuntu1) ...
Selecting previously unselected package libsensors5:amd64.
Preparing to unpack .../32-libsensors5_1%3a3.6.0-7ubuntu1_amd64.deb ...
Unpacking libsensors5:amd64 (1:3.6.0-7ubuntu1) ...
Selecting previously unselected package sysstat.
Preparing to unpack .../33-sysstat_12.5.2-2ubuntu0.2_amd64.deb ...
Unpacking sysstat (12.5.2-2ubuntu0.2) ...
Selecting previously unselected package parallel.
Preparing to unpack .../34-parallel_20210822+ds-2_all.deb ...
Adding 'diversion of /usr/bin/parallel to /usr/bin/parallel.moreutils by parallel'
Adding 'diversion of /usr/share/man/man1/parallel.1.gz to /usr/share/man/man1/parallel.moreutils.1.gz by parallel'
Unpacking parallel (20210822+ds-2) ...
Setting up libip4tc2:amd64 (1.8.7-1ubuntu5.2) ...
Setting up libapparmor1:amd64 (3.0.4-2ubuntu2.5) ...
Setting up xdg-user-dirs (0.17-2ubuntu4) ...
Setting up libglib2.0-0:amd64 (2.72.4-0ubuntu2.9) ...
No schema files found: doing nothing.
Setting up libargon2-1:amd64 (0~20171227-0.3) ...
Setting up libsensors-config (1:3.6.0-7ubuntu1) ...
Setting up perl-modules-5.34 (5.34.0-3ubuntu1.5) ...
Setting up libglib2.0-data (2.72.4-0ubuntu2.9) ...
Setting up libdbus-1-3:amd64 (1.12.20-2ubuntu4.1) ...
Setting up dbus (1.12.20-2ubuntu4.1) ...
Setting up xz-utils (5.2.5-2ubuntu1) ...
update-alternatives: using /usr/bin/xz to provide /usr/bin/lzma (lzma) in auto mode
update-alternatives: warning: skip creation of /usr/share/man/man1/lzma.1.gz because associated file /usr/share/man/man1/xz.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/unlzma.1.gz because associated file /usr/share/man/man1/unxz.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzcat.1.gz because associated file /usr/share/man/man1/xzcat.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzmore.1.gz because associated file /usr/share/man/man1/xzmore.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzless.1.gz because associated file /usr/share/man/man1/xzless.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzdiff.1.gz because associated file /usr/share/man/man1/xzdiff.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzcmp.1.gz because associated file /usr/share/man/man1/xzcmp.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzgrep.1.gz because associated file /usr/share/man/man1/xzgrep.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzegrep.1.gz because associated file /usr/share/man/man1/xzegrep.1.gz (of link group lzma) doesn't exist
update-alternatives: warning: skip creation of /usr/share/man/man1/lzfgrep.1.gz because associated file /usr/share/man/man1/xzfgrep.1.gz (of link group lzma) doesn't exist
Setting up ucf (3.0043) ...
debconf: unable to initialize frontend: Dialog
debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 78.)
debconf: falling back to frontend: Readline
Setting up libsensors5:amd64 (1:3.6.0-7ubuntu1) ...
Setting up libdevmapper1.02.1:amd64 (2:1.02.175-2.1ubuntu5) ...
Setting up dmsetup (2:1.02.175-2.1ubuntu5) ...
Setting up libgirepository-1.0-1:amd64 (1.72.0-1) ...
Setting up netbase (6.3) ...
Setting up libjson-c5:amd64 (0.15-3~ubuntu1.22.04.2) ...
Setting up sysstat (12.5.2-2ubuntu0.2) ...
debconf: unable to initialize frontend: Dialog
debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 78.)
debconf: falling back to frontend: Readline

Creating config file /etc/default/sysstat with new version
update-alternatives: using /usr/bin/sar.sysstat to provide /usr/bin/sar (sar) in auto mode
update-alternatives: warning: skip creation of /usr/share/man/man1/sar.1.gz because associated file /usr/share/man/man1/sar.sysstat.1.gz (of link group sar) doesn't exist
Created symlink /etc/systemd/system/sysstat.service.wants/sysstat-collect.timer â†’ /lib/systemd/system/sysstat-collect.timer.
Created symlink /etc/systemd/system/sysstat.service.wants/sysstat-summary.timer â†’ /lib/systemd/system/sysstat-summary.timer.
Created symlink /etc/systemd/system/multi-user.target.wants/sysstat.service â†’ /lib/systemd/system/sysstat.service.
Setting up libkmod2:amd64 (29-1ubuntu1) ...
Setting up libgdbm6:amd64 (1.23-1) ...
Setting up libicu70:amd64 (70.1-2) ...
Setting up python3-dbus (1.2.18-3build1) ...
Setting up libgdbm-compat4:amd64 (1.23-1) ...
Setting up gir1.2-glib-2.0:amd64 (1.72.0-1) ...
Setting up libcryptsetup12:amd64 (2:2.4.3-1ubuntu1.3) ...
Setting up libxml2:amd64 (2.9.13+dfsg-1ubuntu0.11) ...
Setting up libperl5.34:amd64 (5.34.0-3ubuntu1.5) ...
Setting up systemd (249.11-0ubuntu3.17) ...
Created symlink /etc/systemd/system/getty.target.wants/getty@tty1.service â†’ /lib/systemd/system/getty@.service.
Created symlink /etc/systemd/system/multi-user.target.wants/remote-fs.target â†’ /lib/systemd/system/remote-fs.target.
Created symlink /etc/systemd/system/dbus-org.freedesktop.resolve1.service â†’ /lib/systemd/system/systemd-resolved.service.
Created symlink /etc/systemd/system/multi-user.target.wants/systemd-resolved.service â†’ /lib/systemd/system/systemd-resolved.service.
ln: failed to create symbolic link '/etc/resolv.conf': Device or resource busy
Created symlink /etc/systemd/system/sysinit.target.wants/systemd-pstore.service â†’ /lib/systemd/system/systemd-pstore.service.
Initializing machine ID from D-Bus machine ID.
Setting up perl (5.34.0-3ubuntu1.5) ...
Setting up python3-gi (3.42.1-0ubuntu1) ...
Setting up shared-mime-info (2.1-2) ...
Setting up systemd-timesyncd (249.11-0ubuntu3.17) ...
Created symlink /etc/systemd/system/dbus-org.freedesktop.timesync1.service â†’ /lib/systemd/system/systemd-timesyncd.service.
Created symlink /etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service â†’ /lib/systemd/system/systemd-timesyncd.service.
Setting up parallel (20210822+ds-2) ...
Setting up networkd-dispatcher (2.1-2ubuntu0.22.04.2) ...
Created symlink /etc/systemd/system/multi-user.target.wants/networkd-dispatcher.service â†’ /lib/systemd/system/networkd-dispatcher.service.
Processing triggers for libc-bin (2.35-0ubuntu3.11) ...
[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# cat /home/user/policy/reports/after_remediation.log
[?2004l
/home/user/policy/configs/app1.ini
/home/user/policy/configs/app2.ini
/home/user/policy/configs/app3.ini
Summary:
FILES_SCANNED=3
REMEDIATED=0
COMPLIANT=1
[?2004hroot@e57fa77a-c8b3-43bf-9486-659f3eb3ba8b:~# 