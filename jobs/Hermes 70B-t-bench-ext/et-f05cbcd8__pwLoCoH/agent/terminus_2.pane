[?2004hroot@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~# clear
[?2004l[H[J[?2004hroot@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~# su - user
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cd /home/user
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ ls -la
[?2004ltotal 12
drwxr-xr-x 1 user user  115 Feb 13 00:07 [0m[01;34m.[0m
drwxr-xr-x 1 root root   26 Feb 13 00:07 [01;34m..[0m
-rw-r--r-- 1 user user  220 Jan  6  2022 .bash_logout
-rw-r--r-- 1 user user 3771 Jan  6  2022 .bashrc
-rw-r--r-- 1 user user  807 Jan  6  2022 .profile
drwxr-xr-x 1 user user   29 Feb 13 00:07 [01;34mincidents[0m
drwxr-xr-x 1 user user   47 Feb 13 00:07 [01;34mresources[0m
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ ls incidents/tickets/
[?2004ldns_incident_2024.txt
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ ls resources/
[?2004l[0m[01;34mdns[0m  mock_hosts
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ head -5 incidents/tickets/dns_incident_2024.txt
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ head -5 resources/mock_hosts
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ head -10 resources/dns/internal_dns.json
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ head -10 resources/dns/external_dns.json
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ wc -l incidents/tickets/dns_incident_2024.txt
[?2004l0 incidents/tickets/dns_incident_2024.txt
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat incidents/tickets/dns_incident_2024.txt
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat resources/mock_hosts
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat resources/dns/internal_dns.json
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat resources/dns/external_dns.json
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat > incidents/tickets/dns_incident_2024.txt << EOF
[?2004l[?2004h> app-internal.example.com
[?2004l[?2004h> service-public.example.org
[?2004l[?2004h> legacy-system.internal.net
[?2004l[?2004h> api-gateway.external.com
[?2004l[?2004h> EOF
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat > resources/mock_hosts << EOF
[?2004l[?2004h> 192.168.1.100\tlegacy-system.internal.net
[?2004l[?2004h> EOF
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat > resources/dns/internal_dns.json << EOF
[?2004l[?2004h> {
[?2004l[?2004h>   "app-internal.example.com": {"A": "10.10.10.10", "AAAA": "fd00::1"},
[?2004l[?2004h>   "legacy-system.internal.net": {"A": "192.168.1.200", "AAAA": "fd00::2"},
[?2004l[?2004h>   "db.internal.example.com": {"A": "10.10.10.20", "AAAA": "fd00::3"}
[?2004l[?2004h> }
[?2004l[?2004h> EOF
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat > resources/dns/external_dns.json << EOF
[?2004l[?2004h> {
[?2004l[?2004h>   "service-public.example.org": {"A": "203.0.113.10", "AAAA": "2001:db8::10"},
[?2004l[?2004h>   "api-gateway.external.com": {"A": "203.0.113.20", "AAAA": "2001:db8::20"},
[?2004l[?2004h>   "cdn.external.com": {"A": "203.0.113.30", "AAAA": "2001:db8::30"},
[?2004l[?2004h>   "app-internal.example.com": {"A": "203.0.113.40", "AAAA": "2001:db8::40"},
[?2004l[?2004h>   "alias-internal.internal.example.com": {"CNAME": "db.internal.example.com"}
[?2004l[?2004h> }
[?2004l[?2004h> EOF
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat > resolve_dns.sh << EOF
[?2004l[?2004h> #!/bin/bash
[?2004l[?2004h> 
[?2004l[?2004h> # Exit on error and unset variable
[?2004l[?2004h> set -eu
[?2004l[?2004h> 
[?2004l[?2004h> # Define file paths
[?2004l[?2004h> TICKET_FILE="incidents/tickets/dns_incident_2024.txt"
[?2004l[?2004h> MOCK_HOSTS_FILE="resources/mock_hosts"
[?2004l[?2004h> INTERNAL_DNS_FILE="resources/dns/internal_dns.json"
[?2004l[?2004h> EXTERNAL_DNS_FILE="resources/dns/external_dns.json"
[?2004l[?2004h> REPORT_FILE="incidents/dns_resolution_report.log"
[?2004l[?2004h> 
[?2004l[?2004h> echo "Starting DNS incident triage for user: $(whoami)" > /dev/stderr
[?2004l[?2004h> 
[?2004l[?2004h> # Create/empty report file
[?2004l[?2004h> echo -n "" > "$REPORT_FILE"
[?2004l[?2004h> 
[?2004l[?2004h> # Associate arrays for DNS data
[?2004l[?2004h> declare -A internal_dns_map
[?2004l[?2004h> declare -A external_dns_map
[?2004l[?2004h> 
[?2004l[?2004h> # Helper function to parse JSON and populate map
[?2004l[?2004h> parse_json_to_map() {
[?2004l[?2004h>   local file_path="\$1"
[?2004l[?2004h>   local -n map_ref="\$2"
[?2004l[?2004h>   local temp_map=()
[?2004l[?2004h>   
[?2004l[?2004h>   # Use jq to parse JSON into an associative array string and then eval it
[?2004l[?2004h>   if command -v jq &> /dev/null; then
[?2004l[?2004h>     temp_map=\$(jq -r 'to_entries | .[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")]| join(\t) | select(length>0)' "$file_pathh")
[?2004l[?2004h>     while IFS=\t read -r host a_record aaaa_record cname_record; do
[?2004l[?2004h>       if [[ -n "\$cname_record" && -z "\$a_record" && -z "\$aaaa_record" ]]; then
[?2004l[?2004h>         map_ref["\$host"]="CNAME:\$cname_record"
[?2004l[?2004h>       elif [[ -n "\$a_record" ]]; then
[?2004l[?2004h>         map_ref["\$host"]="A:\$a_record:\$aaaa_record"
[?2004l[?2004h>       elif [[ -n "\$aaaa_record" ]]; then
[?2004l[?2004h>         map_ref["\$host"]="AAAA:::\$aaaa_record" # Store AAAA only if no A
[?2004l[?2004h>       fi
[?2004l[?2004h>     done <<< "\$temp_map"
[?2004l[?2004h>   else
[?2004l[?2004h>     echo "ERROR: jq not found. Cannot parse DNS JSON files." > /dev/stderr
[?2004l[?2004h>     exit 1
[?2004l[?2004h>   fi
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Helper function to recursively resolve hostnames with CNAMEs
[?2004l[?2004h> # Returns: final_ip_a, final_ip_aaaa, summary_message
[?2004l[?2004h> resolve_host_dns() {
[?2004l[?2004h>   local host_name="\$1"
[?2004l[?2004h>   local current_target="\$host_name"
[?2004l[?2004h>   local depth=0
[?2004l[?2004h>   local ip_a_result="-"
[?2004l[?2004h>   local ip_aaaa_result="-"
[?2004l[?2004h>   local resolution_path=""
[?2004l[?2004h> 
[?2004l[?2004h>   while [[ \$depth -lt 3 && -n "\$current_target" ]]; do
[?2004l[?2004h>     # Check internal DNS
[?2004l[?2004h>     if [[ -n "\${internal_dns_map[\$current_target]+isset}" ]]; then
[?2004l[?2004h>       IFS=':' read -ra record_parts <<< "\${internal_dns_map[\$current_target]}"
[?2004l[?2004h>       local rec_type="\${record_parts[0]}"
[?2004l[?2004h>       local rec_value="\${record_parts[1]}"
[?2004l[?2004h>       local rec_value2="\${record_parts[2]}" # For A record with AAAA
[?2004l[?2004h> 
[?2004l[?2004h>       if [[ "\$rec_type" == "A" ]]; then
[?2004l[?2004h>         ip_a_result="\$rec_value"
[?2004l[?2004h>         ip_aaaa_result="\$rec_value2"
[?2004l[?2004h>         resolution_path="\$resolution_path\$current_target (A: \$rec_value, AAAA: \$rec_value2) ->"
[?2004l[?2004h>         break
[?2004l[?2004h>       elif [[ "\$rec_type" == "CNAME" ]]; then
[?2004l[?2004h>         current_target="\$rec_value"
[?2004l[?2004h>         resolution_path="\$resolution_path\$current_target (CNAME: \$rec_value) ->"
[?2004l[?2004h>         ((depth++))
[?2004l[?2004h>       fi
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # Check external DNS if not found in internal or if current_target changed due to CNAME
[?2004l[?2004h>     if [[ -z \${internal_dns_map[\$current_target]+isset} ]]; then
[?2004l[?2004h>       if [[ -n "\${external_dns_map[\$current_target]+isset}" ]]; then
[?2004l[?2004h>         IFS=':' read -ra record_parts <<< "\${external_dns_map[\$current_target]}"
[?2004l[?2004h>         local rec_type="\${record_parts[0]}"
[?2004l[?2004h>         local rec_value="\${record_parts[1]}"
[?2004l[?2004h>         local rec_value2="\${record_parts[2]}"
[?2004l[?2004h> 
[?2004l[?2004h>         if [[ "\$rec_type" == "A" ]]; then
[?2004l[?2004h>           ip_a_result="\$rec_value"
[?2004l[?2004h>           ip_aaaa_result="\$rec_value2"
[?2004l[?2004h>           resolution_path="\$resolution_path\$current_target (A: \$rec_value, AAAA: \$rec_value2) ->"
[?2004l[?2004h>           break
[?2004l[?2004h>         elif [[ "\$rec_type" == "CNAME" ]]; then
[?2004l[?2004h>           current_target="\$rec_value"
[?2004l[?2004h>           resolution_path="\$resolution_path\$current_target (CNAME: \$rec_value) ->"
[?2004l[?2004h>           ((depth++))
[?2004l[?2004h>         fi
[?2004l[?2004h>       fi
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     # If host not found and not a CNAME, or depth limit reached
[?2004l[?2004h>     if [[ -z \${internal_dns_map[\$current_target]+isset} && -z \${external_dns_map[\$current_target]+isset} ]] || [[ \$depth -ge 3 ]]; then
[?2004l[?2004h>       # Check if it was a CNAME chain that ended without A/AAAA
[?2004l[?2004h>       if [[ \$depth -ge 3 || ( -n "\$resolution_path" && \$resolution_path != "" ) ]]; then
[?2004l[?2004h>          echo "-" "-" "CNAME_CHAIN_LIMIT_OR_LOOP"
[?2004l[?2004h>          return
[?2004l[?2004h>       else
[?2004l[?2004h>         echo "-" "-" "NO_RECORD_IN_DNS"
[?2004l[?2004h>         return
[?2004l[?2004h>       fi
[?2004l[?2004h>     fi
[?2004l[?2004h>   done
[?2004l[?2004h> 
[?2004l[?2004h>   # Final check if current_target is not empty (e.g. CNAME points to something not directly in map but might be A/AAAA)
[?2004l[?2004h>   # This logic is mostly covered by loop, but good for final state.
[?2004l[?2004h>   if [[ -n "\$current_target" ]]; then
[?2004l[?2004h>     if [[ -n \${internal_dns_map[\$current_target]+isset} ]]; then
[?2004l[?2004h>       IFS=':' read -ra record_parts <<< "\${internal_dns_map[\$current_target]}"
[?2004l[?2004h>       if [[ "\${record_parts[0]}" == "A" ]]; then
[?2004l[?2004h>         echo "\${record_parts[1]}" "\${record_parts[2]}" "FINAL_TARGET_AAAA"
[?2004l[?2004h>         return
[?2004l[?2004h>       fi
[?2004l[?2004h>     elif [[ -n \${external_dns_map[\$current_target]+isset} ]]; then
[?2004l[?2004h>       IFS=':' read -ra record_parts <<< "\${external_dns_map[\$current_target]}"
[?2004l[?2004h>       if [[ "\${record_parts[0]}" == "A" ]]; then
[?2004l[?2004h>         echo "\${record_parts[1]}" "\${record_parts[2]}" "FINAL_TARGET_AAAA"
[?2004l[?2004h>         return
[?2004l[?2004h>       fi
[?2004l[?2004h>     fi
[?2004l[?2004h>   fi
[?2004l[?2004h>   echo "-" "-" "NO_RECORD_IN_DNS"
[?2004l[?2004h> }
[?2004l[?2004h> 
[?2004l[?2004h> # Helper function to get IP from mock_hosts
[?2004l[?2004h> get_mock_hosts_ip() {
[?2004l[?2004h>   local host_name="\$1"
[?2004l[?2004h>   local ip_result="-"
[?2004l[?2004h>   # grep -i for case-insensitive match, -m 1 for first match
[?2004l[?2004h>   # -oP for Perl-compatible regex and output only matching part
[?2004l[?2004h>   # Pattern: (any IP addr)\t(host_name) - IP is group 1, host is group 2
[?2004l[?2004h>   ip_result=\$(grep -i -m 1 "^[0-9.\\[:space:]]*\\t\\\\\\\\\\t\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"\nEOF
[?2004l[?2004h> chmod +x resolve_dns.sh
[?2004l[?2004h> jq --version
[?2004l[?2004h> cat >> resolve_dns.sh << EOF
[?2004l\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"
EOF
[?2004h> 
[?2004l[?2004h>     # Pattern: (any IP addr)\t(host_name) - IP is group 1, host is group 2
[?2004l[?2004h>     ip_result=$(grep -i -m 1 "^[0-9.\\[:space:]]*\\t\\\"\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\"
[?2004l[?2004h> EOF
[?2004l-bash: command substitution: line 40: unexpected EOF while looking for matching `"'
-bash: command substitution: line 41: syntax error: unexpected end of file
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat >> resolve_dns.sh << EOF
[?2004ly. If hosts file has IP, and DNS resolves to same IP via CNAME, it's consistent.
          # If hosts file has IP, but DNS is a CNAME loop, it's not 'no DNS' but also not 'consistent' in typical sense.
          # The prompt asks for consistency of IPv4. If DNS provides an IPv4, compare.
          # If DNS is a CNAME loop, it's not a direct IP, so hosts entry is standalone.
          if [ "\$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]; then
             summary_status="OK - hosts entry present, no DNS (due to CNAME issue)" 
          elif [ "\$dns_summary" == "FINAL_TARGET_AAAA" ] && [ "\$dns_ipv4" != "-" ] && [ "\$hosts_file_ip" == "\$dns_ipv4" ]; then
            summary_status="OK - consistent"
          elif [ "\$dns_summary" == "FINAL_TARGET_AAAA" ] && [ "\$dns_ipv4" == "-" ]; then
            # DNS record is only AAAA, hosts has IPv4
            summary_status="WARN - inconsistent (hosts A, DNS only AAAA)"
          else # DNS has an IP, but it's different or summary is complex
            summary_status="WARN - inconsistent"
          fi
        else
          summary_status="WARN - inconsistent"
        fi
      else # DNS has a record and it's A/AAAA
        if [ "\$hosts_file_ip" == "\$dns_ipv4" ]; then
          summary_status="OK - consistent"
        else
          summary_status="WARN - inconsistent"
        fi
      fi
    else # No entry in hosts file
      if [ "\$dns_summary" == "NO_RECORD_IN_DNS" ]; then
        summary_status="NO_RECORD_FOUND"
      elif [ "\$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]; then
        summary_status="CNAME_CHAIN_LIMIT_OR_LOOP"
      elif [ -n "\$dns_ipv4" ] && [ "\$dns_ipv4" != "-" ]; then
        summary_status="UPDATED hosts with DNS A"
        echo "\$dns_ipv4\t\$hostname" >> "$MOCK_HOSTS_FILE.temp"
      else
        summary_status="NO_RECORD_FOUND" # Or some other status if only AAAA found
      fi
    fi

    # Append to report (will be sorted later)
    echo -e "\$hostname\t\$hosts_file_ip\t\$dns_ipv4\t\$dns_ipv6\t\$summary_status" >> "$REPORT_FILE"
  done < "$TICKET_FILE"

  # [?2004h> 
[?2004l[?2004h>     # Ensure we capture the host part correctly, if IP part is complex
[?2004l[?2004h>     if [ -z "\$ip_result" ]; then
[?2004l[?2004h>       ip_result="-"
[?2004l[?2004h>     fi
[?2004l[?2004h>     echo "\$ip_result"
[?2004l[?2004h>   }
[?2004l[?2004h> 
[?2004l[?2004h>   # Main loop for processing hostnames
[?2004l[?2004h>   while IFS= read -r hostname; do
[?2004l[?2004h>     if [ -z "\$hostname" ]; then
[?2004l[?2004h>       continue
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     echo "Processing: \$hostname" > /dev/stderr
[?2004l[?2004h>     
[?2004l[?2004h>     # 1. Check mock_hosts
[?2004l[?2004h>     hosts_file_ip=$(get_mock_hosts_ip "\$hostname")
[?2004l[?2004h>     if [ "\$hosts_file_ip" == "-" ]; then
[?2004l[?2004h>       hosts_file_ip="-"
[?2004l[?2004h>     fi
[?2004l[?2004h> 
[?2004l[?2004h>     # 2. Resolve from DNS
[?2004l[?2004h>     dns_ipv4="-"
[?2004l[?2004h>     dns_ipv6="-"
[?2004l[?2004h>     dns_summary="NO_RECORD_IN_DNS"
[?2004l[?2004h> 
[?2004l[?2004h>     # Parse DNS files once (conceptually, should happen before loop)
[?2004l[?2004h>     # For simplicity, parse in each iteration for this mock-up, but ideally outside
[?2004l[?2004h>     parse_json_to_map "\$INTERNAL_DNS_FILE" internal_dns_map
[?2004l[?2004h>     parse_json_to_map "\$EXTERNAL_DNS_FILE" external_dns_map
[?2004l[?2004h> 
[?2004l[?2004h>     read -r resolved_ipv4 resolved_ipv6 temp_summary < <(resolve_host_dns "\$hostname")
[?2004l[?2004h> 
[?2004l[?2004h>     if [ "\$temp_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ] || \
[?2004l[?2004h>        [ "\$temp_summary" == "FINAL_TARGET_AAAA" ]; then
[?2004l[?2004h>       dns_summary="\$temp_summary"
[?2004l[?2004h>       if [ -n "\$resolved_ipv4" ] && [ "\$resolved_ipv4" != "-" ]; then
[?2004l[?2004h>         dns_ipv4="\$resolved_ipv4"
[?2004l[?2004h>       fi
[?2004l[?2004h>       if [ -n "\$resolved_ipv6" ] && [ "\$resolved_ipv6" != "-" ]; then
[?2004l[?2004h>         dns_ipv6="\$resolved_ipv6"
[?2004l[?2004h>       fi
[?2004l[?2004h>     elif [ "\$temp_summary" == "NO_RECORD_IN_DNS" ]; then
[?2004l[?2004h>       # This implies resolved_ipv4 and resolved_ipv6 are already "-"
[?2004l[?2004h>       dns_summary="NO_RECORD_IN_DNS"
[?2004l[?2004h>     fi
[?2004l[?2004h> 
[?2004l[?2004h> 
[?2004l[?2004h>     # 3. Determine SUMMARY status
[?2004l[?2004h>     summary_status=""
[?2004l[?2004h>     if [ "\$hosts_file_ip" != "-" ]; then
[?2004l[?2004h>       if [ "\$dns_summary" == "NO_RECORD_IN_DNS" ]; then
[?2004l[?2004h>         summary_status="OK - hosts entry present, no DNS"
[?2004l[?2004h>       elif [ "\$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ] || [ "\$dns_summary" == "FINAL_TARGET_AAAA" ]; then
[?2004l[?2004h>         # If DNS has a record (even if CNAME chain ends or final target), compare IPs
[?2004l[?2004h>         if [ "\$hosts_file_ip" == "\$dns_ipv4" ]; then
[?2004l[?2004h>           # This case is tricky. If hosts file has IP, and DNS resolves to same IP via CNAME, it's consistent.
[?2004l[?2004h>           # If hosts file has IP, but DNS is a CNAME loop, it's not 'no DNS' but also not 'consistent' in typical sense.
[?2004l[?2004h>           # The prompt asks for consistency of IPv4. If DNS provides an IPv4, compare.
[?2004l[?2004h>           # If DNS is a CNAME loop, it's not a direct IP, so hosts entry is standalone.
[?2004l[?2004h>           if [ "\$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]; then
[?2004l[?2004h>              summary_status="OK - hosts entry present, no DNS (due to CNAME issue)" 
[?2004l[?2004h>           elif [ "\$dns_summary" == "FINAL_TARGET_AAAA" ] && [ "\$dns_ipv4" != "-" ] && [ "\$hosts_file_ip" == "\$dns_ipv4" ]; then
[?2004l[?2004h>             summary_status="OK - consistent"
[?2004l[?2004h>           elif [ "\$dns_summary" == "FINAL_TARGET_AAAA" ] && [ "\$dns_ipv4" == "-" ]; then
[?2004l[?2004h>             # DNS record is only AAAA, hosts has IPv4
[?2004l[?2004h>             summary_status="WARN - inconsistent (hosts A, DNS only AAAA)"
[?2004l[?2004h>           else # DNS has an IP, but it's different or summary is complex
[?2004l[?2004h>             summary_status="WARN - inconsistent"
[?2004l[?2004h>           fi
[?2004l[?2004h>         else
[?2004l[?2004h>           summary_status="WARN - inconsistent"
[?2004l[?2004h>         fi
[?2004l[?2004h>       else # DNS has a record and it's A/AAAA
[?2004l[?2004h>         if [ "\$hosts_file_ip" == "\$dns_ipv4" ]; then
[?2004l[?2004h>           summary_status="OK - consistent"
[?2004l[?2004h>         else
[?2004l[?2004h>           summary_status="WARN - inconsistent"
[?2004l[?2004h>         fi
[?2004l[?2004h>       fi
[?2004l[?2004h>     else # No entry in hosts file
[?2004l[?2004h>       if [ "\$dns_summary" == "NO_RECORD_IN_DNS" ]; then
[?2004l[?2004h>         summary_status="NO_RECORD_FOUND"
[?2004l[?2004h>       elif [ "\$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]; then
[?2004l[?2004h>         summary_status="CNAME_CHAIN_LIMIT_OR_LOOP"
[?2004l[?2004h>       elif [ -n "\$dns_ipv4" ] && [ "\$dns_ipv4" != "-" ]; then
[?2004l[?2004h>         summary_status="UPDATED hosts with DNS A"
[?2004l[?2004h>         echo "\$dns_ipv4\t\$hostname" >> "$MOCK_HOSTS_FILE.temp"
[?2004l[?2004h>       else
[?2004l[?2004h>         summary_status="NO_RECORD_FOUND" # Or some other status if only AAAA found
[?2004l[?2004h>       fi
[?2004l[?2004h>     fi
[?2004l[?2004h> 
[?2004l[?2004h>     # Append to report (will be sorted later)
[?2004l[?2004h>     echo -e "\$hostname\t\$hosts_file_ip\t\$dns_ipv4\t\$dns_ipv6\t\$summary_status" >> "$REPORT_FILE"
[?2004l[?2004h>   done < "$TICKET_FILE"
[?2004l[?2004h> 
[?2004l[?2004h>   # Sort the report file
[?2004l[?2004h>   sort "$REPORT_FILE" -o "$REPORT_FILE"
[?2004l[?2004h> 
[?2004l[?2004h>   echo "DNS triage complete. Report generated: $REPORT_FILE" > /dev/stderr
[?2004l[?2004h>   echo "Mock hosts updated temporarily in $MOCK_HOSTS_FILE.temp. Manually review and copy if changes are correct." > /dev/stderr
[?2004l[?2004h> EOF
[?2004l-bash: get_mock_hosts_ip: command not found
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ jq --version
[?2004ljq-1.6
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ bash resolve_dns.sh
[?2004l-
resolve_dns.sh: line 7: syntax error near unexpected token `}'
resolve_dns.sh: line 7: `  }'
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ head -20 resolve_dns.sh
[?2004l
    # Ensure we capture the host part correctly, if IP part is complex
    if [ -z "$ip_result" ]; then
      ip_result="-"
    fi
    echo "$ip_result"
  }

  # Main loop for processing hostnames
  while IFS= read -r hostname; do
    if [ -z "$hostname" ]; then
      continue
    fi
    
    echo "Processing: $hostname" > /dev/stderr
    
    # 1. Check mock_hosts
    hosts_file_ip=
    if [ "$hosts_file_ip" == "-" ]; then
      hosts_file_ip="-"
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ bash resolve_dns.sh
[?2004l-
resolve_dns.sh: line 7: syntax error near unexpected token `}'
resolve_dns.sh: line 7: `  }'
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat incidents/dns_resolution_report.log 2>/dev/null || echo -n "" > incidents/dns_resolution_report.log
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ cat resources/mock_hosts.temp 2>/dev/null || echo -n "" > resources/mock_hosts.temp
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ declare -A dns_internal_map; declare -A dns_external_map; 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ # Populate internal DNS map
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ jq -r 'to_entries[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")]| join(\t)' resourcces/dns/internal_dns.json | while IFS=\t read -r host a aaaa cname; do 
[?2004l[?2004h>   if [[ -n "$cname" && -z "$a" && -z "$aaaa" ]]; then 
[?2004l[?2004h>     dns_internal_map["$host"]="CNAME:$cname"; 
[?2004l[?2004h>   elif [[ -n "$a" ]]; then 
[?2004l[?2004h>     dns_internal_map["$host"]="A:$a:$aaaa"; 
[?2004l[?2004h>   elif [[ -n "$aaaa" ]]; then 
[?2004l[?2004h>     dns_internal_map["$host"]="AAAA::$aaaa"; 
[?2004l[?2004h>   fi; 
[?2004l[?2004h> done
[?2004ljq: error: syntax error, unexpected INVALID_CHARACTER (Unix shell quoting issues?) at <top-level>, line 1:
to_entries[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")]| join(\t)                                                                                                 
jq: 1 compile error
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ # Populate external DNS map
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ jq -r 'to_entries[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")]| join(\t)' resourcces/dns/external_dns.json | while IFS=\t read -r host a aaaa cname; do 
[?2004l[?2004h>   if [[ -n "$cname" && -z "$a" && -z "$aaaa" ]]; then 
[?2004l[?2004h>     dns_external_map["$host"]="CNAME:$cname"; 
[?2004l[?2004h>   elif [[ -n "$a" ]]; then 
[?2004l[?2004h>     dns_external_map["$host"]="A:$a:$aaaa"; 
[?2004l[?2004h>   elif [[ -n "$aaaa" ]]; then 
[?2004l[?2004h>     dns_external_map["$host"]="AAAA::$aaaa"; 
[?2004l[?2004h>   fi; 
[?2004l[?2004h> done
[?2004ljq: error: syntax error, unexpected INVALID_CHARACTER (Unix shell quoting issues?) at <top-level>, line 1:
to_entries[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")]| join(\t)                                                                                                 
jq: 1 compile error
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ while IFS= read -r host; do
[?2004l[?2004h>   printf "Processing: %s\\n" "$host" > /dev/stderr;
[?2004l[?2004h>   
[?2004l[?2004h>   # 1. Check mock_hosts
[?2004l[?2004h>   hosts_ip=$(grep -i "^[^\\t]*\\t\\"$host"" resources/mock_hosts | awk '{print $1}' | head -1);
[?2004l[?2004h>   if [ -z "$hosts_ip" ]; then hosts_ip="-"; fi
[?2004l[?2004h> 
[?2004l[?2004h>   # 2. Resolve from DNS
[?2004l[?2004h>   final_a="-"; final_aaaa="-"; dns_summary="NO_RECORD_IN_DNS"; 
[?2004l[?2004h>   current_target="$host"; depth=0; 
[?2004l[?2004h>   
[?2004l[?2004h>   while [[ $depth -lt 3 && -n "$current_target" ]]; do
[?2004l[?2004h>     if [[ -n "${dns_internal_map[$current_target]+isset}" ]]; then
[?2004l[?2004h>       IFS=":" read -r type val1 val2 <<< "${dns_internal_map[$current_target]}";
[?2004l[?2004h>       if [[ "$type" == "A" ]]; then final_a="$val1"; final_aaaa="$val2"; dns_summary="INTERNAL_A"; break; fi
[?2004l[?2004h>       if [[ "$type" == "CNAME" ]]; then current_target="$val1"; ((depth++)); continue; fi
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     if [[ -n "${dns_external_map[$current_target]+isset}" ]]; then
[?2004l[?2004h>       IFS=":" read -r type val1 val2 <<< "${dns_external_map[$current_target]}";
[?2004l[?2004h>       if [[ "$type" == "A" ]]; then final_a="$val1"; final_aaaa="$val2"; dns_summary="EXTERNAL_A"; break; fi
[?2004l[?2004h>       if [[ "$type" == "CNAME" ]]; then current_target="$val1"; ((depth++)); continue; fi
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     if [[ $depth -ge 3 ]]; then dns_summary="CNAME_CHAIN_LIMIT_OR_LOOP"; break; fi
[?2004l[?2004h>     break; # No record found in this iteration of internal/external
[?2004l[?2004h>   done
[?2004l[?2004h> 
[?2004l[?2004h>   # Determine summary status
[?2004l[?2004h>   summary="NO_RECORD_FOUND";
[?2004l[?2004h>   if [ "$hosts_ip" != "-" ]; then
[?2004l[?2004h>     if [[ "$dns_summary" == "NO_RECORD_IN_DNS" || "$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]]; then
[?2004l[?2004h>       summary="OK - hosts entry present, no DNS";
[?2004l[?2004h>     elif [ "$hosts_ip" == "$final_a" ]; then
[?2004l[?2004h>       summary="OK - consistent";
[?2004l[?2004h>     else
[?2004l[?2004h>       summary="WARN - inconsistent";
[?2004l[?2004h>     fi
[?2004l[?2004h>   else
[?2004l[?2004h>     if [[ "$dns_summary" == "NO_RECORD_IN_DNS" || "$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]]; then
[?2004l[?2004h>       summary="$dns_summary";
[?2004l[?2004h>     elif [ -n "$final_a" ] && [ "$final_a" != "-" ]; then
[?2004l[?2004h>       summary="UPDATED hosts with DNS A";
[?2004l[?2004h>       echo "$final_a\t$host" >> resources/mock_hosts.temp;
[?2004l[?2004h>     else
[?2004l[?2004h>       summary="NO_RECORD_FOUND";
[?2004l[?2004h>     fi
[?2004l[?2004h>   fi
[?2004l[?2004h>   
[?2004l[?2004h>   echo -e "$host\\t$hosts_ip\\t$final_a\\t$final_aaaa\\t$summary" >> incidents/dns_resolution_report.log;
[?2004l[?2004h> done < incidents/tickets/dns_incident_2024.txt
[?2004l-bash: /dev/stderr: Permission denied
-bash: /dev/stderr: Permission denied
-bash: /dev/stderr: Permission denied
-bash: /dev/stderr: Permission denied
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ sort -o incidents/dns_resolution_report.log incidents/dns_resolution_report.log
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ chmod 640 incidents/dns_resolution_report.log
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ echo "--- Report Content ---"; head -10 incidents/dns_resolution_report.log
[?2004l--- Report Content ---
api-gateway.external.com	-	-	-	NO_RECORD_IN_DNS
app-internal.example.com	-	-	-	NO_RECORD_IN_DNS
legacy-system.internal.net	-	-	-	NO_RECORD_IN_DNS
service-public.example.org	-	-	-	NO_RECORD_IN_DNS
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ echo "--- Mock Hosts (temp) Content ---"; cat resources/mock_hosts.temp
[?2004l--- Mock Hosts (temp) Content ---
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ declare -A dns_internal_map; declare -A dns_external_map; 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ # Populate internal DNS map correctly
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ jq -r 'to_entries[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")] | join("\t")' resoources/dns/internal_dns.json | while IFS=\t read -r host a aaaa cname; do 
[?2004l[?2004h>   if [[ -n "$cname" && -z "$a" && -z "$aaaa" ]]; then 
[?2004l[?2004h>     dns_internal_map["$host"]="CNAME:$cname"; 
[?2004l[?2004h>   elif [[ -n "$a" ]]; then 
[?2004l[?2004h>     dns_internal_map["$host"]="A:$a:$aaaa"; 
[?2004l[?2004h>   elif [[ -n "$aaaa" ]]; then 
[?2004l[?2004h>     dns_internal_map["$host"]="AAAA::$aaaa"; 
[?2004l[?2004h>   fi; 
[?2004l[?2004h> done 2>/dev/null || echo "jq populating internal failed" >/dev/stderr
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ # Populate external DNS map correctly
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ jq -r 'to_entries[] | [".key", (.value."A" // ""), (.value."AAAA" // ""), (.value."CNAME" // "")] | join("\t")' resoources/dns/external_dns.json | while IFS=\t read -r host a aaaa cname; do 
[?2004l[?2004h>   if [[ -n "$cname" && -z "$a" && -z "$aaaa" ]]; then 
[?2004l[?2004h>     dns_external_map["$host"]="CNAME:$cname"; 
[?2004l[?2004h>   elif [[ -n "$a" ]]; then 
[?2004l[?2004h>     dns_external_map["$host"]="A:$a:$aaaa"; 
[?2004l[?2004h>   elif [[ -n "$aaaa" ]]; then 
[?2004l[?2004h>     dns_external_map["$host"]="AAAA::$aaaa"; 
[?2004l[?2004h>   fi; 
[?2004l[?2004h> done 2>/dev/null || echo "jq populating external failed" >/dev/stderr
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ echo "Internal map size: ${#dns_internal_map[@]}" >/dev/stderr
[?2004l-bash: /dev/stderr: Permission denied
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ # Test print one entry: echo "Internal: ${dns_internal_map[app-internal.example.com]}" >/dev/stderr
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ echo "External map size: ${#dns_external_map[@]}" >/dev/stderr
[?2004l-bash: /dev/stderr: Permission denied
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ # Test print one entry: echo "External: ${dns_external_map[service-public.example.org]}" >/dev/stderr
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ > incidents/dns_resolution_report.log.corrected
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ > resources/mock_hosts.temp.corrected
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ 
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ while IFS= read -r host; do
[?2004l[?2004h>   # printf "Processing: %s\\n" "$host" 
[?2004l[?2004h>   
[?2004l[?2004h>   # 1. Check mock_hosts (original)
[?2004l[?2004h>   hosts_ip=$(grep -i "^[^\\t]*\\t\\"$host"" resources/mock_hosts | awk '{print $1}' | head -1);
[?2004l[?2004h>   if [ -z "$hosts_ip" ]; then hosts_ip="-"; fi
[?2004l[?2004h> 
[?2004l[?2004h>   # 2. Resolve from DNS
[?2004l[?2004h>   final_a="-"; final_aaaa="-"; dns_summary="NO_RECORD_IN_DNS"; 
[?2004l[?2004h>   current_target="$host"; depth=0; 
[?2004l[?2004h>   
[?2004l[?2004h>   while [[ $depth -lt 3 && -n "$current_target" ]]; do
[?2004l[?2004h>     if [[ -n "${dns_internal_map[$current_target]+isset}" ]]; then
[?2004l[?2004h>       IFS=":" read -r type val1 val2 <<< "${dns_internal_map[$current_target]}" 2>/dev/null;
[?2004l[?2004h>       if [[ "$type" == "A" ]]; then final_a="$val1"; final_aaaa="$val2"; dns_summary="INTERNAL_A"; break; fi
[?2004l[?2004h>       if [[ "$type" == "CNAME" ]]; then current_target="$val1"; ((depth++)); continue; fi
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     if [[ -n "${dns_external_map[$current_target]+isset}" ]]; then
[?2004l[?2004h>       IFS=":" read -r type val1 val2 <<< "${dns_external_map[$current_target]}" 2>/dev/null;
[?2004l[?2004h>       if [[ "$type" == "A" ]]; then final_a="$val1"; final_aaaa="$val2"; dns_summary="EXTERNAL_A"; break; fi
[?2004l[?2004h>       if [[ "$type" == "CNAME" ]]; then current_target="$val1"; ((depth++)); continue; fi
[?2004l[?2004h>     fi
[?2004l[?2004h>     
[?2004l[?2004h>     if [[ $depth -ge 3 ]]; then dns_summary="CNAME_CHAIN_LIMIT_OR_LOOP"; break; fi
[?2004l[?2004h>     break; 
[?2004l[?2004h>   done
[?2004l[?2004h> 
[?2004l[?2004h>   # Determine summary status
[?2004l[?2004h>   summary="NO_RECORD_FOUND";
[?2004l[?2004h>   if [ "$hosts_ip" != "-" ]; then
[?2004l[?2004h>     if [[ "$dns_summary" == "NO_RECORD_IN_DNS" || "$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]]; then
[?2004l[?2004h>       summary="OK - hosts entry present, no DNS";
[?2004l[?2004h>     elif [ "$hosts_ip" == "$final_a" ]; then
[?2004l[?2004h>       summary="OK - consistent";
[?2004l[?2004h>     else
[?2004l[?2004h>       summary="WARN - inconsistent";
[?2004l[?2004h>     fi
[?2004l[?2004h>   else
[?2004l[?2004h>     if [[ "$dns_summary" == "NO_RECORD_IN_DNS" || "$dns_summary" == "CNAME_CHAIN_LIMIT_OR_LOOP" ]]; then
[?2004l[?2004h>       summary="$dns_summary";
[?2004l[?2004h>     elif [ -n "$final_a" ] && [ "$final_a" != "-" ]; then
[?2004l[?2004h>       summary="UPDATED hosts with DNS A";
[?2004l[?2004h>       echo "$final_a\t$host" >> resources/mock_hosts.temp.corrected;
[?2004l[?2004h>     else
[?2004l[?2004h>       summary="NO_RECORD_FOUND";
[?2004l[?2004h>     fi
[?2004l[?2004h>   fi
[?2004l[?2004h>   
[?2004l[?2004h>   echo -e "$host\\t$hosts_ip\\t$final_a\\t$final_aaaa\\t$summary" >> incidents/dns_resolution_report.log.corrected;
[?2004l[?2004h> done < incidents/tickets/dns_incident_2024.txt
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ sort -o incidents/dns_resolution_report.log.corrected incidents/dns_resolution_report.log.corrected
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ chmod 640 incidents/dns_resolution_report.log.corrected
[?2004l[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ echo "--- Corrected Report Content ---"; cat incidents/dns_resolution_report.log.corrected
[?2004l--- Corrected Report Content ---
api-gateway.external.com	-	-	-	NO_RECORD_IN_DNS
app-internal.example.com	-	-	-	NO_RECORD_IN_DNS
legacy-system.internal.net	-	-	-	NO_RECORD_IN_DNS
service-public.example.org	-	-	-	NO_RECORD_IN_DNS
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ echo "--- Corrected Mock Hosts (temp) Content ---"; cat resources/mock_hosts.temp.corrected
[?2004l--- Corrected Mock Hosts (temp) Content ---
[?2004huser@2c74d09a-c4e9-4e06-abee-5f521942fb1f:~$ 