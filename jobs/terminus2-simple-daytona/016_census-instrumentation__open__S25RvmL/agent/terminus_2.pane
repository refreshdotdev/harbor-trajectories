[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# clear
[?2004l[H[J[3J[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# nano opencensus/trace/propagation/google_cloud_format.py
[?2004lbash: nano: command not found
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# vi opencensus/trace/propagation/google_cloud_format.py
[?2004lbash: vi: command not found
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# cat opencensus/trace/propagation/google_cloud_format.py
[?2004limport logging
import re
from opencensus.trace.span_context import SpanContext
from opencensus.trace.trace_options import TraceOptions
_TRACE_CONTEXT_HEADER_NAME = 'X-Cloud-Trace-Context'
_TRACE_CONTEXT_HEADER_FORMAT = '([0-9a-f]{32})(\\/([\\d]{0,20}))?(;o=(\\d+))?'
_TRACE_CONTEXT_HEADER_RE = re.compile(_TRACE_CONTEXT_HEADER_FORMAT)
_TRACE_ID_DELIMETER = '/'
_SPAN_ID_DELIMETER = ';'

class GoogleCloudFormatPropagator(object):
    """This class is for converting the trace header in google cloud format
    and generate a SpanContext, or converting a SpanContext to a google cloud
    format header. Later we will add implementation for supporting other
    format like binary format and zipkin, opencensus format.
    """

    def from_header(self, header):
        """Generate a SpanContext object using the trace context header.
        The value of enabled parsed from header is int. Need to convert to
        bool.

        :type header: str
        :param header: Trace context header which was extracted from the HTTP
                       request headers.

        :rtype: :class:`~opencensus.trace.span_context.SpanContext`
        :returns: SpanContext generated from the trace context header.
        """
        if header is None:
            return SpanContext()
        try:
            match = re.search(_TRACE_CONTEXT_HEADER_RE, header)
        except TypeError:
            logging.warning('Header should be str, got %s. Cannot parse the header.', header.__class__.__name__)
            raise
        if match:
            trace_id = match.group(1)
            span_id = match.group(3)
            trace_options = match.group(5)
            if trace_options is None:
                trace_options = 1
            if span_id:
                span_id = '{:016x}'.format(int(span_id))
            span_context = SpanContext(trace_id=trace_id, span_id=span_id, trace_options=TraceOptions(trace_options), from_header=True)
            return span_context
        else:
            logging.warning('Cannot parse the header %s, generate a new context instead.', header)
            return SpanContext()

    def from_headers(self, headers):
        """
        TODO: Implement this function
        """
        ...

    def to_header(self, span_context):
        """Convert a SpanContext object to header string.

        :type span_context:
            :class:`~opencensus.trace.span_context.SpanContext`
        :param span_context: SpanContext object.

        :rtype: str
        :returns: A trace context header string in google cloud format.
        """
        trace_id = span_context.trace_id
        span_id = span_context.span_id
        trace_options = span_context.trace_options.trace_options_byte
        header = '{}/{};o={}'.format(trace_id, int(span_id, 16), int(trace_options))
        return header

    def to_headers(self, span_context):
        """Convert a SpanContext object to HTTP request headers.

        :type span_context:
            :class:`~opencensus.trace.span_context.SpanContext`
        :param span_context: SpanContext object.

        :rtype: dict
        :returns: Trace context headers in google cloud format.
        """
        return {_TRACE_CONTEXT_HEADER_NAME: self.to_header(span_context)}[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# sed -i '/def from_headers(self, headers):/,/.../c\    def from_headers(self, headers):\        header = headers.get(_TRACE_CONTEXT_HEADER_NAME)\        return self.from_header(header)' opencensus/trace/propagation/google_cloud_format.py
[?2004l[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# pytest tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match -v
[?2004l[1m===================================================================== test session starts ======================================================================[0m
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.10
cachedir: .pytest_cache
rootdir: /workspace/repo
plugins: mock-3.15.1, timeout-2.4.0
[1mcollecting ... [0m[1mcollected 0 items / 1 error                                                                                                                                    [0m

============================================================================ ERRORS ============================================================================
[31m[1m__________________________________________ ERROR collecting tests/unit/trace/propagation/test_google_cloud_format.py ___________________________________________[0m
[31m/usr/local/lib/python3.10/site-packages/_pytest/python.py:507: in importtestmodule
    mod = import_path(
/usr/local/lib/python3.10/site-packages/_pytest/pathlib.py:587: in import_path
    importlib.import_module(module_name)
/usr/local/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1050: in _gcd_import
    ???
<frozen importlib._bootstrap>:1027: in _find_and_load
    ???
<frozen importlib._bootstrap>:1006: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:688: in _load_unlocked
    ???
/usr/local/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:197: in exec_module
    exec(co, module.__dict__)
tests/unit/trace/propagation/test_google_cloud_format.py:17: in <module>
    from opencensus.trace.propagation import google_cloud_format
E     File "/workspace/repo/opencensus/trace/propagation/google_cloud_format.py", line 81
E       """
E       ^
E   SyntaxError: unterminated triple-quoted string literal (detected at line 82)[0m
[36m[1m=================================================================== short test summary info ====================================================================[0m
[31mERROR[0m tests/unit/trace/propagation/test_google_cloud_format.py
[31m======================================================================= [31m[1m1 error[0m[31m in 0.09s[0m[31m =======================================================================[0m
[31mERROR: found no collectors for /workspace/repo/tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match
[0m
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# sed -i 's/"""$/"""\n/' opencensus/trace/propagation/google_cloud_format.py
[?2004l[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# pytest tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match -v
[?2004l[1m===================================================================== test session starts ======================================================================[0m
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.10
cachedir: .pytest_cache
rootdir: /workspace/repo
plugins: mock-3.15.1, timeout-2.4.0
[1mcollecting ... [0m[1mcollected 0 items / 1 error                                                                                                                                    [0m

============================================================================ ERRORS ============================================================================
[31m[1m__________________________________________ ERROR collecting tests/unit/trace/propagation/test_google_cloud_format.py ___________________________________________[0m
[31m/usr/local/lib/python3.10/site-packages/_pytest/python.py:507: in importtestmodule
    mod = import_path(
/usr/local/lib/python3.10/site-packages/_pytest/pathlib.py:587: in import_path
    importlib.import_module(module_name)
/usr/local/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
<frozen importlib._bootstrap>:1050: in _gcd_import
    ???
<frozen importlib._bootstrap>:1027: in _find_and_load
    ???
<frozen importlib._bootstrap>:1006: in _find_and_load_unlocked
    ???
<frozen importlib._bootstrap>:688: in _load_unlocked
    ???
/usr/local/lib/python3.10/site-packages/_pytest/assertion/rewrite.py:197: in exec_module
    exec(co, module.__dict__)
tests/unit/trace/propagation/test_google_cloud_format.py:17: in <module>
    from opencensus.trace.propagation import google_cloud_format
E     File "/workspace/repo/opencensus/trace/propagation/google_cloud_format.py", line 85
E       """
E       ^
E   SyntaxError: unterminated triple-quoted string literal (detected at line 87)[0m
[36m[1m=================================================================== short test summary info ====================================================================[0m
[31mERROR[0m tests/unit/trace/propagation/test_google_cloud_format.py
[31m======================================================================= [31m[1m1 error[0m[31m in 0.09s[0m[31m =======================================================================[0m
[31mERROR: found no collectors for /workspace/repo/tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match
[0m
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# sed -i '/def from_headers(self, headers):/,/return self.from_header(header)/c\    def from_headers(self, headers):\        header = headers.get(_TRACE_CONTEXT_HEADER_NAME)\        return self.from_header(header)' opencensus/trace/propagation/google_cloud_format.py
[?2004l[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# pytest tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match -v
[?2004l[1m===================================================================== test session starts ======================================================================[0m
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.10
cachedir: .pytest_cache
rootdir: /workspace/repo
plugins: mock-3.15.1, timeout-2.4.0
[1mcollecting ... [0m[1mcollected 1 item                                                                                                                                               [0m

tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match [31mFAILED[0m[31m                                     [100%][0m

=========================================================================== FAILURES ===========================================================================
[31m[1m______________________________________________________ TestGoogleCloudFormatPropagator.test_headers_match ______________________________________________________[0m

self = <test_google_cloud_format.TestGoogleCloudFormatPropagator testMethod=test_headers_match>

    [0m[94mdef[39;49;00m[90m [39;49;00m[92mtest_headers_match[39;49;00m([96mself[39;49;00m):[90m[39;49;00m
        [90m# Trace option is enabled.[39;49;00m[90m[39;49;00m
        headers = {[90m[39;49;00m
            [33m'[39;49;00m[33mX-Cloud-Trace-Context[39;49;00m[33m'[39;49;00m:[90m[39;49;00m
                [33m'[39;49;00m[33m6e0c63257de34c92bf9efcd03927272e/67667974448284343;o=1[39;49;00m[33m'[39;49;00m,[90m[39;49;00m
        }[90m[39;49;00m
        expected_trace_id = [33m'[39;49;00m[33m6e0c63257de34c92bf9efcd03927272e[39;49;00m[33m'[39;49;00m[90m[39;49;00m
        expected_span_id = [33m'[39;49;00m[33m00f067aa0ba902b7[39;49;00m[33m'[39;49;00m[90m[39;49;00m
    [90m[39;49;00m
        propagator = google_cloud_format.GoogleCloudFormatPropagator()[90m[39;49;00m
>       span_context = propagator.from_headers(headers)[90m[39;49;00m
[1m[31mE       AttributeError: 'GoogleCloudFormatPropagator' object has no attribute 'from_headers'. Did you mean: 'from_header'?[0m

[1m[31mtests/unit/trace/propagation/test_google_cloud_format.py[0m:160: AttributeError
[36m[1m=================================================================== short test summary info ====================================================================[0m
[31mFAILED[0m tests/unit/trace/propagation/test_google_cloud_format.py::[1mTestGoogleCloudFormatPropagator::test_headers_match[0m - AttributeError: 'GoogleCloudFormatPropagator' object has no attribute 'from_headers'. Did you mean: 'from_header'?
[31m====================================================================== [31m[1m1 failed[0m[31m in 0.07s[0m[31m =======================================================================[0m
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# sed -i 's/def from_header(self, header):/def from_headers(self, headers):/' opencensus/trace/propagation/google_cloud_format.py
[?2004l[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# pytest tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match -v
[?2004l[1m===================================================================== test session starts ======================================================================[0m
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.10
cachedir: .pytest_cache
rootdir: /workspace/repo
plugins: mock-3.15.1, timeout-2.4.0
[1mcollecting ... [0m[1mcollected 1 item                                                                                                                                               [0m

tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match [31mFAILED[0m[31m                                     [100%][0m

=========================================================================== FAILURES ===========================================================================
[31m[1m______________________________________________________ TestGoogleCloudFormatPropagator.test_headers_match ______________________________________________________[0m

self = <test_google_cloud_format.TestGoogleCloudFormatPropagator testMethod=test_headers_match>

    [0m[94mdef[39;49;00m[90m [39;49;00m[92mtest_headers_match[39;49;00m([96mself[39;49;00m):[90m[39;49;00m
        [90m# Trace option is enabled.[39;49;00m[90m[39;49;00m
        headers = {[90m[39;49;00m
            [33m'[39;49;00m[33mX-Cloud-Trace-Context[39;49;00m[33m'[39;49;00m:[90m[39;49;00m
                [33m'[39;49;00m[33m6e0c63257de34c92bf9efcd03927272e/67667974448284343;o=1[39;49;00m[33m'[39;49;00m,[90m[39;49;00m
        }[90m[39;49;00m
        expected_trace_id = [33m'[39;49;00m[33m6e0c63257de34c92bf9efcd03927272e[39;49;00m[33m'[39;49;00m[90m[39;49;00m
        expected_span_id = [33m'[39;49;00m[33m00f067aa0ba902b7[39;49;00m[33m'[39;49;00m[90m[39;49;00m
    [90m[39;49;00m
        propagator = google_cloud_format.GoogleCloudFormatPropagator()[90m[39;49;00m
>       span_context = propagator.from_headers(headers)[90m[39;49;00m

[1m[31mtests/unit/trace/propagation/test_google_cloud_format.py[0m:160: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <opencensus.trace.propagation.google_cloud_format.GoogleCloudFormatPropagator object at 0x742797d78fa0>
headers = {'X-Cloud-Trace-Context': '6e0c63257de34c92bf9efcd03927272e/67667974448284343;o=1'}

    [0m[94mdef[39;49;00m[90m [39;49;00m[92mfrom_headers[39;49;00m([96mself[39;49;00m, headers):[90m[39;49;00m
    [90m    [39;49;00m[33m"""Generate a SpanContext object using the trace context header.[39;49;00m
    [33m    The value of enabled parsed from header is int. Need to convert to[39;49;00m
    [33m    bool.[39;49;00m
    [33m[39;49;00m
    [33m    :type header: str[39;49;00m
    [33m    :param header: Trace context header which was extracted from the HTTP[39;49;00m
    [33m                   request headers.[39;49;00m
    [33m[39;49;00m
    [33m    :rtype: :class:`~opencensus.trace.span_context.SpanContext`[39;49;00m
    [33m    :returns: SpanContext generated from the trace context header.[39;49;00m
    [33m    """[39;49;00m[90m[39;49;00m
    [90m[39;49;00m
>       [94mif[39;49;00m header [95mis[39;49;00m [94mNone[39;49;00m:[90m[39;49;00m
[1m[31mE       NameError: name 'header' is not defined[0m

[1m[31mopencensus/trace/propagation/google_cloud_format.py[0m:32: NameError
[36m[1m=================================================================== short test summary info ====================================================================[0m
[31mFAILED[0m tests/unit/trace/propagation/test_google_cloud_format.py::[1mTestGoogleCloudFormatPropagator::test_headers_match[0m - NameError: name 'header' is not defined
[31m====================================================================== [31m[1m1 failed[0m[31m in 0.07s[0m[31m =======================================================================[0m
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# sed -i 's/if header is None:/header = headers.get(_TRACE_CONTEXT_HEADER_NAME)\n        if header is None:/' opencensus/trace/propagation/google_cloud_format.py
[?2004l[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# pytest tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match -v
[?2004l[1m===================================================================== test session starts ======================================================================[0m
platform linux -- Python 3.10.19, pytest-9.0.2, pluggy-1.6.0 -- /usr/local/bin/python3.10
cachedir: .pytest_cache
rootdir: /workspace/repo
plugins: mock-3.15.1, timeout-2.4.0
[1mcollecting ... [0m[1mcollected 1 item                                                                                                                                               [0m

tests/unit/trace/propagation/test_google_cloud_format.py::TestGoogleCloudFormatPropagator::test_headers_match [32mPASSED[0m[32m                                     [100%][0m

[32m====================================================================== [32m[1m1 passed[0m[32m in 0.03s[0m[32m =======================================================================[0m
[?2004hroot@223b2bcf-7c92-4400-98e6-d838470cf244:/workspace/repo# 