[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo# asciinema rec --stdin /logs/agent/recording.cast
[?2004l[0;32masciinema: recording asciicast to /logs/agent/recording.cast[0m
[0;32masciinema: press <ctrl-d> or type "exit" when you're done[0m
[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo# clear
[?2004l[H[J[3J[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo# cd hardeneks/namespace_based/reliability/
[?2004l[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo/hardeneks/namespace_based/reliability# vi applications.py
[?2004lbash: vi: command not found
[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo/hardeneks/namespace_based/reliability# nano applications.py
[?2004lbash: nano: command not found
[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo/hardeneks/namespace_based/reliability# cat applications.py
[?2004lfrom ...resources import NamespacedResources
from hardeneks.rules import Rule, Result

class avoid_running_singleton_pods(Rule):
    _type = 'namespace_based'
    pillar = 'reliability'
    section = 'applications'
    message = 'Avoid running pods without deployments.'
    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#avoid-running-singleton-pods'

    def check(self, namespaced_resources: NamespacedResources):
        offenders = []
        for pod in namespaced_resources.pods:
            owner = pod.metadata.owner_references
            if not owner:
                offenders.append(pod)
        self.result = Result(status=True, resource_type='Pod', namespace=namespaced_resources.namespace)
        if offenders:
            self.result = Result(status=False, resource_type='Pod', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)

class run_multiple_replicas(Rule):
    _type = 'namespace_based'
    pillar = 'reliability'
    section = 'applications'
    message = 'Avoid running single replica deployments.'
    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#run-multiple-replicas'

    def check(self, namespaced_resources: NamespacedResources):
        offenders = []
        for deployment in namespaced_resources.deployments:
            if deployment.spec.replicas < 2:
                offenders.append(deployment)
        self.result = Result(status=True, resource_type='Deployment', namespace=namespaced_resources.namespace)
        if offenders:
            self.result = Result(status=False, resource_type='Deployment', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)

class schedule_replicas_across_nodes(Rule):
    _type = 'namespace_based'
    pillar = 'reliability'
    section = 'applications'
    message = 'Spread replicas across AZs and Nodes.'
    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#schedule-replicas-across-nodes'

    def check(self, namespaced_resources: NamespacedResources):
        """
        TODO: Implement this function
        """
        ...

class check_horizontal_pod_autoscaling_exists(Rule):
    _type = 'namespace_based'
    pillar = 'reliability'
    section = 'applications'
    message = 'Deploy horizontal pod autoscaler for deployments.'
    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#horizontal-pod-autoscaler-hpa'

    def check(self, namespaced_resources: NamespacedResources):
        offenders = []
        hpas = [i.spec.scale_target_ref.name for i in namespaced_resources.hpas]
        for deployment in namespaced_resources.deployments:
            if deployment.metadata.name not in hpas:
                offenders.append(deployment)
        self.result = Result(status=True, resource_type='Deployment', namespace=namespaced_resources.namespace)
        if offenders:
            self.result = Result(status=False, resource_type='Deployment', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)

class check_readiness_probes(Rule):
    _type = 'namespace_based'
    pillar = 'reliability'
    section = 'applications'
    message = 'Define readiness probes for pods.'
    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#use-readiness-probe-to-detect-partial-unavailability'

    def check(self, namespaced_resources: NamespacedResources):
        offenders = []
        for pod in namespaced_resources.pods:
            for container in pod.spec.containers:
                if not container.readiness_probe:
                    offenders.append(pod)
        self.result = Result(status=True, resource_type='Pod', namespace=namespaced_resources.namespace)
        if offenders:
            self.result = Result(status=False, resource_type='Pod', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)

class check_liveness_probes(Rule):
    _type = 'namespace_based'
    pillar = 'reliability'
    section = 'applications'
    message = 'Define liveness probes for pods.'
    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#use-liveness-probe-to-remove-unhealthy-pods'

    def check(self, namespaced_resources: NamespacedResources):
        offenders = []
        for pod in namespaced_resources.pods:
            for container in pod.spec.containers:
                if not container.liveness_probe:
                    offenders.append(pod)
        self.result = Result(status=True, resource_type='Pod', namespace=namespaced_resources.namespace)
        if offenders:
            self.result = Result(status=False, resource_type='Pod', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo/hardeneks/namespace_based/reliability# echo "from...resources import NamespacedResources\nfrom hardeneks.rules import Rule, Result\n\nclass avoid_running_singleton_pods(Rule):\n    _type = 'namespace_based'\n    pillar ='reliability'\n    section = 'applications'\n    message = 'Avoid running pods without deployments.'\n    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#avoid-running-singleton-pods'\n\n    def check(self, namespaced_resources: NamespacedResources):\n        offenders = []\n        for pod in namespaced_resources.pods:\n            owner = pod.metadata.owner_references\n            if not owner:\n                offenders.append(pod)\n        self.result = Result(status=True, resource_type='Pod', namespace=namespaced_resources.namespace)\n        if offenders:\n            self.result = Result(status=False, resource_type='Pod', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)\n\nclass run_multiple_replicas(Rule):\n    _type = 'namespace_based'\n    pillar ='reliability'\n    section = 'applications'\n    message = 'Avoid running single replica deployments.'\n    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#run-multiple-replicas'\n\n    def check(self, namespaced_resources: NamespacedResources):\n        offenders = []\n        for deployment in namespaced_resources.deployments:\n            if deployment.spec.replicas < 2:\n                offenders.append(deployment)\n        self.result = Result(status=True, resource_type='Deployment', namespace=namespaced_resources.namespace)\n        if offenders:\n            self.result = Result(status=False, resource_type='Deployment', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)\n\nclass schedule_replicas_across_nodes(Rule):\n    _type = 'namespace_based'\n    pillar ='reliability'\n    section = 'applications'\n    message = 'Spread replicas across AZs and Nodes.'\n    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#schedule-replicas-across-nodes'\n\n    def check(self, namespaced_resources: NamespacedResources):\n        offenders = []\n        for deployment in namespaced_resources.deployments:\n            if not deployment.spec.template.spec.affinity or not deployment.spec.template.spec.topology_spread_constraints:\n                offenders.append(deployment)\n        self.result = Result(status=True, resource_type='Deployment', namespace=namespaced_resources.namespace)\n        if offenders:\n            self.result = Result(status=False, resource_type='Deployment', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)\n\nclass check_horizontal_pod_autoscaling_exists(Rule):\n    _type = 'namespace_based'\n    pillar ='reliability'\n    section = 'applications'\n    message = 'Deploy horizontal pod autoscaler for deployments.'\n    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#horizontal-pod-autoscaler-hpa'\n\n    def check(self, namespaced_resources: NamespacedResources):\n        offenders = []\n        hpas = [i.spec.scale_target_ref.name for i in namespaced_resources.hpas]\n        for deployment in namespaced_resources.deployments:\n            if deployment.metadata.name not in hpas:\n                offenders.append(deployment)\n        self.result = Result(status=True, resource_type='Deployment', namespace=namespaced_resources.namespace)\n        if offenders:\n            self.result = Result(status=False, resource_type='Deployment', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)\n\nclass check_readiness_probes(Rule):\n    _type = 'namespace_based'\n    pillar ='reliability'\n    section = 'applications'\n    message = 'Define readiness probes for pods.'\n    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#use-readiness-probe-to-detect-partial-unavailability'\n\n    def check(self, namespaced_resources: NamespacedResources):\n        offenders = []\n        for pod in namespaced_resources.pods:\n            for container in pod.spec.containers:\n                if not container.readiness_probe:\n                    offenders.append(pod)\n        self.result = Result(status=True, resource_type='Pod', namespace=namespaced_resources.namespace)\n        if offenders:\n            self.result = Result(status=False, resource_type='Pod', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)\n\nclass check_liveness_probes(Rule):\n    _type = 'namespace_based'\n    pillar ='reliability'\n    section = 'applications'\n    message = 'Define liveness probes for pods.'\n    url = 'https://aws.github.io/aws-eks-best-practices/reliability/docs/application/#use-liveness-probe-to-remove-unhealthy-pods'\n\n    def check(self, namespaced_resources: NamespacedResources):\n        offenders = []\n        for pod in namespaced_resources.pods:\n            for container in pod.spec.containers:\n                if not container.liveness_probe:\n                    offenders.append(pod)\n        self.result = Result(status=True, resource_type='Pod', namespace=namespaced_resources.namespace)\n        if offenders:\n            self.result = Result(status=False, resource_type='Pod', resources=[i.metadata.name for i in offenders], namespace=namespaced_resources.namespace)" > applications.py\ncd /workspace/repo\npytest tests/test_reliability_applications.py::test_schedule_replicas_across_nodes -v\npytest tests/test_reliability_applications.py::test_schedule_replicas_across_nodes -v
[?2004l[?2004hroot@76218711-ea79-41ae-8fd9-e6939733f603:/workspace/repo/hardeneks/namespace_based/reliability# 