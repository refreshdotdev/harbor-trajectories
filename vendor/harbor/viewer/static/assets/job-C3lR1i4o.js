import{x as Re,B as Ie,v as Le,b as l,t as e,A as Ve}from"./index-CYR-HZan.js";import{d as ee,u as O,B as qe,a as $e,b as se,q as ze,r as Ue,e as Je,f as U,g as Qe,t as Ge,L as He,v as We,w as Xe,x as Ze,y as Ye}from"./api-BgrBwReI.js";import{u as le,t as y,l as es}from"./index-JVv6katd.js";import{u as oe,X as ss,E as as,a as rs,b as ts,c as ns,d as ls}from"./empty-TlmgxYvO.js";import{u as j,a as v,p as F,T as os,I as ie,S as is,C as P}from"./input-BPzPo60M.js";import{T as cs,a as ds,b as us}from"./tooltip-CILBUYcN.js";import{C as ms,B as hs}from"./code-block-CUSGUC3x.js";import{u as xs,a as ps,D as gs,P as js,b as vs,d as h,e as bs,f as M,g as ae,h as fs,S as c,C as ys}from"./hooks-CJW8H_7B.js";import{T as Ns,a as Cs,b as re,c as te,F as _s,D as ks,d as Ss,e as Ts,f as ws,g as Ds,h as Fs,L as q,S as Ps,i as Ms,j as Es,k as Ks,l as $}from"./tabs-DnzvJY73.js";import{K as _}from"./kbd-CNHFVw7L.js";import"./mutation--h5hHClj.js";import"./index-DvJT0nJi.js";import"./compare-Br3z3FUS-D09VrqaM.js";import"./scroll-area-Bnf4hdko.js";function As({value:s}){const a=async()=>{await navigator.clipboard.writeText(s),y("Copied to clipboard",{description:s})};return e.jsx("span",{onClick:a,className:"cursor-default hover:text-foreground transition-colors",children:s})}function Bs({jobName:s}){const a=le(),[t,i]=l.useState(!1),[x,b]=l.useState("haiku"),[n,d]=l.useState(32),[N,E]=l.useState(!0),u=oe({mutationFn:()=>Ge(s,x,n,N),onSuccess:o=>{a.invalidateQueries({queryKey:["job-summary",s]}),i(!1),o.n_trials_summarized>0&&o.job_summary_created?y.success(`Summarized ${o.n_trials_summarized} trial${o.n_trials_summarized===1?"":"s"}`):o.job_summary_created?y.success("Job summary updated"):y.info("No trials to summarize")},onError:o=>{y.error("Failed to generate summary",{description:o.message})}});return e.jsxs(ks,{open:t,onOpenChange:i,children:[e.jsx(Ss,{asChild:!0,children:e.jsx(U,{children:"Generate Summary"})}),e.jsxs(Ts,{children:[e.jsxs(ws,{children:[e.jsx(Ds,{children:"Generate Summary"}),e.jsx(Fs,{children:"Use Claude to analyze all failing trials and generate a summary. This can take a couple minutes."})]}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"model",children:"Model"}),e.jsxs(Ps,{value:x,onValueChange:b,children:[e.jsx(Ms,{id:"model",children:e.jsx(Es,{})}),e.jsxs(Ks,{children:[e.jsx($,{value:"haiku",children:"Haiku (Recommended)"}),e.jsx($,{value:"sonnet",children:"Sonnet"}),e.jsx($,{value:"opus",children:"Opus"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(q,{htmlFor:"n-concurrent",children:"Concurrent Claude Codes"}),e.jsx(ie,{id:"n-concurrent",type:"number",min:1,max:100,value:n,onChange:o=>d(parseInt(o.target.value)||1)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ys,{id:"only-failed",checked:N,onCheckedChange:o=>E(o===!0)}),e.jsx(q,{htmlFor:"only-failed",className:"font-normal",children:"Only analyze failed trials"})]}),e.jsx(U,{className:"w-full",onClick:()=>u.mutate(),disabled:u.isPending,children:u.isPending?e.jsx(He,{text:"Generating"}):"Generate"})]})]})]})}function Os(s){const a=Math.floor(s/1e3),t=Math.floor(a/60),i=Math.floor(t/60);return i>0?`${i}h ${t%60}m`:t>0?`${t}m ${a%60}s`:`${a}s`}function ce({reward:s}){const a=Math.max(0,Math.min(1,s)),t=Math.round(a*100);return e.jsx(hs,{variant:"outline",className:"tabular-nums border-transparent rounded-none",style:{backgroundColor:`color-mix(in oklab, var(--foreground) ${t}%, transparent)`,color:a>.5?"var(--background)":void 0},children:s.toFixed(2)})}function ne(s,a){const t=s.source||"_",i=s.agent_name||"_",x=s.model_provider||"_",b=s.model_name||"_";return`/jobs/${encodeURIComponent(a)}/tasks/${encodeURIComponent(t)}/${encodeURIComponent(i)}/${encodeURIComponent(x)}/${encodeURIComponent(b)}/${encodeURIComponent(s.task_name)}`}const Rs=[{accessorKey:"task_name",header:({column:s})=>e.jsx(c,{column:s,children:"Task"})},{accessorKey:"agent_name",header:({column:s})=>e.jsx(c,{column:s,children:"Agent"}),cell:({row:s})=>s.original.agent_name||"-"},{accessorKey:"model_provider",header:({column:s})=>e.jsx(c,{column:s,children:"Provider"}),cell:({row:s})=>s.original.model_provider||"-"},{accessorKey:"model_name",header:({column:s})=>e.jsx(c,{column:s,children:"Model"}),cell:({row:s})=>s.original.model_name||"-"},{accessorKey:"source",header:({column:s})=>e.jsx(c,{column:s,children:"Dataset"}),cell:({row:s})=>s.original.source||"-"},{accessorKey:"n_trials",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Trials"})}),cell:({row:s})=>{const{n_trials:a,n_completed:t}=s.original;return t<a?e.jsxs("div",{className:"text-right",children:[t,"/",a]}):e.jsx("div",{className:"text-right",children:a})}},{accessorKey:"n_errors",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Errors"})}),cell:({row:s})=>{const a=s.original.n_errors;return e.jsx("div",{className:"text-right",children:a})}},{accessorKey:"avg_duration_ms",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Avg Duration"})}),cell:({row:s})=>{const a=s.original.avg_duration_ms;return a===null?e.jsx("div",{className:"text-right text-muted-foreground",children:"-"}):e.jsx("div",{className:"text-right",children:Os(a)})}},{accessorKey:"exception_types",header:({column:s})=>e.jsx(c,{column:s,children:"Exceptions"}),sortingFn:(s,a)=>{const t=s.original.exception_types[0]??"",i=a.original.exception_types[0]??"";return t.localeCompare(i)},cell:({row:s})=>{const a=s.original.exception_types;return a.length===0?e.jsx("span",{className:"text-muted-foreground",children:"-"}):a.length===1?e.jsx("span",{className:"text-sm",children:a[0]}):e.jsxs("span",{className:"text-sm",children:[a[0]," ",e.jsxs("span",{className:"text-muted-foreground",children:["+",a.length-1," more"]})]})}},{accessorKey:"avg_reward",header:({column:s})=>e.jsx("div",{className:"text-right",children:e.jsx(c,{column:s,children:"Avg Reward"})}),cell:({row:s})=>{const a=s.original.avg_reward;return a===null?e.jsx("div",{className:"text-right text-muted-foreground",children:"-"}):e.jsx("div",{className:"text-right",children:e.jsx(ce,{reward:a})})}}],z=100,Ys=Re(function(){const{jobName:a}=Ie(),t=Le(),i=le(),[x,b]=l.useState(!1),[n,d]=l.useState(1),[N,E]=j("q",v.withDefault("")),[u,o]=j("agent",F(v).withDefault([])),[k,de]=j("provider",F(v).withDefault([])),[S,ue]=j("model",F(v).withDefault([])),[T,me]=j("task",F(v).withDefault([])),[K,he]=j("hide",F(v).withDefault([])),[w,J]=j("sort_by",v),[A,Q]=j("sort_order",v.withDefault("asc")),G=l.useRef(null),xe=w?[{id:w,desc:A==="desc"}]:[],pe=r=>{r.length===0?(J(null),Q(null)):(J(r[0].id),Q(r[0].desc?"desc":"asc"))},B=l.useMemo(()=>[{value:"task_name",label:"Task"},{value:"agent_name",label:"Agent"},{value:"model_provider",label:"Provider"},{value:"model_name",label:"Model"},{value:"source",label:"Dataset"},{value:"n_trials",label:"Trials"},{value:"n_errors",label:"Errors"},{value:"avg_duration_ms",label:"Avg Duration"},{value:"exception_types",label:"Exceptions"},{value:"avg_reward",label:"Avg Reward"}],[]),ge=l.useMemo(()=>{const r={};for(const f of K)r[f]=!1;return r},[K]),je=l.useMemo(()=>B.filter(r=>!K.includes(r.value)).map(r=>r.value),[B,K]),ve=r=>{const f=B.filter(C=>!r.includes(C.value)).map(C=>C.value);he(f.length>0?f:null)};ee("mod+k",r=>{r.preventDefault(),G.current?.focus()},{enableOnFormTags:!0});const R=xs(N,300);l.useEffect(()=>{d(1)},[R,u,k,S,T,w,A]);const{data:m,isLoading:be}=O({queryKey:["job",a],queryFn:()=>We(a),enabled:!!a}),{data:p}=O({queryKey:["task-filters",a],queryFn:()=>Xe(a),enabled:!!a,staleTime:6e4}),fe=l.useMemo(()=>(p?.agents??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.agents]),ye=l.useMemo(()=>(p?.providers??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.providers]),Ne=l.useMemo(()=>(p?.models??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.models]),Ce=l.useMemo(()=>(p?.tasks??[]).map(r=>({value:r.value,label:r.value,count:r.count})),[p?.tasks]),{data:I,isLoading:_e}=O({queryKey:["tasks",a,n,R,u,k,S,T,w,A],queryFn:()=>Ze(a,n,z,{search:R||void 0,agents:u.length>0?u:void 0,providers:k.length>0?k:void 0,models:S.length>0?S:void 0,tasks:T.length>0?T:void 0,sortBy:w||void 0,sortOrder:A}),enabled:!!a,placeholderData:es}),H=I?.items??[],g=I?.total_pages??0,W=I?.total??0,[L,ke]=l.useState("results");ee("escape",()=>t("/"),{enabled:L!=="results"});const{highlightedIndex:Se}=ps({rows:H,onNavigate:r=>t(ne(r,a)),onEscapeUnhighlighted:()=>t("/"),enabled:L==="results"}),{data:X}=O({queryKey:["job-summary",a],queryFn:()=>Ye(a),enabled:!!a}),Z=oe({mutationFn:()=>Qe(a),onSuccess:()=>{i.invalidateQueries({queryKey:["jobs"]}),y("Job deleted",{description:a}),t("/")},onError:r=>{y.error("Failed to delete job",{description:r.message}),b(!1)}}),Te=()=>{x?Z.mutate():b(!0)};if(!be&&!m)return e.jsx("div",{className:"container mx-auto py-10",children:e.jsx("div",{className:"text-destructive",children:"Failed to load job"})});const we=m?.stats.n_trials??0,De=m?.n_total_trials??0,Fe=m?.stats.n_errors??0,Pe=m?.stats.evals??{},Y=Object.entries(Pe);return e.jsxs("div",{className:"container mx-auto py-10",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx(qe,{className:"mb-4",children:e.jsxs($e,{children:[e.jsx(se,{children:e.jsx(ze,{asChild:!0,children:e.jsx(Ve,{to:"/",children:"Jobs"})})}),e.jsx(Ue,{}),e.jsx(se,{children:e.jsx(Je,{children:a})})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-4xl font-medium",children:a}),e.jsxs(U,{variant:x?"destructive":"secondary",onClick:Te,onBlur:()=>b(!1),disabled:Z.isPending,children:[e.jsx(os,{className:"h-4 w-4"}),x?"Confirm delete":"Delete"]})]}),e.jsxs("div",{className:"flex gap-2 text-sm text-muted-foreground mt-2",children:[e.jsxs("span",{children:[we,"/",De," trials completed"]}),e.jsx("span",{className:"text-border",children:"|"}),e.jsxs("span",{children:[Fe," errors"]})]}),Y.length>0&&e.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-1 mt-2",children:Y.map(([r,f])=>{const C=f.metrics[0];if(!C)return null;const[Me,D]=Object.entries(C)[0];typeof D=="number"?D.toFixed(2):String(D);const Ee=r.split("__").join(", ");return e.jsxs(cs,{children:[e.jsx(ds,{asChild:!0,children:e.jsxs("span",{className:"text-sm text-muted-foreground cursor-default",children:[e.jsx(ce,{reward:typeof D=="number"?D:0})," ",Me," ",e.jsxs("span",{className:"text-xs",children:["(",Ee,")"]})]})}),e.jsx(us,{children:e.jsx("ul",{className:"space-y-0.5",children:f.metrics.map((Ke,Ae)=>{const[Be,V]=Object.entries(Ke)[0],Oe=typeof V=="number"?V.toFixed(2):V;return e.jsxs("li",{children:[Be,"=",Oe]},Ae)})})})]},r)})}),m?.job_uri&&e.jsx("div",{className:"text-xs text-muted-foreground mt-3",children:e.jsx(As,{value:m.job_uri.startsWith("file://")?m.job_uri.slice(7):m.job_uri})})]}),e.jsxs(Ns,{value:L,onValueChange:ke,className:"mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between bg-card border border-b-0",children:[e.jsxs(Cs,{className:"border-0",children:[e.jsx(re,{value:"results",children:"Results"}),e.jsx(re,{value:"summary",children:"Summary"})]}),e.jsxs("div",{className:"flex items-center gap-3 px-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(_,{children:"j"}),e.jsx(_,{children:"k"}),e.jsx("span",{children:"to navigate"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(_,{children:"Enter"}),e.jsx("span",{children:"to open"})]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(_,{children:"Esc"}),e.jsx("span",{children:"to deselect"})]})]})]}),e.jsxs(te,{value:"results",children:[e.jsxs("div",{className:"grid grid-cols-7 -mb-px",children:[e.jsxs("div",{className:"col-span-2 relative",children:[e.jsx(ie,{ref:G,placeholder:"Search for tasks...",value:N,onChange:r=>E(r.target.value||null),size:"lg",variant:"card",className:"peer pl-9 pr-16 shadow-none"}),e.jsx(is,{className:"pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-border transition-colors peer-focus-visible:text-ring"}),N?e.jsx("button",{type:"button",onClick:()=>E(null),className:"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors",children:e.jsx(ss,{className:"h-4 w-4"})}):e.jsxs("div",{className:"pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-0.5",children:[e.jsx(_,{children:"âŒ˜"}),e.jsx(_,{children:"K"})]})]}),e.jsx(P,{options:fe,value:u,onValueChange:o,placeholder:"All agents",searchPlaceholder:"Search agents...",emptyText:"No agents found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(P,{options:ye,value:k,onValueChange:de,placeholder:"All providers",searchPlaceholder:"Search providers...",emptyText:"No providers found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(P,{options:Ne,value:S,onValueChange:ue,placeholder:"All models",searchPlaceholder:"Search models...",emptyText:"No models found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(P,{options:Ce,value:T,onValueChange:me,placeholder:"All tasks",searchPlaceholder:"Search tasks...",emptyText:"No tasks found.",variant:"card",className:"w-full border-l-0 shadow-none"}),e.jsx(P,{options:B,value:je,onValueChange:ve,placeholder:"Columns",searchPlaceholder:"Search columns...",emptyText:"No columns.",variant:"card",className:"w-full border-l-0 shadow-none",multiSelectLabel:"columns"})]}),e.jsx(gs,{columns:Rs,data:H,onRowClick:r=>t(ne(r,a)),isLoading:_e,className:"border-t-0",highlightedIndex:Se,columnVisibility:ge,sorting:xe,onSortingChange:pe,manualSorting:!0}),g>1&&e.jsxs("div",{className:"grid grid-cols-3 items-center mt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Showing ",(n-1)*z+1,"-",Math.min(n*z,W)," of ",W," tasks"]}),e.jsx(js,{children:e.jsxs(vs,{children:[e.jsx(h,{children:e.jsx(bs,{onClick:()=>d(r=>Math.max(1,r-1)),className:n===1?"pointer-events-none opacity-50":"cursor-pointer"})}),n>2&&e.jsx(h,{children:e.jsx(M,{onClick:()=>d(1),className:"cursor-pointer",children:"1"})}),n>3&&e.jsx(h,{children:e.jsx(ae,{})}),n>1&&e.jsx(h,{children:e.jsx(M,{onClick:()=>d(n-1),className:"cursor-pointer",children:n-1})}),e.jsx(h,{children:e.jsx(M,{isActive:!0,children:n})}),n<g&&e.jsx(h,{children:e.jsx(M,{onClick:()=>d(n+1),className:"cursor-pointer",children:n+1})}),n<g-2&&e.jsx(h,{children:e.jsx(ae,{})}),n<g-1&&e.jsx(h,{children:e.jsx(M,{onClick:()=>d(g),className:"cursor-pointer",children:g})}),e.jsx(h,{children:e.jsx(fs,{onClick:()=>d(r=>Math.min(g,r+1)),className:n===g?"pointer-events-none opacity-50":"cursor-pointer"})})]})}),e.jsx("div",{})]})]}),e.jsx(te,{value:"summary",children:X?.summary?e.jsx(ms,{code:X.summary,lang:"markdown",wrap:!0}):e.jsxs(as,{className:"bg-card border",children:[e.jsxs(rs,{children:[e.jsx(ts,{variant:"icon",children:e.jsx(_s,{})}),e.jsx(ns,{children:"No summary"}),e.jsx(ls,{children:"Generate a summary of all trials in this job using Claude."})]}),e.jsx(Bs,{jobName:a})]})})]})]})});export{Ys as default};
